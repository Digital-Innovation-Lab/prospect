/*! prospect 2018-10-23 */
function PViewFrame(a,b){this.vfIndex=a,this.callbacks=b,this.vizSel=[],this.selAbsIs=[],this.curSelSize=0,this.inspRec=null,this.selNever=!0}function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()}var volURL,tour,tourTxt,tourTOC,widgetData={ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1};PViewFrame.prototype.getFrameID=function(){return"#view-frame-"+this.vfIndex},PViewFrame.prototype.upSel=function(a,b){var c=a.length;if(b||this.curSelSize>0||c>0){var d=jQuery(this.getFrameID()+" div.view-controls"),e=jQuery(this.getFrameID()+" div.sellist > div.sellist-scroll"),f=c+" "+dlText.selected;d.find(".btn-num-sel").text(f),e.empty(),c>0?(d.find(".osel").button("enable"),d.find(".osel").addClass("pulse"),d.find(".xsel").button("enable"),a.forEach(function(a){var b=PData.rByN(a);e.append('<div class="sellist-rec" data-id="'+b.id+'">'+b.l+"</div>")}),this.selNever&&(jQuery(this.getFrameID()+" div.sellist").show(),this.selNever=!1)):(d.find(".osel").button("disable"),d.find(".osel").removeClass("pulse"),d.find(".xsel").button("disable"))}this.curSelSize=c},PViewFrame.prototype.openSelection=function(){function a(a){return a.replace(/^[ \f\t\v​]+|[ \f\t\v​]+$/g,"")}function b(a){var b=new Number,c=v.exec(a);if(null===c)throw new Error("Error in transcript file: Cannot parse "+a+" as timecode.");return b=1e3*(3600*parseInt(c[1])+60*parseInt(c[2])+parseFloat(c[3])),b+=1==c[4].length?100*parseInt(c[4]):10*parseInt(c[4])}function c(b,c){var d=new String(b);d=a(d).split(/\r\n|\r|\n/g);var e=[];if(d){var f,g=0;_.each(d,function(b){b=a(b),b.length>0&&("["===b.charAt(0)?(g>0&&e.push(f),f=""):(f.length>0&&(f+="<br/>"),f+=b),g++)})}_.each(e,function(a,b){c.find('div.timecode[data-tcindex="'+b+'"]').next().after('<div class="xscript">'+a+"</div>")})}function d(d){widgetData.tcArray=[],widgetData.tcIndex=-1;var e=widgetData.tcArray,f=new String(d);if(f=a(f).split(/\r\n|\r|\n/g)){var g,h=jQuery("#xscript-tbl"),i=0,j=0,k=0,l="";_.each(f,function(c){c=a(c),c.length>1&&("["===c.charAt(0)&&c.charAt(1)>="0"&&c.charAt(1)<="9"?(g=b(c),l.length>0&&(k&&e.push({s:j,e:g}),h.append('<div class="row"><div class="timecode" data-timecode="'+j+'" data-tcindex="'+i++ +'">'+k+'</div><div class="xscript">'+l+"</div></div>"),l=""),k=c,j=g):(l.length>0&&(l+="<br/>"),l+=c))}),l.length>0&&(e.push({s:j,e:324e5}),h.append('<div class="row"><div class="timecode" data-timecode="'+j+'" data-tcindex="'+i+'">'+k+'</div><div class="xscript">'+l+"</div></div>")),"undefined"!=typeof o&&null!=o&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:o,excerpt:widgetData.extract},success:function(a,b,d){c(JSON.parse(a),h)},error:function(a,b,c){alert(c)}})}}function e(a){var b,c=widgetData.tcIndex;_.find(widgetData.tcArray,function(d,e){if(b=d.s<=a&&a<d.e,b&&e!=c){var f=jQuery("#xscript-tbl");if(document.getElementById("sync-xscript").checked){var g=f.find('[data-tcindex="'+e+'"]'),h=g.offset().top-f.offset().top,i=f.scrollTop()+h;f.animate({scrollTop:i},300)}c!=-1&&f.find('[data-tcindex="'+c+'"]').removeClass("current"),f.find('[data-tcindex="'+e+'"]').addClass("current"),widgetData.tcIndex=e}return b})}function f(){function a(a){var b;switch(a.data){case 1:widgetData.playing=!0,null==widgetData.timer&&(widgetData.timer=setInterval(function(){b=1e3*widgetData.widget.getCurrentTime(),widgetData.playing&&widgetData.xscriptOn&&e(b)},300));break;case 0:case 2:widgetData.playing=!1,window.clearInterval(widgetData.timer),widgetData.timer=null;break;case 3:case 5:widgetData.playing=!1}}widgetData.widget=new YT.Player("yt-widget",{width:t-40,height:Math.floor(9*(t-40)/16),videoId:widgetData.ytCode,events:{onError:function(a){console.log("YouTube Error: "+a.data)},onStateChange:a,onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1e3,endSeconds:widgetData.eTime/1e3})}}})}function g(){widgetData.playing=!0}function h(){widgetData.playing=!1}function i(){widgetData.playing&&widgetData.xscriptOn&&e(1e3*widgetData.widget.currentTime)}function j(){switch(s){case 3:null!=widgetData.widget&&(widgetData.widget.removeEventListener("ended",h),widgetData.widget.removeEventListener("pause",h),widgetData.widget.removeEventListener("playing",g),widgetData.widget.removeEventListener("timeupdate",i));case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause(),widgetData.playing=!1,widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),widgetData.timer=null)}}function k(){function a(){widgetData.sTime=widgetData.eTime=null;var a;if(a=prspdata.e.i.t.tcAtts[j]){var c=y.a[a];if(c&&""!==c){widgetData.extract=c;var d=c.split("-");widgetData.sTime=b(d[0]),widgetData.eTime=b(d[1])}}}var c=w[z];y=PData.rByN(c);var j=PData.n2T(c);if(q.empty(),r=null,s=0,widgetData.extract=null,widgetData.xscriptOn=!1,widgetData.playing=!1,(prspdata.e.i.modal.scOn||"boolean"==typeof prspdata.e.i.modal.aOn&&prspdata.e.i.modal.aOn)&&(r=prspdata.e.i.sc.atts[j])){var k;if(k=y.a[r])if(a(),k.match(/soundcloud\.com/)){s=1,q.append('<iframe id="sc-widget" class="player" width="100%" height="110" src="//w.soundcloud.com/player/?url='+k+'"></iframe>');var l=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=l,l.bind(SC.Widget.Events.READY,function(){l.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=!0}),l.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=!1}),l.bind(SC.Widget.Events.PLAY_PROGRESS,function(a){widgetData.extract&&(a.currentPosition<widgetData.sTime?l.seekTo(widgetData.sTime):a.currentPosition>widgetData.eTime&&(l.pause(),widgetData.playing=!1)),widgetData.playing&&widgetData.xscriptOn&&e(a.currentPosition)}),l.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}else{if(s=3,widgetData.extract){var m=widgetData.extract.split("-");k+="#t="+m[0]+","+m[1]}q.append('<audio id="na-widget" controls src="'+k+'"></audio>'),widgetData.widget=document.getElementById("na-widget"),widgetData.widget.addEventListener("ended",h),widgetData.widget.addEventListener("pause",h),widgetData.widget.addEventListener("playing",g),widgetData.widget.addEventListener("timeupdate",i)}}if(0===s&&prspdata.e.i.modal.ytOn&&(r=prspdata.e.i.yt.atts[j])){var n=y.a[r];if(n){if(a(),widgetData.ytCode=n,q.append('<div id="yt-widget"></div>'),widgetData.ytCall=f,widgetData.ytLoaded)f();else{widgetData.ytLoaded=!0;var p=document.createElement("script");p.src="https://www.youtube.com/iframe_api";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(p,t)}s=2}}if(prspdata.e.i.modal.tOn){var u=prspdata.e.i.t.t1Atts[j];if(u&&""!==u&&"disable"!==u){var v=y.a[u];if("string"==typeof v&&""!==v){s>0&&q.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>"),q.find("#xscript-tbl").remove(),q.append('<div id="xscript-tbl"></div>'),widgetData.xscriptOn=!0,jQuery("#xscript-tbl").click(function(a){if(s&&jQuery(a.target).hasClass("timecode")){var b=jQuery(a.target).data("timecode");switch(s){case 1:widgetData.widget.seekTo(b),widgetData.playing||widgetData.widget.play();break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo()),widgetData.widget.seekTo(b/1e3);break;case 3:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play()),widgetData.widget.currentTime=b/1e3}}}),o=null;var x=prspdata.e.i.t.t2Atts[j];x&&""!==x&&"disable"!==x&&(o=y.a[x]),jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:v,excerpt:widgetData.extract},success:function(a,b,c){d(JSON.parse(a))},error:function(a,b,c){alert(c)}})}}}prspdata.e.i.modal.atts[j].forEach(function(a){var b=PData.rAV(c,a,!1);if(b){var d,e=PData.aByID(a);"_"==e.def.l.charAt(0)?d="<div>"+b+"</div>":(d='<div><span class="att-label">'+e.def.l+":</span> ","I"==e.def.t&&(d+="<br/>"),d+=b+"</div>"),q.append(d)}})}function l(a){var b=z+a;b==-1?b=w.length-1:b==w.length&&(b=0),b!=z&&(z=b,j(),k(),jQuery("#inspect-list").val(z))}function m(a){l(-1)}function n(a){l(1)}var o,p=this,q=jQuery("#inspect-content"),r=null,s=0,t=450,u=400,v=/(\d\d)\:(\d\d)\:(\d\d)\.(\d\d?)/,w=null;if(w=this.vizSel,null!=w&&0!==w.length){var x,y,z=0;prspdata.e.i.modal.scOn&&(t=550),prspdata.e.i.modal.ytOn&&(t=Math.max(t,475),u=500),prspdata.e.i.modal.tOn&&(u+=100,prspdata.e.i.modal.t2On?(t=Math.max(750,Math.floor(.8*jQuery(document).width())),t=Math.min(900,t)):t=Math.max(t,550)),"number"==typeof prspdata.e.i.modal.w&&(t=prspdata.e.i.modal.w),"number"==typeof prspdata.e.i.modal.h&&(u=prspdata.e.i.modal.h),jQuery("#btn-inspect-left").click(m),jQuery("#btn-inspect-right").click(n),jQuery("#inspect-list").change(function(){z=jQuery("#inspect-list").val(),z=parseInt(z),j(),k()});for(var A=0;A<w.length;A++){var B=PData.rByN(w[A]);jQuery("#inspect-list").append("<option value="+A+">"+B.l+"</option>"),this.inspRec&&B.id===this.inspRec&&(z=A,jQuery("#inspect-list").val(A))}this.inspRec=null,k();var C=[{text:dlText.findintext,click:function(){p.callbacks.textFrame.findRec(y.id)}}];"undefined"!=typeof prspdata.e.i.srOff&&prspdata.e.i.srOff||C.push({text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+y.wp,"_blank")}}),C.push({text:dlText.close,click:function(){x.dialog("close")}}),x=jQuery("#dialog-inspector").dialog({dialogClass:"no-close",width:t,height:u,modal:!0,buttons:C}),x.on("dialogclose",function(a,b){j(),jQuery("#btn-inspect-left").off("click"),jQuery("#btn-inspect-right").off("click"),jQuery("#inspect-list").off("change"),jQuery("#inspect-list").empty(),x.off("dialogclose")})}};var PVizFrame=function(a,b){this.autoUpdate=!1,this.lDirty=null,this.vizSelIndex=0,this.vizModel=null,this.legendIDs=[],this.datastream=null,this.vizStates=[];for(var c=0;c<prspdata.e.vf.length;c++)this.vizStates.push(null);PViewFrame.call(this,a,b)};PVizFrame.prototype=Object.create(PViewFrame.prototype),PVizFrame.prototype.constructor=PViewFrame,PVizFrame.prototype.getIndex=function(){return 1},PVizFrame.prototype.setLDirty=function(a){this.autoUpdate?(a&&this.vizModel&&this.datastream&&(this.vizModel.render(this.datastream),this.computeSel()),this.lDirty=!1):a!==this.lDirty&&(this.lDirty=a,jQuery("#view-frame-1 div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!a))},PVizFrame.prototype.selectChangeViz=function(){var a=jQuery("#view-frame-1 div.view-controls select.view-viz-select option:selected"),b=a.val();this.createViz(b,!0),this.computeSel()},PVizFrame.prototype.computeSel=function(){if(this.vizSel=[],null!=this.vizModel){if(0===this.selAbsIs.length)return this.vizModel.clearSel(),void this.upSel([],!1);var a=[];if("undefined"!=typeof this.vizModel.rMap&&null!=this.vizModel.rMap){var b=this.vizModel.rMap;this.selAbsIs.forEach(function(c){b[c>>4]&1<<(15&c)&&a.push(c)}),this.vizSel=a,0===a.length?this.vizModel.clearSel():this.vizModel.setSel(a),this.upSel(a,!1)}}},PVizFrame.prototype.initDOM=function(a){function b(a){m.vizModel.flags()&V_FLAG_LGND&&jQuery("#view-frame-1 div.lgnd-container").toggle(),a.preventDefault()}function c(a){m.vizModel&&m.vizModel.doOptions(),a.preventDefault()}function d(a){var b=jQuery("#dialog-vnotes").dialog({dialogClass:"no-close",width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]});a.preventDefault()}function e(a){jQuery("body").trigger("prsp-hilite",{v:1,t:m.vizModel.tUsed}),a.preventDefault()}function f(a,b){jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",b),m.setLDirty(!0)}function g(a,b,c){m.setLDirty(!0)}function h(a,b){jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate[data-id="'+b+'"] input.lgnd-entry-check').prop("checked",!0),m.setLDirty(!0)}function i(a,b,c){m.setLDirty(!0)}function j(a,b){jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value[data-index="'+b+'"] input.lgnd-entry-check').prop("checked",!0),m.setLDirty(!0)}function k(a){var b=jQuery(a.target).closest("div.lgnd-template").data("index"),c=a.target.className;switch(c){case"lgnd-update":m.vizModel&&m.datastream&&(m.vizModel.render(m.datastream),m.computeSel(),m.setLDirty(!1));break;case"lgnd-entry-check":var d=jQuery(a.target).closest("div.lgnd-entry"),e=jQuery(a.target).is(":checked");d.hasClass("lgnd-sh")?f(b,e):d.hasClass("lgnd-locate")?g(b,d.data("id"),e):d.hasClass("lgnd-value")&&i(b,d.data("index"),e);break;case"lgnd-viz":case"lgnd-value-title":var d=jQuery(a.target).closest("div.lgnd-entry");d.hasClass("lgnd-locate")?h(b,d.data("id")):d.hasClass("lgnd-value")&&j(b,d.data("index"));break;case"lgnd-template":case"lgnd-select":case"":break;default:if(c.match(/lgnd-sh/i)){var k=jQuery(a.target).find("input.lgnd-entry-check"),e=!k.is(":checked");k.prop("checked",e),f(b,e)}}}function l(a){var b=jQuery(a.target).closest("div.sellist-rec").data("id"),c=a.target.className;switch(c){case"sellist-rec":m.inspRec=b,m.openSelection()}a.preventDefault()}var m=this,n=jQuery("#view-frame-1"),o=prspdata.bClrs.vf;o&&o.length>0&&n.find("div.view-controls").css("background-color",o),n.find("div.lgnd-container").draggable({handle:n.find("div.lgnd-handle"),containment:"parent",stop:function(a,b){n.find("div.lgnd-container").css({height:"",bottom:""})}}),n.find("div.lgnd-container > div.lgnd-handle > button.close").button({icons:{primary:"ui-icon-closethick"},text:!1}).click(b),n.find("div.lgnd-container > div.lgnd-handle > button.minmax").button({icons:{primary:"ui-icon-arrowthick-2-n-s"},text:!1}).click(function(a){a.preventDefault(),n.find("div.lgnd-container > div.lgnd-scroll").toggle(),n.find("div.lgnd-container").toggleClass("min")});var p=n.find("div.view-controls select.view-viz-select");prspdata.e.vf.forEach(function(a,b){var c='<option value="'+b+'">'+a.l+"</option>";p.append(c)}),p.val(a),p.change(function(){m.selectChangeViz()}),n.find("div.view-controls button:first").button({icons:{primary:"ui-icon-battery-0"},text:!1}).click(b).next().button({icons:{primary:"ui-icon-battery-1"},text:!1}).click(c).next().button({icons:{primary:"ui-icon-info"},text:!1}).click(d).next().button({icons:{primary:"ui-icon-signal"},text:!1}).click(e).next().button({icons:{primary:"ui-icon-battery-3"},text:!1}).click(function(a){a.preventDefault(),m.openSelection()}),n.find("div.lgnd-container").click(k),n.find("div.sellist").draggable({handle:n.find("div.sellist > div.sellist-handle"),containment:"parent",stop:function(){n.find("div.sellist").css({height:"",bottom:""})}}),n.find("div.view-controls > span.btn-num-sel").click(function(a){a.preventDefault(),n.find("div.sellist").show()}),n.find("div.sellist > div.sellist-handle > button.close").button({icons:{primary:"ui-icon-closethick"},text:!1}).click(function(a){a.preventDefault(),n.find("div.sellist").hide()}),n.find("div.sellist > div.sellist-handle > button.minmax").button({icons:{primary:"ui-icon-arrowthick-2-n-s"},text:!1}).click(function(a){a.preventDefault(),n.find("div.sellist > div.sellist-scroll").toggle(),n.find("div.sellist").toggleClass("min")}),n.find("div.sellist > div.sellist-scroll").click(l),this.createViz(a,!1),jQuery("body").on("prsp-auto",function(a,b){m.autoUpdate=b.a,b.s&&(jQuery("#view-frame-1 div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!0),m.lDirty&&(m.vizModel&&m.datastream&&(m.vizModel.render(m.datastream),m.computeSel()),m.lDirty=!1))})},PVizFrame.prototype.setLegendFeatures=function(a,b){var c,d=jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group');d.empty(),this.legendIDs[a]=b;var e=PData.aByID(b);"undefined"!=typeof e.r.u&&(c='<div class="lgnd-value lgnd-entry" data-index="-1"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+e.r.u.v+'"> </div> <span class="lgnd-value-title">'+dlText.undef+"</span></div>",d.append(c)),e.l.forEach(function(a,b){c='<div class="lgnd-value lgnd-entry" data-index="'+b+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+a.v+'"> </div> <span class="lgnd-value-title">'+a.l+"</span></div>",d.append(c),a.z&&a.z.length>0&&a.z.forEach(function(a,e){c='<div class="lgnd-value lgnd-entry" data-index="'+b+","+e+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>',c+=a.v&&""!==a.v?'<div class="lgnd-viz" style="background-color: '+a.v+'"></div>':'<div class="lgnd-viz lgnd-viz-empty"></div>',c+=' <span class="lgnd-value-title">&raquo; '+a.l+"</span></div>",d.append(c)})}),jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-sh input').prop("checked",!0)},PVizFrame.prototype.createViz=function(a,b){function c(a){var b=jQuery(a.target).closest("div.lgnd-template").data("index"),c=jQuery(a.target).val();d.setLegendFeatures(b,c),d.setLDirty(!0)}var d=this,e=PData.vByN(a);this.vizModel&&(this.vizStates[this.vizSelIndex]=this.vizModel.getState(),this.vizModel.teardown(),this.vizModel=null);var f=jQuery("#view-frame-1");f.find("div.viz-content div.viz-result").empty();var g;switch(e.vf){case"M":g=new VizMap(this,e.c);break;case"p":g=new VizMap2(this,e.c);break;case"C":g=new VizCards(this,e.c);break;case"P":g=new VizPinboard(this,e.c);break;case"T":g=new VizTime(this,e.c);break;case"D":g=new VizDirectory(this,e.c);break;case"t":g=new VizTextStream(this,e.c);break;case"N":g=new VizNetWheel(this,e.c);break;case"n":g=new VizNetGraph(this,e.c);break;case"b":g=new VizBMatrix(this,e.c)}this.vizSelIndex=a;var h=g.flags();if(h&V_FLAG_HSCRL?(f.find("div.viz-content").addClass("h-scroll"),f.find("div.viz-result").addClass("viz-fit-w"),f.find("div.viz-result").removeClass("viz-max-w")):(f.find("div.viz-content").removeClass("h-scroll"),f.find("div.viz-result").removeClass("viz-fit-w"),f.find("div.viz-result").addClass("viz-max-w")),h&V_FLAG_VSCRL?(f.find("div.viz-content").addClass("v-scroll"),f.find("div.viz-result").addClass("viz-fit-h"),f.find("div.viz-result").removeClass("viz-max-h")):(f.find("div.viz-content").removeClass("v-scroll"),f.find("div.viz-result").removeClass("viz-fit-h"),f.find("div.viz-result").addClass("viz-max-h")),this.legendIDs=[],h&V_FLAG_LGND){f.find(".hslgnd").button("enable");var i=f.find("div.lgnd-container div.lgnd-scroll");if(i.empty(),h&V_FLAG_SLGND){var j=g.getFeatureAtts(),k=PData.aByID(j);i.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+k.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div></div>'),this.legendIDs.push(j),this.setLegendFeatures(0,j)}else{var l=!1;prspdata.e.g.ts.forEach(function(a,b){var e=PData.tByID(a),f=g.getLocAtts(b);if(f&&f.length>0||!(h&V_FLAG_LOC)){var j=g.getFeatureAtts(b);if(j.length>0){l&&i.append("<hr/>");var k=jQuery('<div class="lgnd-template" data-index="'+b+'"><div class="lgnd-title">'+e.l+"</div></div>");f&&f.forEach(function(a,b){var c=PData.aByID(a);k.append('<div class="lgnd-entry lgnd-locate" data-id="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+c.def.l+"</span></div>")});var m='<select class="lgnd-select">';j.forEach(function(a,b){var c=PData.aByID(a);m+='<option value="'+a+'">'+c.def.l+"</option>"}),m+="</select>";var n=jQuery(m);n.change(c),jQuery(k).append(n),jQuery(k).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div>'),i.append(k);var o=j[0];d.legendIDs.push(o),d.setLegendFeatures(b,o),l=!0}}})}f.find("div.lgnd-container").show()}else f.find("button.hslgnd").button("disable"),f.find("div.lgnd-container").hide();this.flushLgnd(),this.setLDirty(!1),f.find(".hilite").button("enable"),h&V_FLAG_OPT?f.find(".vopts").button("enable"):f.find(".vopts").button("disable");var m=g.hint();if(m||"string"==typeof e.n&&""!==e.n?(f.find(".vnote").button("enable"),m?m+="string"==typeof e.n&&""!==e.n?".<br/>"+e.n:".":m=e.n,jQuery("#vnotes-txt").empty().append(m)):f.find(".vnote").button("disable"),g.setup(),this.upSel([],!0),b){var n=this.vizStates[a];n&&g.setState(n),this.datastream&&g.render(this.datastream)}this.vizModel=g},PVizFrame.prototype.setViz=function(a,b){if(a!==this.vizSelIndex){var c=jQuery("#view-frame-1 div.view-controls select.view-viz-select");c.val(a),this.createViz(a,b)}},PVizFrame.prototype.getSelLocAtts=function(a){var b=[],c=jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input:checked');return c.each(function(){var a=jQuery(this).parent().data("id");b.push(a)}),b},PVizFrame.prototype.getSelFeatAtts=function(a){var b,c,d=[],e=jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value input:checked');return e.each(function(){b=jQuery(this).parent().data("index"),"number"==typeof b?d.push(b):(c=b.indexOf(","))!=-1?d.push([parseInt(b.substring(0,c),10),parseInt(b.substring(c+1),10)]):d.push(parseInt(b,10))}),d},PVizFrame.prototype.getSelLegend=function(a){return this.legendIDs[a]},PVizFrame.prototype.getLgndSels=function(){return this.legendIDs.slice(0)},PVizFrame.prototype.setLgndSels=function(a){var b=this;a.forEach(function(a,c){if(a){var d=jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] select.lgnd-select');d.val(a),b.setLegendFeatures(c,a)}})},PVizFrame.prototype.getState=function(){return this.vizModel?this.vizModel.getState():null},PVizFrame.prototype.setState=function(a){this.vizModel&&this.vizModel.setState(a)},PVizFrame.prototype.showStream=function(a){this.vizSel=[],this.selAbsIs=[],this.datastream=a,this.vizModel&&this.vizModel.render(a),this.setLDirty(!1)},PVizFrame.prototype.setStream=function(a){this.datastream=a},PVizFrame.prototype.clearSel=function(){this.upSel([],!1),this.vizModel&&this.vizModel.clearSel(),this.selAbsIs=[],this.vizSel=[]},PVizFrame.prototype.setSel=function(a){return this.selAbsIs=a.slice(0),this.vizModel&&this.computeSel(),!1},PVizFrame.prototype.addSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a),this.selAbsIs[b]!==a&&(this.selAbsIs.splice(b,0,a),this.computeSel())},PVizFrame.prototype.delSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a),this.selAbsIs.splice(b,1),this.computeSel()},PVizFrame.prototype.vizAddSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a),this.selAbsIs.splice(b,0,a),b=_.sortedIndex(this.vizSel,a),this.vizSel[b]!==a&&this.vizSel.splice(b,0,a),this.callbacks.addSel(1,a)},PVizFrame.prototype.vizDelSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a),this.selAbsIs.splice(b,1),b=_.sortedIndex(this.vizSel,a),this.vizSel[b]===a&&this.vizSel.splice(b,1),this.callbacks.delSel(1,a)},PVizFrame.prototype.resize=function(){this.vizModel&&this.vizModel.resize()},PVizFrame.prototype.title=function(){var a=PData.vByN(this.vizSelIndex);return a.l},PVizFrame.prototype.flushLgnd=function(){var a=jQuery("#view-frame-1"),b=a.width()-280;a.find("div.lgnd-container").css("left",b).css("top",100),a.find("div.sellist").css("left",b).css("top",30)},PVizFrame.prototype.getBMData=function(){return this.vizModel?{t:this.vizModel.tUsed,r:this.vizModel.rMap}:null};var PTextFrame=function(a,b){this.tocVis=!1,this.volData=[],this.tocRL=[],this.tocSel=[],this.tocSelDirty=!1,this.bm=[],this.txtIDs=[],this.svg,PViewFrame.call(this,a,b)};PTextFrame.prototype=Object.create(PViewFrame.prototype),PTextFrame.prototype.constructor=PViewFrame,PTextFrame.prototype.updateBookMark=function(){for(var a,b,c,d=0,e=0;e<this.tocSel.length;e++){a=this.tocSel[e],b=this.tocRL[e],c=this.bm[d++],c.sel=a.c,c.rl=b.c;for(var f=0;f<a.s.length;f++)c=this.bm[d++],c.sel=a.s[f],c.rl=b.s[f]}this.svg.selectAll(".bm").attr("class",function(a){return a.sel?"bm sel":"bm"}).attr("fill",function(a){return a.rl?"#0099FF":"#C0C0C0"})},PTextFrame.prototype.searchFunc=function(a,b){var c,d,e=this;if(this.volData.forEach(function(b,f){if(c=!1,a(b.e,!0))c=!0;else for(d=jQuery(b.e).next();0!=d.length;)switch(d.prop("tagName").toUpperCase()){case"H1":case"H2":d=[];break;default:a(d,!1)?(c=!0,d=[]):d=d.next()}e.tocRL[f].c=c,b.s.forEach(function(b,g){if(c=!1,a(b.e,!0))c=!0;else for(d=jQuery(b.e).next();0!=d.length;)switch(d.prop("tagName").toUpperCase()){case"H1":case"H2":d=[];break;default:a(d,!1)?(c=!0,d=[]):d=d.next()}e.tocRL[f].s[g]=c})}),this.updateTOCRL(),this.updateBookMark(),b)a:for(var f=0;f<this.tocRL.length;f++){var g=this.tocRL[f];if(g.c){this.setTOCSel(!0,f,-1);break}for(var h=0;h<g.s.length;h++)if(g.s[h]){this.setTOCSel(!0,f,h);break a}}},PTextFrame.prototype.findRec=function(a){function b(b,c){var d,e,f,g=!1;if(!c)for(d=jQuery(b).children("a"),e=0;e<d.length;e++)if(f=jQuery(d[e]).attr("href"),"#"===f.charAt(0)&&f.substr(1)==a){g=!0;break}return g}this.searchFunc(b,!1)},PTextFrame.prototype.updateTOCRL=function(){var a,b;a=jQuery("#toc-frame"),this.tocRL.forEach(function(c,d){b=a.find('ul.toc-wrapper > li.toc-chap[data-c="'+d+'"]'),b.find(".readlist-c").prop("checked",c.c),c.s.forEach(function(a,c){b.find('li[data-s="'+c+'"] > .readlist').prop("checked",a)})})},PTextFrame.prototype.updateTOCSel=function(){var a,b;a=jQuery("#toc-frame"),this.tocSel.forEach(function(c,d){b=a.find('ul.toc-wrapper > li.toc-chap[data-c="'+d+'"]'),b.toggleClass("sel",c.c),c.s.forEach(function(a,c){b.find('li[data-s="'+c+'"]').toggleClass("sel",a)})})},PTextFrame.prototype.setTOCSel=function(a,b,c){var d;if(a)for(var e=0;e<this.tocSel.length;e++){d=this.tocSel[e],d.c=!1;for(var f=0;f<d.s.length;f++)d.s[f]=!1}d=this.tocSel[b],c===-1?d.c=!0:d.s[c]=!0,this.updateTOCSel(),this.updateBookMark(),this.buildTextFrame()},PTextFrame.prototype.buildTextFrame=function(){var a,b,c,d=this,e=jQuery("#read-pane");e.empty(),this.tocSel.forEach(function(f,g){if(a=d.volData[g],f.c)for(e.append(jQuery(a.e).clone()),c=jQuery(a.e).next();0!=c.length;)switch(c.prop("tagName").toUpperCase()){case"H1":case"H2":c=[];break;default:e.append(c.clone()),c=c.next()}f.s.forEach(function(d,f){if(d)for(b=a.s[f],e.append(jQuery(b.e).clone()),c=jQuery(b.e).next();0!=c.length;)switch(c.prop("tagName").toUpperCase()){case"H1":case"H2":c=[];break;default:e.append(c.clone()),c=c.next()}})}),this.selAbsI=[],this.vizSel=[],this.txtIDs=[],this.upSel([],!0);var f,g,h=[];f=jQuery("#read-pane").find("a"),f.each(function(a){var b=jQuery(this).prop("href");if((g=b.indexOf("#"))!==-1)if(b=b.substr(g+1),jQuery(this).prop("href","#"),jQuery(this).attr("data-id",b),0===h.length)h.push(b);else{var c=_.sortedIndex(h,b);h[c]!==b&&h.splice(c,0,b)}else jQuery(this).addClass("no-data")}),this.txtIDs=h,this.callbacks.newText()},PTextFrame.prototype.initDOM=function(){function a(a){for(var b=a.target.checked,c=0;c<r.tocRL.length;c++){var d=r.tocRL[c];d.c=b;for(var e=0;e<d.s.length;e++)d.s[e]=b}r.updateTOCRL(),r.updateBookMark()}function b(a){r.tocSelDirty=!0;var b=a.target.checked;r.tocSel.forEach(function(a,c){var d=t.find('#toc-frame > ul.toc-wrapper > li.toc-chap[data-c="'+c+'"]');for(a.c=b,i=0;i<a.s.length;i++)a.s[i]=b;b?(d.addClass("sel"),d.find("ul.toc-secs > li").addClass("sel")):(d.removeClass("sel"),d.find("ul.toc-secs > li").removeClass("sel"))}),r.updateBookMark()}function c(a){r.tocVis=!r.tocVis,r.tocVis?(tour=tourTOC,r.tocSelDirty=!1,t.find("#toc-controls").show(),t.find("#toc-frame").show(),t.find("#text-controls").hide(),t.find("#text-frame").hide()):(tour=tourTxt,r.tocSelDirty&&r.buildTextFrame(),t.find("#toc-controls").hide(),t.find("#toc-frame").hide(),t.find("#text-controls").show(),t.find("#text-frame").show()),a.preventDefault()}function d(a){var b=jQuery(this),c=b.closest("li.toc-chap"),d=c.find("ul.toc-secs");d.toggle(),a.preventDefault()}function e(){var a,b=(document.getElementById("prsp-volume").innerHTML,t.find("#toc-frame > ul.toc-wrapper"));b.empty(),r.volData.forEach(function(c,d){a='<li class="toc-chap" data-c='+d+'><input type="checkbox" class="readlist-c"/> ',c.s.length>0&&(a+='<button class="toccollapse">Collapse</button> '),a+=c.e.innerHTML,a+='<ul class="toc-secs">',c.s.forEach(function(b,c){a+="<li data-s="+c+'><input type="checkbox" class="readlist"/>'+b.e.innerHTML+"</li>"}),a+="</ul></li>",b.append(a)}),t.find("#toc-frame > ul.toc-wrapper > li.toc-chap").click(h),t.find("#toc-frame > ul.toc-wrapper > li.toc-chap > ul.toc-secs li").click(j),t.find("#toc-frame > ul.toc-wrapper > li.toc-chap input[type=checkbox]").click(k),t.find("#toc-frame .toccollapse").button({icons:{primary:"ui-icon-plus"},text:!1}).click(d)}function f(){for(var a,b,c,d=0,e=[],f=0;f<r.tocSel.length;f++){a=r.tocSel[f],b=r.tocRL[f],c=r.volData[f],e.push({i:d++,cI:f,sI:-1,l:Math.floor(12*c.l/s),sel:a.c,rl:b.c});for(var g=0;g<a.s.length;g++)e.push({i:d++,cI:f,sI:g,l:Math.floor(12*c.s[g].l/s),sel:a.s[g],rl:b.s[g]})}r.bm=e,r.svg=d3.select("#bookmark").append("svg");r.svg.selectAll(".bm").data(e).enter().append("rect").attr("class",function(a){return a.sel?"bm sel":"bm"}).attr("x",function(a){return 6*a.i}).attr("y",function(a){return 12-a.l}).attr("width","5").attr("height",function(a){return 2+a.l}).attr("fill",function(a){return a.rl?"#0099FF":"#C0C0C0"})}function g(a){var b,c,d,e=r.vizSel,f=a.target;"A"!==f.nodeName&&"A"===f.parentNode.nodeName&&(f=f.parentNode),"A"===f.nodeName&&(d=f.dataset.id,b=PData.nByID(d),null!=b&&(c=_.sortedIndex(e,b),e[c]===b?(e.splice(c,1),r.selAbsIs.splice(_.sortedIndex(r.selAbsIs,b),1),r.callbacks.delSel(0,b),t.find('#read-pane a[data-id="'+d+'"]').removeClass("sel")):(0===e.length?e.push(b):e.splice(c,0,b),r.selAbsIs.splice(_.sortedIndex(r.selAbsIs,b),0,b),r.callbacks.addSel(0,b),t.find('#read-pane a[data-id="'+d+'"]').addClass("sel")),r.upSel(e,!1),a.preventDefault()))}function h(a){var b=a.target.dataset.c;if("undefined"!=typeof b){r.tocSelDirty=!0;var c=r.tocSel[b];c.c=!c.c;var d=t.find('#toc-frame > ul.toc-wrapper > li.toc-chap[data-c="'+b+'"]');c.c?d.addClass("sel"):d.removeClass("sel"),r.updateBookMark(),a.preventDefault()}}function j(a){var b=a.target.dataset.s;if("undefined"!=typeof b){r.tocSelDirty=!0;var c=jQuery(a.target).closest("li.toc-chap"),d=c.data("c"),e=r.tocSel[d],f=e.s[b]=!e.s[b],g=c.find('ul.toc-secs > li[data-s="'+b+'"]');f?g.addClass("sel"):g.removeClass("sel"),r.updateBookMark(),a.preventDefault()}}function k(a){var b,c,d=a.target.checked;if("readlist-c"===a.target.className){var b=jQuery(a.target).closest("li.toc-chap").data("c");r.tocRL[b].c=d}else if("readlist"===a.target.className){var c=jQuery(a.target).closest("li").data("s"),b=jQuery(a.target).closest("li.toc-chap").data("c");r.tocRL[b].s[c]=d}r.updateBookMark()}function l(a){a.preventDefault();var b,c,d,e=null,f=null;a:for(c=0;c<r.tocSel.length;c++){if(b=r.tocSel[c],b.c){e=c-1;break}for(d=0;d<b.s.length;d++)if(b.s[d]){e=c,f=d-1;break a}}if(null!=e)for(;e>-1;){for(b=r.tocRL[e],null==f&&(f=b.s.length-1);f>-1;f--)if(b.s[f])return void r.setTOCSel(!0,e,f);if(f=null,b.c)return void r.setTOCSel(!0,e,-1);e--}}function m(a){a.preventDefault();var b,c,d,e=null,f=null,g=!1;a:for(c=r.tocSel.length-1;c>=0;c--){for(b=r.tocSel[c],d=b.s.length-1;d>=0;d--)if(b.s[d]){f=d+1,d==b.s.length-1?(e=c+1,f=0,g=!0):e=c;break a}if(b.c){e=c,f=0;break}}if(null!=e)for(;e<r.tocRL.length;){if(b=r.tocRL[e],g&&b.c)return void r.setTOCSel(!0,e,-1);
for(;f<b.s.length;f++)if(b.s[f])return void r.setTOCSel(!0,e,f);f=0,e++,g=!0}}function n(a){var b;b=jQuery("#dialog-find-toc").dialog({dialogClass:"no-close",height:150,width:250,modal:!0,buttons:[{text:dlText.ok,click:function(){function a(a,b){return b?a.innerHTML.indexOf(c)!==-1:jQuery(a).contents().text().indexOf(c)!==-1}var c=jQuery("#find-toc-txt").val();r.searchFunc(a,!0),b.dialog("close")}},{text:dlText.cancel,click:function(){b.dialog("close")}}]}),a.preventDefault()}function o(a){jQuery("body").trigger("prsp-hilite",{v:0,t:null}),a.preventDefault()}function p(a){r.openSelection(),a.preventDefault()}function q(a){var b=jQuery(a.target).closest("div.sellist-rec").data("id"),c=a.target.className;switch(c){case"sellist-rec":r.inspRec=b,r.openSelection()}a.preventDefault()}var r=this,s=0,t=jQuery("#view-frame-0");!function(){for(var a=jQuery("#prsp-volume").children(":first"),b=null,c=null,d=0;0!=a.length;){switch(a.prop("tagName").toUpperCase()){case"H1":null!=c&&(null!=b&&b.s.push(c),c=null),null!=b&&r.volData.push(b),b={e:a.get(0),s:[],l:0};break;case"H2":null!=c&&(null!=b&&b.s.push(c),c=null),c={e:a.get(0),l:0};break;default:d=jQuery(a).contents().text().length,null!=c?c.l+=d:null!=b&&(b.l+=d)}a=a.next()}null!=c&&b.s.push(c),null!=b&&r.volData.push(b),r.volData.forEach(function(a){s=Math.max(s,a.l);var b={c:!0,s:[]},c={c:!1,s:[]};a.s.forEach(function(a){s=Math.max(s,a.l),b.s.push(!0),c.s.push(!1)}),r.tocRL.push(b),r.tocSel.push(c)}),r.tocSel[0].c=!0}(),t.find("#hstoc").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(c),t.find("#tochcall").click(a),t.find("#tochsall").click(b),t.find("#tocfind").button({icons:{primary:"ui-icon-star"},text:!1}).click(n),t.find("#textprev").button({icons:{primary:"ui-icon-arrow-1-w"},text:!1}).click(l),t.find("#textnext").button({icons:{primary:"ui-icon-arrow-1-e"},text:!1}).click(m),t.find(".hilite").button({icons:{primary:"ui-icon-signal"},text:!1}).click(o),t.find(".osel").button({icons:{primary:"ui-icon-battery-3"},text:!1}).click(p),t.find("#read-pane").click(g),t.find("div.sellist").draggable({handle:t.find("div.sellist > div.sellist-handle"),containment:"parent",stop:function(){t.find("div.sellist").css({height:"",bottom:""})}}),t.find("div.view-controls > #text-controls > span.btn-num-sel").click(function(a){t.find("div.sellist").show(),a.preventDefault()}),t.find("div.sellist > div.sellist-handle > button.close").button({icons:{primary:"ui-icon-closethick"},text:!1}).click(function(a){a.preventDefault(),t.find("div.sellist").hide()}),t.find("div.sellist > div.sellist-handle > button.minmax").button({icons:{primary:"ui-icon-arrowthick-2-n-s"},text:!1}).click(function(a){a.preventDefault(),t.find("div.sellist > div.sellist-scroll").toggle(),t.find("div.sellist").toggleClass("min")}),t.find("div.sellist > div.sellist-scroll").click(q),e(),this.updateTOCRL(),this.updateTOCSel(),this.buildTextFrame(),f()},PTextFrame.prototype.flushLgnd=function(){var a=jQuery("#view-frame-0"),b=a.width()-280;a.find("div.sellist").css("left",b).css("top",20)},PTextFrame.prototype.txtIDs2IS=function(){var a,b,c,d,e={s:[],t:[],l:0};for(b=0,c=PData.eTNum();b<c;b++)e.t.push({i:0,n:0});return this.txtIDs.forEach(function(f){if(a=PData.nByID(f),null!=a){for(0===e.s.length?e.s.push(a):(b=_.sortedIndex(e.s,a),e.s.splice(b,0,a)),d=PData.n2T(a),e.t[d++].n+=1;d<c;)e.t[d++].i+=1;e.l+=1}}),e},PTextFrame.prototype.clearSel=function(){this.selAbsIs=[],this.vizSel=[],this.upSel([],!1),jQuery("#read-pane a").removeClass("sel")},PTextFrame.prototype.setSel=function(a){jQuery("#read-pane a").removeClass("sel"),this.selAbsIs=a.slice(0);var b,c,d=[];return a.forEach(function(a){b=PData.rByN(a),b&&(c=jQuery('#read-pane a[data-id="'+b.id+'"]'),c.length>0&&(c.addClass("sel"),d.push(a)))}),this.vizSel=d,this.upSel(d,!1),!0},PTextFrame.prototype.addSel=function(a){var b,c,d;b=_.sortedIndex(this.selAbsIs,a),this.selAbsIs.splice(b,0,a),c=PData.rByN(a),d=jQuery('#read-pane a[data-id="'+c.id+'"]'),d.length>0&&(d.addClass("sel"),0===this.vizSel.length?this.vizSel.push(a):(b=_.sortedIndex(this.vizSel,a),this.vizSel.splice(b,0,a)),this.upSel(this.vizSel,!1))},PTextFrame.prototype.delSel=function(a){var b,c;b=_.sortedIndex(this.selAbsIs,a),this.selAbsIs.splice(b,1),b=_.sortedIndex(this.vizSel,a),this.vizSel[b]===a&&(this.vizSel.splice(b,1),c=PData.rByN(a),jQuery('#read-pane a[data-id="'+c.id+'"]').removeClass("sel"),this.upSel(this.vizSel,!1))},jQuery(document).ready(function(a){function b(a){var b=[];return a.forEach(function(a){b.push({c:a.c,s:a.s.slice(0)})}),b}function c(a){var b,c=[];return a.forEach(function(a){b=PData.rByN(a),null!=b&&c.push(b.id)}),c}function d(a){var b,c=[];return a.forEach(function(a){b=PData.nByID(a),null!=b&&c.push(b)}),c}function e(a){var b,c,d,e={s:[],t:[],l:0};for(b=0,c=PData.eTNum();b<c;b++)e.t.push({i:0,n:0});return a.forEach(function(a){for(0===e.s.length?e.s.push(a):(b=_.sortedIndex(e.s,a),e.s.splice(b,0,a)),d=PData.n2T(a),e.t[d++].n+=1;d<c;)e.t[d++].i+=1;e.l+=1}),e}function f(){null==H&&(H=PData.sNew(!0)),I=H}function g(a){C=a;var b=jQuery("#annote");b.text(a),a.length>0?(jQuery("#btn-annote").button("enable"),b.show()):(jQuery("#btn-annote").button("disable"),b.hide())}function h(a){jQuery("#annote").toggle("slide",{direction:"right"}),a.preventDefault()}function i(a){var b;jQuery("#dialog-about img").removeClass("zoomin"),b=jQuery("#dialog-about").dialog({dialogClass:"no-close",height:390,width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]}),jQuery("#dialog-about img").addClass("zoomin"),a.preventDefault()}function j(a){var b=_.find(prspdata.p,function(b){return a==b.id});return b?b:null==J||0==K.length?null:(b=_.find(K,function(b){return a==b.id}),b?b:null)}function k(a,d){var e=E[0],f=E[1],g=jQuery("input[name=save-reading-dest]:checked").val();if(""==g)return null;var h=jQuery("#save-reading-note").val();h=h.replace(/"/g,"");var i={rl:b(e.tocRL),sel:b(e.tocSel),vm:M,h0:null,h1:null,recs:null,v1:null};switch(f&&(i.v1={l:f.title(),s:f.getState()}),jQuery("input[name=select-read-by]:checked").val()){case"recs":i.recs=[c(e.vizSel),c(f.vizSel)];break;case"h0":i.h0={id:G[0],s:F[0].getState()};break;case"h1":i.h1={id:G[1],s:F[1].getState()}}var j={id:a,l:d,n:h,s:i};return"local"==g?(K.push(j),J.setItem(prspdata.e.id,JSON.stringify(K))):"server"==g&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_reading",id:a,l:d,x:prspdata.e.id,n:h,s:JSON.stringify(i)},success:function(a,b,c){"0"!=a&&prspdata.p.push(j)},error:function(a,b,c){alert(c)}}),g}function l(a){var b,c=/[^\w\-]/;jQuery("#save-reading-id").val(""),jQuery("#save-reading-lbl").val(""),jQuery("#save-reading-note").val(""),J||jQuery("#save-reading-d-1").prop("disabled",!0),prspdata.x.add_reading||jQuery("#save-reading-d-2").prop("disabled",!0),jQuery("#read-by-h0").prop("disabled",null==F[0]),jQuery("#read-by-h1").prop("disabled",null==F[1]),b=jQuery("#dialog-save-reading").dialog({dialogClass:"no-close",width:350,height:420,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-reading-id").val().trim(),d=a.match(c),e=jQuery("#save-reading-lbl").val().trim();if(e=e.replace(/"/g,""),0===a.length||a.length>20||d?d="#dialog-reading-id-badchars":j(a)?d="#dialog-reading-id-used":(0===e.length||e.length>32)&&(d="#dialog-reading-label-bad"),d)var f=jQuery(d).dialog({dialogClass:"no-close",width:320,height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){f.dialog("close")}}]});else{var g=k(a,e);if(b.dialog("close"),"server"==g){var h=volURL+"/?reading="+a;jQuery("#save-reading-embed").val(h);var i=jQuery("#dialog-reading-url").dialog({dialogClass:"no-close",width:480,height:230,modal:!0,buttons:[{text:dlText.ok,click:function(){i.dialog("close")}}]})}}}},{text:dlText.cancel,click:function(){b.dialog("close")}}]}),a.preventDefault()}function m(){function a(){var a=jQuery("#reading-mlist");a.empty(),K.forEach(function(b){a.append('<li data-type="l" data-id="'+b.id+'"><span class="label">'+b.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")});for(var b=0;b<J.length;b++){var d=J.key(b);if(d!=prspdata.e.id){var e=J.getItem(d);try{var f=JSON.parse(e);c.push({id:d,ps:f})}catch(a){}}}c.forEach(function(b,c){b.ps.forEach(function(d){a.append('<li data-type="x" data-xid="'+b.id+'" data-xindex="'+c+'" data-id="'+d.id+'"><i class="label">'+d.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})}var b,c=[],d=!1;a(),jQuery("#reading-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var b,e=jQuery(a.target).hasClass("del"),f=jQuery(a.target).parent(),g=f.data("type"),h=f.data("id");if(e){switch(g){case"l":b=K.findIndex(function(a){return h==a.id}),b!=-1&&(K.splice(b,1),0==K.length?J.removeItem(prspdata.e.id):J.setItem(prspdata.e.id,JSON.stringify(K)));break;case"x":var i=f.data("xindex"),j=c[i];b=j.ps.findIndex(function(a){return h==a.id}),b!=-1&&(j.ps.splice(b,1),d=!0)}f.remove()}else{var k;switch(g){case"l":k=_.find(K,function(a){return h==a.id});break;case"x":var i=f.data("xindex"),j=c[i];k=_.find(j.ps,function(a){return h==a.id})}jQuery("#edit-reading-lbl").val(k.l),jQuery("#edit-reading-note").val(k.n);var l=jQuery("#dialog-edit-reading").dialog({dialogClass:"no-close",width:340,height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){k.l=jQuery("#edit-reading-lbl").val(),k.n=jQuery("#edit-reading-note").val(),f.find(".label").text(k.l),"x"==g?d=!0:J.setItem(prspdata.e.id,JSON.stringify(K)),l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]})}}}),b=jQuery("#dialog-manage-reading").dialog({dialogClass:"no-close",width:450,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){d&&c.forEach(function(a){a.ps.length>0?J.setItem(a.id,JSON.stringify(a.ps)):J.removeItem(a.id)}),jQuery("#reading-mlist").off("click"),b.dialog("close")}}]})}function n(a){var b=jQuery("#reading-slist");b.empty(),prspdata.p.forEach(function(a){b.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")}),K.forEach(function(a){b.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var c=[{text:dlText.ok,click:function(){d.dialog("close");var a=b.find("li.selected");if(a.length){var c=a.data("id");t(c)}}},{text:dlText.cancel,click:function(){d.dialog("close")}}];J&&c.push({text:dlText.manage,click:function(){d.dialog("close"),m()}});var d=jQuery("#dialog-show-reading").dialog({dialogClass:"no-close",width:350,height:350,modal:!0,buttons:c});a.preventDefault()}function o(a){window.location.href=prspdata.e.g.hurl,a.preventDefault()}function p(a,b,c){var d,e,f,g;if(d=c,"_remove"==a)e=new PFilterRemove(d),f={t:[!0,!0,!0,!0]};else switch(f=PData.aByID(a),f.def.t){case"V":e=new PFilterVocab(d,f);break;case"T":e=new PFilterText(d,f);break;case"g":e=new PFilterTags(d,f);break;case"N":e=new PFilterNum(d,f);break;case"D":e=new PFilterDates(d,f);break;case"P":e=new PFilterPtr(d,f)}return jQuery("#dialog-hilite-"+c+" span.filter-id").html(f.def.l),g=jQuery("#hilite-"+c),g.empty(),e.setup(),e}function q(a,b,c,d){jQuery("#filter-list li").removeClass("selected");var e,f,g,h,i=jQuery("#filter-list li");i.each(function(b){e=jQuery(this),f=e.data("id"),"_remove"==f?a?e.show():e.hide():c?(g=PData.aByID(f),h=!1,g.t.forEach(function(a,b){h=h||a&&c[b]}),h?e.show():e.hide()):e.show()});var j,k={dialogClass:"no-close",height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");1===a.length&&d(a.data("id")),j.dialog("close")}},{text:dlText.cancel,click:function(){j.dialog("close")}}]};b&&(k.appendTo="#dialog-2"),j=jQuery("#dialog-choose-att").dialog(k)}function r(a){var b,c,d,f=F[a],g=E[0],h=E[1],i=0,j=0,k=[];if(0===a){var l=g.txtIDs2IS();jQuery("#read-pane a").removeClass("sel"),f.evalPrep(),d=l.t[0];a:for(;i<l.l;){for(;0==d.n||d.i+d.n==i;){if(++j===PData.eTNum())break a;d=l.t[j],i=d.i}b=l.s[i++],c=PData.rByN(b),f.eval(c)&&k.push(b)}switch(f.evalDone(l.l),M){case"v0":case"v1":k.length>0?(g.setSel(k),h.setSel(k)):(g.clearSel(),h.clearSel());break;case"v2":k.length>0?g.setSel(k):g.clearSel(),h.clearSel(),I=e(k),h.showStream(I)}}else{var m=h.getBMData();if(null!=I){f.evalPrep(),d=I.t[0];a:for(;i<I.l;){for(;!m.t[j]||0==d.n||d.i+d.n==i;){if(++j===PData.eTNum())break a;d=I.t[j],i=d.i}b=I.s[i++],m.r[b>>4]&1<<(15&b)&&(c=PData.rByN(b),f.eval(c)&&k.push(b))}f.evalDone(I.l)}k.length>0?(h.setSel(k),"v2"!==M&&g.setSel(k)):(h.clearSel(),"v2"!==M&&g.clearSel())}}function s(a,b){var c;c=jQuery("#dialog-hilite-"+a).dialog({dialogClass:"no-close",height:275,width:Math.min(jQuery(window).width()-20,675),modal:!0,appendTo:"#dialog-1",buttons:[{text:dlText.chsatt,click:function(){q(!1,!0,b,function(b){G[a]=b,F[a]=p(b,null,a)})}},{text:dlText.ok,click:function(){c.dialog("close"),null!==F[a]&&r(a)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})}function t(a){function b(a){return prspdata.e.vf.findIndex(function(b){return a===b.l})}function c(a,b){var c,d,e,f;for(c=0;c<b.length&&c<a.length;c++)for(e=a[c],f=b[c],f.c=e.c,d=0;d<f.s.length&&d<e.s.length;d++)f.s[d]=e.s[d]}function e(a,b){var c=p(b.id,null,a),d=1^a;G[a]=b.id,F[a]=c,c.setState(b.s),G[d]=null,F[d]=null,jQuery("#hilite-"+(1^a)).empty(),jQuery("#dialog-hilite-"+(1^a)+" .filter-id").empty()}var h=E[0],i=E[1];N=null,O=null;var k=j(a);return null!=k&&(M=k.s.vm,c(k.s.rl,h.tocRL),c(k.s.sel,h.tocSel),jQuery("#command-bar input[type=radio][name=vizmode]").val([M]),h.updateTOCRL(),h.updateTOCSel(),h.updateBookMark(),h.buildTextFrame(),vI=b(k.s.v1.l),i?(i.setViz(vI,!1),i.upSel([],!0)):(E[1]=new PVizFrame(1,D),i=E[1],i.initDOM(vI)),i.setState(k.s.v1.s),g(k.n),null!=k.s.h0?e(0,k.s.h0):null!=k.s.h1?e(1,k.s.h1):(G[0]=G[1]=F[0]=F[1]=null,jQuery("#dialog-hilite-0 .filter-id").empty(),jQuery("#dialog-hilite-1 .filter-id").empty(),jQuery("#hilite-0").empty(),jQuery("#hilite-1").empty(),N=k.s.recs[0],O=k.s.recs[1]),PData.ready()&&H&&(f(),null!=G[0]?r(0):"v2"===M&&null!=N&&(h.setSel(d(N)),N=null),y(),null!=G[1]?r(1):(null!=N&&(h.setSel(d(N)),N=null),null!=O&&(i.setSel(d(O)),O=null))),!0)}function u(a){var b=E[0],c=E[1];switch(b.clearSel(),M){case"v0":case"v1":c.clearSel();break;case"v2":I=e([]),c.showStream(I),c.upSel([],!1)}a.preventDefault()}function v(a,b){var c=E[1^a];switch(M){case"v0":case"v1":c.addSel(b);break;case"v2":0===a&&y()}}function w(a,b){var c=E[1^a];switch(M){case"v0":case"v1":c.delSel(b);break;case"v2":0===a&&y()}}function x(){var a=E[1];null!=a&&a.clearSel(),y()}function y(){var a,b=E[0],c=E[1];if(null!=H)switch(M){case"v0":I=H,c.showStream(H),a=b.vizSel,a.length>0?c.setSel(a.slice(0)):c.clearSel();break;case"v1":I=b.txtIDs2IS(),c.showStream(I),a=b.vizSel,a.length>0?c.setSel(a.slice(0)):c.clearSel();break;case"v2":c.clearSel(),I=e(b.vizSel),c.showStream(I)}}function z(a,b){var c=prspdata.bClrs[a];c&&c.length>0&&jQuery(b).css("background-color",c)}function A(a,b){return jQuery(a).attr("id")===S}function B(a,b){for(var c={id:b,showPrevButton:!0,i18n:{nextBtn:dlText.next,prevBtn:dlText.prev,doneBtn:dlText.close},steps:[]},d=jQuery(a).children(":first");0!=d.length;){var e={target:jQuery(d).data("t"),placement:jQuery(d).data("p"),title:jQuery(d).data("l"),xOffset:jQuery(d).data("x"),yOffset:jQuery(d).data("y"),content:jQuery(d).contents().text()};c.steps.push(e),d=d.next()}return c}var C,D,E=[null,null],F=[null,null],G=[null,null],H=null,I=null,J=null,K=[],L=!1,M="v1",N=null,O=null;jQuery("body").addClass("waiting"),z("cb","#command-bar"),"undefined"!=typeof PMapHub&&PMapHub.init(prspdata.m),function(){function a(a,c){b=document.getElementById(a).innerHTML,dlText[c]=b.trim()}var b;if(a("dltext-removehideall","rha"),a("dltext-showhideall","sha"),a("dltext-ok","ok"),a("dltext-cancel","cancel"),a("dltext-next","next"),a("dltext-prev","prev"),a("dltext-choose-att","chsatt"),a("dltext-seerec","seerec"),a("dltext-close","close"),a("dltext-add","add"),a("dltext-manage","manage"),a("dltext-delete","del"),a("dltext-edit","edit"),a("dltext-markers","markers"),a("dltext-hint-marker","markersize"),a("dltext-hint-text","textsize"),a("dltext-xaxis","xaxis"),a("dltext-yaxis","yaxis"),a("dltext-undefined","undef"),a("dltext-orderedby","orderedby"),a("dltext-grpblks","grpblks"),a("dltext-reset","reset"),a("dltext-nofilter","nofilter"),a("dltext-dofilters","dofilters"),a("dltext-filtered","filtered"),a("dltext-findintext","findintext"),a("dltext-selected","selected"),b=document.getElementById("dltext-month-names").innerHTML,months=b.trim().split("|"),(b=document.getElementById("dltext-d3-local"))&&(b=b.innerHTML.trim())&&"no-d3-local"!==b){var c=d3.locale(JSON.parse(b));localD3=c.timeFormat.multi([["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]])}}(),volURL=window.location.pathname,volURL=volURL.replace(/\&*reading=[\w\-]+/,""),volURL=volURL.replace(/\/$/,""),volURL=volURL.replace(/^\//,""),volURL="http://"+window.location.host+"/"+volURL,jQuery("script").first().before('<link href="//fonts.googleapis.com/css?family=Crimson+Text:n,b,i" rel="stylesheet" type="text/css"/>'),function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),b=[];prspdata.t.forEach(function(c,d){b.push(a({ti:d,tl:c.def.l}))}),apTmStr=b.join("&nbsp;")}(),function(){var a;prspdata.t.forEach(function(b,c){var d="";b.def.a.forEach(function(b){switch(a=PData.aByID(b),a.def.t){case"T":case"V":case"N":case"D":d+='<option value="'+b+'">'+a.def.l+"</option>"}}),jQuery("#dialog-sortby").append("<b>"+b.def.l+"</b>: <select data-ti="+c+">"+d+"</select><br/>")})}(),"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/"),""!=prspdata.e.g.l&&jQuery("#title").text(prspdata.e.g.l);try{var P=window.localStorage,Q="__storage_test__";P.setItem(Q,Q),P.removeItem(Q);var R=P.getItem(prspdata.e.id);J=P,R.length>0&&(K=JSON.parse(R))}catch(a){}if(jQuery("#btn-about").button({icons:{primary:"ui-icon-power"},text:!1}).click(i),jQuery("#btn-togtext").button({icons:{primary:"ui-icon-arrow-2-e-w"},text:!1}).click(function(){jQuery("#view-frame-0").toggleClass("mini-text"),jQuery("#view-frame-1").toggleClass("mini-text"),E[1].resize(),E[0].flushLgnd(),E[1].flushLgnd()}),"undefined"!=typeof prspdata.e.g.dspr&&prspdata.e.g.dspr?(jQuery("#btn-show-reading").remove(),jQuery("#btn-save-reading").remove()):(jQuery("#btn-show-reading").button({icons:{primary:"ui-icon-image"},text:!1}).click(n),jQuery("#btn-save-reading").button({icons:{primary:"ui-icon-calendar"},text:!1}).click(l)),jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(h),jQuery("#clearsel").click(u),jQuery("#command-bar input[type=radio][name=vizmode]").change(function(){M=this.value,E[0].clearSel(),E[1].clearSel(),null!=H&&y()}),prspdata.e.g.hbtn.length>0&&prspdata.e.g.hurl.length>0?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(o)):jQuery("#btn-home").remove(),jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).addClass("selected"))}),jQuery("#reading-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#reading-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))}),jQuery("#dialog-about .logo").attr("src",prspdata.assets+"prospectlogo.jpg"),jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1}),jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:!1}),function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+dlText.rha+"</i></li>");var a=[];prspdata.a.forEach(function(b){if("undefined"==typeof b.def.f||b.def.f===!0)switch(b.def.t){case"V":case"T":case"g":case"N":case"D":case"P":a.push({id:b.id,l:b.def.l})}}),a.sort(function(a,b){return a.l.localeCompare(b.l)}),a.forEach(function(a){jQuery("#filter-list").append('<li data-id="'+a.id+'">'+a.l+"</li>")})}(),D={addSel:v,delSel:w,newText:x,textFrame:null},E[0]=new PTextFrame(0,D),E[0].initDOM(),D.textFrame=E[0],0===prspdata.show_reading.length||!t(prspdata.show_reading)){E[1]=new PVizFrame(1,D),E[1].initDOM(0),g("");var S=window.location.hash;S.length>0&&(S=S.substr(1),E[0].searchFunc(A,!0))}if(jQuery(window).resize(function(){E[1]&&E[1].resize()}),"undefined"==typeof prspdata.e.g.auto){for(var T=0,U=0;U<prspdata.t.length;U++)T+=prspdata.t[U].n;T<500&&(L=!0)}else L=prspdata.e.g.auto;L&&(jQuery("#auto-re").prop("checked",!0),jQuery("body").trigger("prsp-auto",{a:L})),jQuery("#auto-re").change(function(){L=jQuery("#auto-re").prop("checked"),jQuery("body").trigger("prsp-auto",{a:L})}),jQuery("body").on("prsp-loaded",function(a){var b=document.getElementById("dltext-ready").innerHTML,c=document.getElementById("pstate");c.classList.remove("attn"),c.textContent=b.trim(),f(),null!=G[0]?r(0):"v2"===M&&null!=N&&(E[0].setSel(d(N)),N=null),y(),null!=G[1]?r(1):(null!=N&&(E[0].setSel(d(N)),N=null),null!=O&&(E[1].setSel(d(O)),O=null)),jQuery("body").removeClass("waiting")}),jQuery("body").on("prsp-hilite",function(a,b){s(b.v,b.t)}),PData.init(),prspdata.x.tour?(tourTxt=B("#help-txt-tour","helpTxt"),tourTOC=B("#help-toc-tour","helpTOC"),tour=tourTxt,jQuery("#command-bar .help").click(function(){hopscotch.startTour(tour)})):jQuery("#command-bar .help").hide()});