/*! prospect 2016-11-21 */
function PVizModel(a,b){this.vFrame=a,this.frameID=a.getFrameID()+" div.viz-content div.viz-result",this.settings=b,this.recSel=[],this.tUsed=[!1,!1,!1,!1],this.rMap=null}function PFilterModel(a,b){this.id=a,this.att=b,this.dirty=1}Array.prototype.findIndex||(Array.prototype.findIndex=function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;f<d;f++)if(b=c[f],a.call(e,b,f,c))return f;return-1});var EVENT_INSTANT=1,EVENT_F_START=2,EVENT_F_END=4,D3FG_BAR_WIDTH=25,D3FG_MARGINS={top:4,right:7,bottom:22,left:30},D3SC_MARGINS={top:30,right:5,bottom:5,left:40},V_FLAG_LGND=1,V_FLAG_SEL=2,V_FLAG_LOC=4,V_FLAG_SLGND=8,V_FLAG_OPT=16,V_FLAG_VSCRL=32,V_FLAG_HSCRL=64,TODAY=new Date,localD3,months,dlText={};PVizModel.prototype.flags=function(){return 0},PVizModel.prototype.preRender=function(){var a,b=PData.rSize(),c=Math.floor((b+15)/16);for(a=0;a<4;a++)this.tUsed[a]=!1;for(null==this.rMap&&(this.rMap=new Uint16Array(c)),a=0;a<c;a++)this.rMap[a]=0},PVizModel.prototype.isSel=function(a){var b=_.indexOf(this.recSel,a,!0);return b!=-1},PVizModel.prototype.getSel=function(){return this.recSel},PVizModel.prototype.toggleSel=function(a){var b=(this.recSel.length,_.sortedIndex(this.recSel,a));return this.recSel[b]===a?(this.recSel.splice(b,1),this.vFrame.vizDelSel(a),this.vFrame.upSel(this.recSel,!1),!1):(this.recSel.splice(b,0,a),this.vFrame.vizAddSel(a),this.vFrame.upSel(this.recSel,!1),!0)},PVizModel.prototype.clearSel=function(){this.recSel=[]},PVizModel.prototype.getLocAtts=function(a){return[]},PVizModel.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},PVizModel.prototype.teardown=function(){},PVizModel.prototype.resize=function(){},PVizModel.prototype.doOptions=function(){},PVizModel.prototype.getState=function(){return{}},PVizModel.prototype.setState=function(a){},PVizModel.prototype.hint=function(){return null};var VizMap=function(a,b){PVizModel.call(this,a,b)};VizMap.prototype=Object.create(PVizModel.prototype),VizMap.prototype.constructor=VizMap,VizMap.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_OPT},VizMap.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.cAtts[a];return null==b?null:b}return this.settings.cAtts},VizMap.prototype.setup=function(){function a(){f.lMap.zoomIn()}function b(){f.lMap.zoomOut()}function c(){f.lMap.setView([g,h],e)}function d(){function a(a){f.lMap.setView([a.coords.latitude,a.coords.longitude])}navigator.geolocation.getCurrentPosition(a)}var e,f=this,g=parseFloat(this.settings.clat),h=parseFloat(this.settings.clon);e="string"==typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var i=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+i+'" class="max-size"></div>'),this.lMap=L.map("l-map-"+i,{zoomControl:!1}).setView([g,h],e),this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null),this.bOp=100,this.lOps=[],this.mapLayers=[];var j;_.each(this.settings.lyrs,function(a,b){j=a.o,f.lOps.push(100*j);var c;c=PMapHub.createMapLayer(a.lid,j,f.lMap,null),f.mapLayers.push(c)});var k=_.template(document.getElementById("dltext-v-map").innerHTML);jQuery("#view-frame-"+i+" div.view-controls").append(k({vi:i})),jQuery("#map-zoom-"+i).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(a),jQuery("#map-unzoom-"+i).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(b),jQuery("#map-reset-"+i).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(c),jQuery("#map-cloc-"+i).button({text:!1,icons:{primary:"ui-icon-pin-s"}}).click(d);var l=L.featureGroup();this.markerLayer=l,l.options=l.options||{},l.options.layerName=dlText.markers,l.addTo(this.lMap);var m=L.featureGroup();this.lineLayer=m,m.addTo(this.lMap);var n=PData.eTNum();this.tLCnt=new Uint16Array(n)},VizMap.prototype.render=function(a){function b(a){if(a.target&&a.target.options){var b=a.target.options._aid,e=c.toggleSel(b),f=PData.n2T(b);c.tLCnt[f]>1?d.eachLayer(function(a){a.options._aid===b&&(e?(a.setStyle({color:"yellow",weight:2}),a.bringToFront()):a.setStyle({color:"#000",weight:1}))}):e?(this.setStyle({color:"yellow",weight:2}),this.bringToFront()):this.setStyle({color:"#000",weight:1})}}var c=this,d=this.markerLayer;this.recSel.length>0&&(this.recSel=[]),this.preRender(),d.clearLayers();var e=this.lineLayer;e.clearLayers();var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=a.t.length,z=0,A=0;for(t=this.settings.min,"string"==typeof t&&(t=parseInt(t)),u=this.settings.max,"string"==typeof u&&(u=parseInt(u)),v=u-t,z=0;z<y;z++)this.tLCnt[z]=0;var B;for(z=0;z<y;z++)if("disable"!==this.settings.pAtts[z]){B=[];break}z=0,A=-1;a:for(;z<a.l;){if(null==l){do{if(++A==y)break a;g=a.t[A]}while(0===g.n||g.i+g.n===z);if(l=this.vFrame.getSelLocAtts(A),0===l.length){l=null;continue}if(m=c.vFrame.getSelFeatAtts(A),0===m.length){l=null;continue}c.tLCnt[A]=l.length,c.tUsed[A]=!0,j=c.vFrame.getSelLegend(A),k=PData.aByID(j),n=c.settings.pAtts[A],h=c.settings.lClrs[A],r=c.settings.sAtts[A],r&&(s=PData.aByID(r),"number"==typeof s.r.min&&"number"==typeof s.r.max?(w=s.r.min,x=s.r.max-w):r=null)}f=a.s[z],i=PData.rByN(f);var C;B&&(C={id:i.id,c:[],p:i.a[n],l:h}),l.forEach(function(a){if(o=i.a[a],o&&(p=i.a[j],"undefined"!=typeof p&&(p=PData.lClr(p,k,m)))){if(c.rMap[f>>4]|=1<<(15&f),"number"==typeof o[0])r?(s=i.a[r],s="number"==typeof s?Math.floor((s-w)*v/x)+t:t):s=t,q=L.circleMarker(o,{_aid:f,weight:1,radius:s,fillColor:p,color:"#000",opacity:1,fillOpacity:1}),C&&C.c.push(o);else if(q=2===o.length?L.polyline(o,{_aid:f,weight:1,fillColor:p,color:"#000",opacity:1,fillOpacity:1}):L.polygon(o,{_aid:f,weight:1,fillColor:p,color:"#000",opacity:1,fillOpacity:1}),C){var e=[0,0];o.forEach(function(a){e[0]+=a[0],e[1]+=a[1]}),e[0]=e[0]/o.length,e[1]=e[1]/o.length,C.c.push(e)}q.on("click",b),d.addLayer(q)}}),C&&C.c.length>0&&B.push(C),++z==g.i+g.n&&(l=null)}if(B){B.sort(function(a,b){return PData.strcmp(b.id,a.id)});var D=[];B.forEach(function(a){a.p&&a.p.forEach(function(b){if(z=_.sortedIndex(B,{id:b},"id"),z<B.length){var c=B[z];c.id===b&&a.c.forEach(function(b){c.c.forEach(function(c){b[0]===c[0]&&b[1]===c[1]||D.push({p:[b,c],c:a.l})})})}})}),D.forEach(function(a){e.addLayer(L.polyline(a.p,{color:a.c,weight:2}))})}},VizMap.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizMap.prototype.resize=function(){this.lMap.invalidateSize(!1)},VizMap.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000",weight:1})}))},VizMap.prototype.setSel=function(a){var b=this;this.recSel=a,this.markerLayer&&this.markerLayer.eachLayer(function(a){b.isSel(a.options._aid)?(a.setStyle({color:"yellow",weight:2}),a.bringToFront()):a.setStyle({color:"#000",weight:1})})},VizMap.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}},VizMap.prototype.setState=function(a){this.lMap.setView(a.c,a.z),this.vFrame.setLgndSels(a.l)},VizMap.prototype.hint=function(){for(var a="",b=PData.eTNum(),c=0;c<b;c++){var d=this.settings.sAtts[c];if(d){0===a.length?a=dlText.markersize:a+=",";var e=PData.aByID(d),f=PData.eTByN(c),g=PData.tByID(f);a+=" "+e.def.l+" ("+g.l+")"}}return a.length>0?a:null},VizMap.prototype.doOptions=function(){function a(){e&&(b.baseMap.setOpacity(b.bOp/100),b.lOps.forEach(function(a,c){b.mapLayers[c].setOpacity(a/100)})),f.empty()}var b=this,c=this.bOp,d=[],e=!0,f=jQuery("#dialog-opacities div.layer-list"),g=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");g.find(".op-slider").on("change",function(){c=jQuery(this).val(),b.baseMap.setOpacity(c/100)}),f.append(g),this.settings.lyrs.forEach(function(a,c){var e=b.lOps[c];g=jQuery('<div class="op-layer" data-i="'+c+'">'+b.mapLayers[c].options.layerName+' <input type=range class="op-slider" min=0 max=100 value='+e+" step=5></div>"),g.find(".op-slider").on("change",function(){d[c]=jQuery(this).val(),b.mapLayers[c].setOpacity(d[c]/100)}),d.push(e),f.append(g)});var h=jQuery("#dialog-opacities").dialog({dialogClass:"no-close",height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){e=!1,h.dialog("close"),b.bOp=c,d.forEach(function(a,c){b.lOps[c]=d[c]})}},{text:dlText.cancel,click:function(){h.dialog("close")}}]});h.on("dialogclose",function(b,c){a(),h.off("dialogclose")})};var VizMap2=function(a,b){PVizModel.call(this,a,b)};VizMap2.prototype=Object.create(PVizModel.prototype),VizMap2.prototype.constructor=VizMap2,VizMap2.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_OPT},VizMap2.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.cAtts[a];return null==b?null:[b]}return[this.settings.cAtts]},VizMap2.prototype.setup=function(){function a(){f.lMap.zoomIn()}function b(){f.lMap.zoomOut()}function c(){f.lMap.setView([g,h],e)}function d(){function a(a){f.lMap.setView([a.coords.latitude,a.coords.longitude])}navigator.geolocation.getCurrentPosition(a)}var e,f=this,g=parseFloat(this.settings.clat),h=parseFloat(this.settings.clon);e="string"==typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var i=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+i+'" class="max-size"></div>'),this.lMap=L.map("l-map-"+i,{zoomControl:!1}).setView([g,h],e),this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null),this.bOp=100,this.lOps=[],this.mapLayers=[];var j;this.settings.lyrs.forEach(function(a,b){j=a.o,f.lOps.push(100*j);var c;c=PMapHub.createMapGroup(a.gid,j,f.lMap),f.mapLayers.push(c)});var k=_.template(document.getElementById("dltext-v-map").innerHTML);jQuery("#view-frame-"+i+" div.view-controls").append(k({vi:i})),jQuery("#map-zoom-"+i).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(a),jQuery("#map-unzoom-"+i).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(b),jQuery("#map-reset-"+i).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(c),jQuery("#map-cloc-"+i).button({text:!1,icons:{primary:"ui-icon-pin-s"}}).click(d);var l=L.featureGroup();this.markerLayer=l,l.options=l.options||{},l.options.layerName=dlText.markers,l.addTo(this.lMap);var m=L.featureGroup();this.lblLayer=m,m.addTo(this.lMap);var n=L.featureGroup();this.lineLayer=n,n.addTo(this.lMap)},VizMap2.prototype.render=function(a){function b(a){if(a.target&&a.target.options){var b=a.target.options._aid,c=d.toggleSel(b),f=PData.n2T(b),g=d.vFrame.getSelLocAtts(f);g=g[0];var h=PData.rByN(b),i=h.a[g];i.length>1?e.eachLayer(function(a){a.options._aid===b&&(c?(a.setStyle({color:"yellow",weight:2}),a.bringToFront()):a.setStyle({color:"#000",weight:1}))}):c?(this.setStyle({color:"yellow",weight:2}),this.bringToFront()):this.setStyle({color:"#000",weight:1})}}function c(a,c){s?(t=j.a[s],t="number"==typeof t?Math.floor((t-x)*w/y)+u:u):t=u,q=L.circleMarker(a,{_aid:g,weight:1,radius:t,fillColor:p,color:"#000",opacity:1,fillOpacity:1}),q.on("click",b),e.addLayer(q),c&&"n"!=n&&d.lblLayer.addLayer(L.marker(a,{icon:L.divIcon({iconSize:null,className:"maplbl",html:"<div"+r+">"+j.l+"</div>"})}))}var d=this,e=this.markerLayer;this.recSel.length>0&&(this.recSel=[]),this.preRender(),e.clearLayers(),this.lblLayer.clearLayers();var f=this.lineLayer;f.clearLayers();var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=a.t.length,B=0,C=0,D=null;u=this.settings.min,"string"==typeof u&&(u=parseInt(u)),v=this.settings.max,"string"==typeof v&&(v=parseInt(v)),w=v-u,B=0,C=-1;a:for(;B<a.l;){if(null===D){do{if(++C===A)break a;h=a.t[C]}while(0===h.n||h.i+h.n===B);if(D=this.vFrame.getSelLocAtts(C),0===D.length){D=null;continue}if(D=D[0],m=d.vFrame.getSelFeatAtts(C),0===m.length){D=null;continue}d.tUsed[C]=!0,k=d.vFrame.getSelLegend(C),l=PData.aByID(k),r="","undefined"!=typeof d.settings.tClrs&&(r=d.settings.tClrs[C],r.length>0&&(r=' style="color:'+r+'"')),i=d.settings.lClrs[C],s=d.settings.sAtts[C],s&&(t=PData.aByID(s),"number"==typeof t.r.min&&"number"==typeof t.r.max?(x=t.r.min,y=t.r.max-x):s=null),n=d.settings.lbls[C]}g=a.s[B],j=PData.rByN(g),o=j.a[D],o&&(p=j.a[k],"undefined"!=typeof p&&(p=PData.lClr(p,l,m),p&&(d.rMap[g>>4]|=1<<(15&g),"number"==typeof o[0]?c(o,!0):o.forEach(function(a,b){c(a,0===b),0===b?z=a:f.addLayer(L.polyline([z,a],{color:i}))})))),++B==h.i+h.n&&(D=null)}},VizMap2.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizMap2.prototype.resize=function(){this.lMap.invalidateSize(!1)},VizMap2.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000",weight:1})}))},VizMap2.prototype.setSel=function(a){var b=this;this.recSel=a,this.markerLayer&&this.markerLayer.eachLayer(function(a){b.isSel(a.options._aid)?(a.setStyle({color:"yellow",weight:2}),a.bringToFront()):a.setStyle({color:"#000",weight:1})})},VizMap2.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}},VizMap2.prototype.setState=function(a){this.lMap.setView(a.c,a.z),this.vFrame.setLgndSels(a.l)},VizMap2.prototype.hint=function(){for(var a="",b=PData.eTNum(),c=0;c<b;c++){var d=this.settings.sAtts[c];if(d){0===a.length?a=dlText.markersize:a+=",";var e=PData.aByID(d),f=PData.eTByN(c),g=PData.tByID(f);a+=" "+e.def.l+" ("+g.l+")"}}return a.length>0?a:null},VizMap2.prototype.doOptions=function(){function a(){e&&(b.baseMap.setOpacity(b.bOp/100),b.lOps.forEach(function(a,c){b.mapLayers[c].eachLayer(function(b){b.setOpacity(a/100)})})),f.empty()}var b=this,c=this.bOp,d=[],e=!0,f=jQuery("#dialog-opacities div.layer-list"),g=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");g.find(".op-slider").on("change",function(){c=jQuery(this).val(),b.baseMap.setOpacity(c/100)}),f.append(g),this.settings.lyrs.forEach(function(a,c){var e=b.lOps[c];g=jQuery('<div class="op-layer" data-i="'+c+'">'+a.gid+' <input type=range class="op-slider" min=0 max=100 value='+e+" step=5></div>"),g.find(".op-slider").on("change",function(){var a=jQuery(this).val();d[c]=a,a/=100,b.mapLayers[c].eachLayer(function(b){b.setOpacity(a)})}),d.push(e),f.append(g)});var h=jQuery("#dialog-opacities").dialog({dialogClass:"no-close",height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){e=!1,h.dialog("close"),b.bOp=c,d.forEach(function(a,c){b.lOps[c]=d[c]})}},{text:dlText.cancel,click:function(){h.dialog("close")}}]});h.on("dialogclose",function(b,c){a(),h.off("dialogclose")})};var VizCards=function(a,b){PVizModel.call(this,a,b)};VizCards.prototype=Object.create(PVizModel.prototype),VizCards.prototype.constructor=VizCards,VizCards.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT},VizCards.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(b){if("DIV"===b.target.nodeName||"IMG"===b.target.nodeName){var c=jQuery(b.target).closest("div.card");if(1==c.size()){var d=c.data("ai");if(null!=d){var e=a.toggleSel(d);e?c.addClass("obj-sel"):c.removeClass("obj-sel")}}}}),a.sAtts=[];for(var b=0;b<PData.eTNum();b++){var c=jQuery('#dialog-sortby select[data-ti="'+b+'"] :first').val();a.sAtts.push(c)}for(var b=0;b<PData.eTNum();b++)jQuery('#dialog-sortby select[data-ti="'+b+'"]').val(this.sAtts[b])},VizCards.prototype.render=function(a){var b=this;this.stream=a;var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=a.t.length,w=jQuery(this.frameID);w.empty(),this.recSel.length>0&&(this.recSel=[]),this.preRender();var x,y="w"+this.settings.w+" h"+this.settings.h;for(e=a.t[0],c=0;c<v;){for(;0===e.n;){if(++c===v)return;e=a.t[c]}d=PData.eTByN(c),f=PData.tByID(d),m=b.vFrame.getSelFeatAtts(c),0!==m.length?(i=b.settings.iAtts[c],q=b.settings.cnt[c],null!=i||0!==q.length?(w.append('<div class="template-label">'+f.l+'</div><div class="cards" data-ti="'+c+'"></div>'),x=jQuery('div.cards[data-ti="'+c+'"]'),this.tUsed[c]=!0,g=b.vFrame.getSelLegend(c),h=PData.aByID(g),j=b.sAtts[c],k=PData.aByID(j),l=PData.rTOrder(k,a,c),l.forEach(function(a){n=PData.rByN(a.i),r=n.a[g],"undefined"!=typeof r&&(o=PData.lRecs(r,h,m,!1),o&&(b.rMap[a.i>>4]|=1<<(15&a.i),t=b.settings.lOn?'<div class="card-title">'+n.l+"</div>":"",p=!1,s="",q&&q.length>0&&(u=o.b?' style="color:black"':"",q.forEach(function(a){(r=n.a[a])&&(r=PData.procAttTxt(a,r))&&(p=!0,s+=r+"<br/>")})),s=i&&(r=n.a[i])?p?b.settings.v?'<div class="card-body"><img class="full" src="'+r+'"/>'+s+"</div>":'<div class="card-body flex"><img src="'+r+'"/><div class="card-cnt"'+u+">"+s+"</div></div>":'<div class="card-body flex"><img class="full" src="'+r+'"/></div>':'<div class="card-body"><div class="card-cnt"'+u+">"+s+"</div>",x.append('<div class="card '+y+'" style="background-color:'+o.v+'" data-ai="'+a.i+'">'+t+s+"</div>")))}),e=a.t[++c]):e=a.t[++c]):e=a.t[++c]}},VizCards.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")},VizCards.prototype.rerender=function(a){var b=this,c=jQuery(this.frameID+' div.cards[data-ti="'+a+'"]');c.empty();var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s="w"+this.settings.w+" h"+this.settings.h;d=b.vFrame.getSelFeatAtts(a),0!=d.length&&(e=b.vFrame.getSelLegend(a),f=PData.aByID(e),g=b.settings.iAtts[a],h=b.settings.cnt[a],i=b.sAtts[a],j=PData.aByID(i),k=PData.rTOrder(j,b.stream,a),k.forEach(function(a){l=PData.rByN(a.i),m=l.a[e],"undefined"!=typeof m&&(n=PData.lRecs(m,f,d,!1),n&&(q=b.settings.lOn?'<div class="card-title">'+l.l+"</div>":"",o=!1,p="",h&&h.length>0&&(r=n.b?' style="color:black"':"",h.forEach(function(a){(m=l.a[a])&&(m=PData.procAttTxt(a,m))&&(o=!0,p+=m+"<br/>")})),p=g&&(m=l.a[g])?o?'<div class="card-body"><img src="'+m+'"/><div class="card-cnt"'+r+">"+p+"</div></div>":'<div class="card-body"><img class="full" src="'+m+'"/></div>':'<div class="card-body"><div class="card-cnt"'+r+">"+p+"</div>",c.append('<div class="card '+s+(b.isSel(a.i)?" obj-sel":"")+'" style="background-color:'+n.v+'" data-ai="'+a.i+'">'+q+p+"</div>")))}))},VizCards.prototype.doOptions=function(){var a=this;this.sAtts.forEach(function(a,b){jQuery('#dialog-sortby select[data-ti="'+b+'"]').val(a)});var b=jQuery("#dialog-sortby").dialog({dialogClass:"no-close",height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close");for(var c=0;c<PData.eTNum();c++){var d=jQuery('#dialog-sortby select[data-ti="'+c+'"]').val();d!=a.sAtts[c]&&(a.sAtts[c]=d,a.rerender(c))}}},{text:dlText.cancel,click:function(){b.dialog("close")}}]})},VizCards.prototype.setSel=function(a){var b,c,d=this;this.recSel=a;var e=jQuery(this.frameID).find("div.card");e.each(function(){c=jQuery(this),b=c.data("ai"),null!=b&&(d.isSel(b)?c.addClass("obj-sel"):c.removeClass("obj-sel"))})},VizCards.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],jQuery(this.frameID).find("div.card").removeClass("obj-sel"))},VizCards.prototype.getState=function(){return{l:this.vFrame.getLgndSels(),s:this.sAtts}},VizCards.prototype.setState=function(a){this.vFrame.setLgndSels(a.l),this.sAtts=a.s};var VizPinboard=function(a,b){PVizModel.call(this,a,b)};VizPinboard.prototype=Object.create(PVizModel.prototype),VizPinboard.prototype.constructor=VizPinboard,VizPinboard.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_HSCRL|V_FLAG_VSCRL|V_FLAG_OPT},VizPinboard.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.cAtts[a];return null==b?null:[b]}return[this.settings.cAtts]},VizPinboard.prototype.setup=function(){var a=this.settings,b=this,c=this.vFrame.getIndex();this.bOp=100,this.lOps=[],this.settings.lyrs.forEach(function(a,c){b.lOps.push(100*a.o)});PData.eTNum();this.xScale=d3.scaleLinear().domain([0,a.iw-1]).range([0,a.dw-1]),this.yScale=d3.scaleLinear().domain([0,a.ih-1]).range([0,a.dh-1]),this.xAxis=d3.axisTop(this.xScale),this.yAxis=d3.axisLeft(this.yScale);var d=d3.select(this.frameID).append("svg").attr("width",a.dw+30+3).attr("height",a.dh+30+2);this.chart=d.append("g").attr("transform","translate(30,30)"),this.chart.append("g").attr("class","x axis").call(this.xAxis),this.chart.append("g").attr("class","y axis").call(this.yAxis),this.chart.append("image").attr("id","base-"+c).attr("xlink:href",a.img).attr("x",0).attr("y",0).attr("height",a.dh).attr("width",a.dw),this.settings.lyrs.forEach(function(a,d){b.chart.append("svg").attr("id","ol-"+c+"-"+d).attr("opacity",a.o)}),this.settings.lyrs.forEach(function(a,b){d3.xml(a.url,function(a,d){if(!a){var e=d.getElementsByTagName("svg")[0];d3.select("#ol-"+c+"-"+b).node().appendChild(e)}})}),this.gRecs=this.chart.append("g").attr("id","recs")},VizPinboard.prototype.render=function(a){function b(a,b){var d=c.toggleSel(a.ai);d3.select(this).classed("obj-sel",d)}var c=this;this.gRecs.selectAll(".recobj").remove(),this.gRecs.selectAll(".recline").remove(),this.recSel.length>0&&(this.recSel=[]),this.preRender();var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=a.t.length,y=0;for(d=0;d<x;d++)if("disable"!==this.settings.pAtts[d]){w=[];break}r=this.settings.min,"string"==typeof r&&(r=parseInt(r)),s=this.settings.max,"string"==typeof s&&(s=parseInt(s)),t=s-r;var z=[];d=0,y=-1;a:for(;d<a.l;){if(null==k){do{if(++y===x)break a;f=a.t[y]}while(0===f.n||f.i+f.n===d);if(k=this.vFrame.getSelLocAtts(y),0===k.length){k=null;continue}if(k=k[0],l=c.vFrame.getSelFeatAtts(y),0===l.length){k=null;continue}c.tUsed[y]=!0,i=c.vFrame.getSelLegend(y),j=PData.aByID(i),m=c.settings.pAtts[y],g=c.settings.lClrs[y],p=c.settings.sAtts[y],p&&(q=PData.aByID(p),"number"==typeof q.r.min&&"number"==typeof q.r.max?(u=q.r.min,v=q.r.max-u):p=null)}e=a.s[d],h=PData.rByN(e);var A;w&&(A={id:h.id,c:null,p:h.a[m],l:g}),n=h.a[k],"undefined"!=typeof n&&(o=h.a[i],"undefined"!=typeof o&&(o=PData.lClr(o,j,l),o&&(c.rMap[e>>4]|=1<<(15&e),p?(q=h.a[p],q="number"==typeof q?Math.floor((q-u)*t/v)+r:r):q=r,z.push({ai:e,v:o,x:n[0],y:n[1],r:q}),A&&(A.c=n)))),A&&A.c&&w.push(A),++d==f.i+f.n&&(k=null)}if(this.gRecs.selectAll(".recobj").data(z).enter().append("circle").attr("class","recobj").attr("cx",function(a){return c.xScale(a.x)}).attr("cy",function(a){return c.yScale(a.y)}).attr("r",function(a){return c.yScale(a.r)}).style("fill",function(a){return a.v}).on("click",b),w){w.sort(function(a,b){return PData.strcmp(b.id,a.id)});var B=[];w.forEach(function(a){a.p&&a.p.forEach(function(b){if(d=_.sortedIndex(w,{id:b},"id"),d<w.length){var c=w[d];c.id===b&&B.push({f:a.c,t:c.c,c:a.l})}})}),this.gRecs.selectAll(".recline").data(B).enter().append("line").attr("class","recline").attr("x1",function(a){return c.xScale(a.f[0])}).attr("y1",function(a){return c.yScale(a.f[1])}).attr("x2",function(a){return c.xScale(a.t[0])}).attr("y2",function(a){return c.yScale(a.t[1])}).attr("stroke",function(a){return a.c})}},VizPinboard.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.gRecs.selectAll(".recobj").classed("obj-sel",!1))},VizPinboard.prototype.setSel=function(a){var b=this;this.recSel=a,this.gRecs.selectAll(".recobj").classed("obj-sel",function(a){return b.isSel(a.ai)})},VizPinboard.prototype.doOptions=function(){function a(){f&&(d3.select("#base-"+c).attr("opacity",b.bOp/100),b.lOps.forEach(function(a,b){d3.select("#ol-"+c+"-"+b).attr("opacity",a/100)})),g.empty()}var b=this,c=this.vFrame.getIndex(),d=this.bOp,e=[],f=!0,g=jQuery("#dialog-opacities div.layer-list"),h=jQuery('<div class="op-layer" data-i="-1">Base Image <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");h.find(".op-slider").on("change",function(){d=jQuery(this).val(),d3.select("#base-"+c).attr("opacity",d/100)}),g.append(h),this.lOps.forEach(function(a,b){h=jQuery('<div class="op-layer" data-i="'+b+'">Overlay '+(b+1)+' <input type=range class="op-slider" min=0 max=100 value='+a+" step=5></div>"),h.find(".op-slider").on("change",function(){e[b]=jQuery(this).val(),d3.select("#ol-"+c+"-"+b).attr("opacity",e[b]/100)}),e.push(a),g.append(h)});var i=jQuery("#dialog-opacities").dialog({dialogClass:"no-close",height:300,width:320,modal:!0,buttons:[{text:dlText.ok,click:function(){f=!1,i.dialog("close"),b.bOp=d,e.forEach(function(a,c){b.lOps[c]=a})}},{text:dlText.cancel,click:function(){i.dialog("close")}}]});i.on("dialogclose",function(b,c){a(),i.off("dialogclose")})},VizPinboard.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizPinboard.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizPinboard.prototype.hint=function(){for(var a="",b=PData.eTNum(),c=0;c<b;c++){var d=this.settings.sAtts[c];if(d){0===a.length?a=dlText.markersize:a+=",";var e=PData.aByID(d),f=PData.eTByN(c),g=PData.tByID(f);a+=" "+e.def.l+" ("+g.l+")"}}return a.length>0?a:null};var VizTime=function(a,b){PVizModel.call(this,a,b)};VizTime.prototype=Object.create(PVizModel.prototype),VizTime.prototype.constructor=VizTime,VizTime.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL},VizTime.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.dAtts[a];return null==b?null:[b]}return[this.settings.dAtts]},VizTime.prototype.getWidths=function(){var a={top:2,right:2,bottom:2,left:2},b=[],c=jQuery(this.frameID).width();b.push(c);var d=c-(a.left+a.right);return b.push(d),this.threshold=d/(6.25*this.settings.xLbl),b},VizTime.prototype.setup=function(){function a(a){var b={id:a,l:0,t:0,h:0,w:f[1],svgID:"#tl-b-"+h+"-"+a,tHt:0,iHt:0,xScale:d3.scaleTime(),yScale:function(a){return a*b.tHt},parts:[],g:null,labels:null,labelSVGs:null,redraw:function(){}};if(a?(b.tHt=d.settings.bHt,b.iHt=b.tHt-2):(b.tHt=3,b.iHt=2),1===a){var c=d.minDate,e=d.maxDate;d.settings.zFrom.length>0&&(c=PData.dStr(d.settings.zFrom,!1)),d.settings.zTo.length>0&&(e=PData.dStr(d.settings.zTo,!0)),b.xScale.domain([c,e]),d.zMinDate=c,d.zMaxDate=e}else b.xScale.domain([d.minDate,d.maxDate]);b.xScale.rangeRound([0,b.w]),b.g=d.chart.append("g").attr("id",b.svgID.substring(1)).attr("class","tl-band").attr("width",b.w),d.bands[a]=b,d.cmpnts.push(b)}function b(a){var b=d.bands[a],c=d3.axisBottom(b.xScale);localD3&&c.tickFormat(localD3);var e=b.g.append("g").attr("id","axis-"+h+"-"+a).attr("class","axis").style("font-size","10px"),f={};f.redraw=function(){e.call(c)},b.parts.push(f),d.cmpnts.push(f)}function c(a){var b,c=d.bands[a];b=1===a?32:16;var e={name:"s-"+h+"-"+a,x:function(){return 0},left:function(){return 0},anchor:"start",tDelta:2,whichDate:function(a,b){return a}},f={name:"e-"+h+"-"+a,x:function(){return c.l+c.w},left:function(){return c.l+c.w-d.settings.xLbl},anchor:"end",tDelta:-3,whichDate:function(a,b){return b}};c.labels=[e,f];var g=d3.select(c.svgID).selectAll(".bLblCntr").data(c.labels).enter().append("g").attr("class","bLblCntr");g.append("rect").attr("class","bLbl").attr("id",function(a){return"rect-"+a.name}).attr("x",function(a){return a.left()}).attr("width",d.settings.xLbl).attr("height",b);var i=g.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",12).attr("text-anchor",function(a){return a.anchor}),j={};if(j.redraw=function(){var a=c.xScale.domain(),b=a[0],d=a[1];i.text(function(a){return a.whichDate(b,d).getUTCFullYear()})},c.parts.push(j),d.cmpnts.push(j),1===a){var k=g.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"m-txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",b-4).attr("text-anchor",function(a){return a.anchor}),l={};l.redraw=function(){k.attr("x",function(a){return a.x()+a.tDelta});var a=c.xScale.domain(),b=a[0],e=a[1];k.text(function(a){var c=e.getUTCFullYear()-b.getUTCFullYear();return c>d.threshold?"":months[a.whichDate(b,e).getMonth()]})},c.parts.push(l),d.cmpnts.push(l)}c.labelSVGs=g}var d=this;"number"!=typeof this.settings.xLbl&&(this.settings.xLbl=parseInt(this.settings.xLbl)),this.brush=null,this.brushSVG=null;var e=this.settings;"string"==typeof e.bHt&&(e.bHt=parseInt(e.bHt,10)),function(){var a,b,c,f,g,h;e.dAtts.forEach(function(d){if(null!=d&&"disable"!==d){var e=PData.aByID(d);e&&(null==a||e.r.min.y<a?(a=e.r.min.y,"undefined"!=typeof e.r.min.m?(b=e.r.min.m,c="undefined"!=typeof e.r.min.d?e.r.min.d:1):(b=1,c=1)):e.r.min.y===a&&"undefined"!=typeof e.r.min.m&&(e.r.min.m<b?(b=e.r.min.m,c="undefined"!=typeof e.r.min.d?e.r.min.d:1):e.r.min.m===b&&"undefined"!=typeof e.r.min.d&&e.r.min.d<c&&(c=e.r.min.d)),null==f?"undefined"==typeof e.r.max.y?(f=TODAY.getUTCFullYear(),g=TODAY.getMonth()+1,h=TODAY.getDate()):(f=e.r.max.y,"undefined"!=typeof e.r.max.m?(g=e.r.max.m,h="undefined"!=typeof e.r.max.d?e.r.max.d:PData.lenMnth(f,g)):(g=12,h=31)):e.r.max.y>f?(f=e.r.max.y,"undefined"!=typeof e.r.max.m?(g=e.r.max.m,h="undefined"!=typeof e.r.max.d?e.r.max.d:PData.lenMnth(f,g)):(g=12,h=31)):e.r.max.y===f&&"undefined"!=typeof e.r.max.m&&(e.r.max.m>g?(g=e.r.max.m,h="undefined"!=typeof e.r.max.d?e.r.max.d:PData.lenMnth(f,g)):e.r.max.m===g&&"undefined"!=typeof e.r.max.d&&e.r.max.d>h&&(h=e.r.max.d)))}}),e.from.length>0?d.minDate=PData.dStr(e.from,!1):d.minDate=PData.d3Nums(a,b,c,!1),e.to.length>0?d.maxDate=PData.dStr(e.to,!0):d.maxDate=PData.d3Nums(f,g,h,!0),d.instGap=.015*(d.maxDate-d.minDate)}();var f=d.getWidths(),g=d3.select(this.frameID).append("svg").attr("class","tl-vf").attr("width",f[1]);!function(){var a=[];e.lgnds.forEach(function(b){b.forEach(function(b){a.push(b)})}),a=_.uniq(a);var b=[];a.forEach(function(a){var c=PData.aByID(a);c&&c.l.forEach(function(a){b.push(a.v)})}),b=_.uniq(b),b.sort();var c,d,f=g.append("defs");b.forEach(function(a){d=a.substr(1),c=f.append("linearGradient").attr("id",d+"-fs"),c.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0"),c.append("stop").attr("offset","5%").attr("stop-color",a),c.append("stop").attr("offset","100%").attr("stop-color",a),c=f.append("linearGradient").attr("id",d+"-fe"),c.append("stop").attr("offset","0%").attr("stop-color",a),c.append("stop").attr("offset","95%").attr("stop-color",a),c.append("stop").attr("offset","100%").attr("stop-color","#C0C0C0"),c=f.append("linearGradient").attr("id",d+"-fb"),c.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0"),c.append("stop").attr("offset","5%").attr("stop-color",a),c.append("stop").attr("offset","95%").attr("stop-color",a),c.append("stop").attr("offset","100%").attr("stop-color","#C0C0C0")})}();var h=this.vFrame.getIndex();g.append("clipPath").attr("id","tl-clip-"+h).append("rect").attr("width",f[1]),d.chart=g.append("g").attr("class","chart").attr("clip-path","url(#tl-clip-"+h+")"),d.instRad=e.bHt/2-1,d.bands=Array(2),d.cmpnts=[],a(0),a(1),b(0),b(1),c(0),c(1)},VizTime.prototype.render=function(a){function b(a,b){var c=a.s-b.s;return c<0?1:c>0?-1:(c=b.e-a.e,c<0?1:c>0?-1:0)}function c(a){function b(a){return a.f&EVENT_INSTANT?"event instant":"event range"}function c(a){var b=f.toggleSel(a.ai);d3.select(this).classed("obj-sel",b)}var d,e,g,i,j=f.bands[a];if(a){var k=f.bands[0];j.t=k.t+k.h+37,d=e=g=f.instRad,i=2*f.instRad+3}else j.t=0,d=e=g=1;j.h=h*j.tHt+2,j.g.attr("transform","translate(0,"+j.t+")").attr("height",j.h);var l,m;a&&(l=.75*j.iHt+"px",m=.8*j.iHt);var n;n=d3.select(j.svgID).selectAll(".lgBd").remove(),n=d3.select(j.svgID).selectAll(".lgBd").data(f.lgBds).enter().append("svg").attr("class","lgBd").attr("y",function(a){return j.yScale(a.t)}).attr("height",function(a){return j.yScale(a.h)}),n.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(a){return a.d.v}),1===a&&n.append("text").attr("class","lgBdLbl").attr("x",2).attr("y",m).attr("fill",function(a){return a.d.b?"#000000":"#FFFFFF"}).style("font-size",l).text(function(a){return a.d.l});var o;d3.select(j.svgID).selectAll(".event").remove(),o=d3.select(j.svgID).selectAll(".event").data(f.events).enter().append("svg").attr("class",b).attr("y",function(a){return j.yScale(a.t)}).attr("height",j.iHt),
1===a&&o.on("click",c);var p=d3.select(j.svgID).selectAll(".range");p.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(b){return 1===a&&b.f&(EVENT_F_START|EVENT_F_END)?(b.f&(EVENT_F_START|EVENT_F_END))===(EVENT_F_START|EVENT_F_END)?"url("+b.c.v+"-fb)":(b.f&EVENT_F_START)===EVENT_F_START?"url("+b.c.v+"-fs)":"url("+b.c.v+"-fe)":b.c.v}),1===a&&p.append("text").attr("class","rangeLbl").attr("x",4).attr("y",m).attr("fill",function(a){return a.c.b?"#000000":"#FFFFFF"}).style("font-size",l).text(function(a){return a.l});var q=d3.select(j.svgID).selectAll(".instant");q.append("circle").attr("cx",d).attr("cy",e).attr("r",g).attr("fill",function(a){return a.c.v}),1===a&&q.append("text").attr("class","instantLbl").attr("x",i).attr("y",m).style("font-size",l).text(function(a){return a.l}),j.redraw=function(){n.attr("x",function(a){return j.xScale(a.s)}).attr("width",function(a){return j.xScale(a.e)-j.xScale(a.s)}),o.attr("x",function(a){return j.xScale(a.s)}).attr("width",function(a){return j.xScale(a.e)-j.xScale(a.s)}),j.parts.forEach(function(a){a.redraw()})}}function d(a){var b=f.bands[a];d3.select(b.svgID).selectAll(".axis").attr("transform","translate(0,"+b.h+")")}function e(a){var b=f.bands[a];d3.select(b.svgID).selectAll(".bLblCntr").attr("transform","translate(0,"+(b.h+1).toString()+")")}var f=this,g=this.vFrame.getIndex();this.recSel.length>0&&(this.recSel=[]),this.preRender(),this.events=[],this.lgBds=[];var h=0;!function(){for(var c,d,e,g,i,j,k,l,m,n=a.t.length,o=0;o<n;){for(c=a.t[o];0===c.n;){if(++o==n)return;c=a.t[o]}if(e=f.vFrame.getSelLocAtts(o),0!==e.length)if(e=f.vFrame.getSelFeatAtts(o),0!==e.length){f.tUsed[o]=!0,m=f.vFrame.getSelLegend(o),l=PData.aByID(m),g=f.settings.dAtts[o];for(var p,q,r,s,t,u,v,w,x=[],y=c.i;y<c.i+c.n;y++)d=a.s[y],w=PData.rByN(d),j=w.a[m],"undefined"!=typeof j&&(k=w.a[g])&&"?"!==k&&(u=k.min.f?EVENT_F_START:0,p=k.min.y,"undefined"==typeof k.min.m?(q=1,r=1):(q=k.min.m,r="undefined"==typeof k.min.d?1:k.min.d),s=PData.d3Nums(p,q,r,!1),"undefined"==typeof k.max?s>=f.minDate&&s<=f.maxDate&&(u|=EVENT_INSTANT,t=s.getTime()+f.instGap,(j=PData.lRecs(j,l,e,!1))&&(f.rMap[d>>4]|=1<<(15&d),x.push({s:s,e:t,ai:d,f:u,c:j,l:w.l,t:0}))):("open"===k.max?t=TODAY:(k.max.f&&(u|=EVENT_F_END),p=k.max.y,"undefined"==typeof k.max.m?(q=12,r=31):(q=k.max.m,r="undefined"==typeof k.max.d?PData.lenMnth(p,q):k.max.d),t=PData.d3Nums(p,q,r,!0)),t>=f.minDate&&s<=f.maxDate&&(j=PData.lRecs(j,l,e,!1))&&(f.rMap[d>>4]|=1<<(15&d),x.push({s:s,e:t,ai:d,f:u,c:j,l:w.l,t:0}))));x.sort(b);var z,A=[];x.forEach(function(a){for(z=0;z<A.length&&!(a.e<A[z]);z++);a.t=z+h+1,A[z]=a.s}),i=PData.aByID(g),i.l.forEach(function(a){v=a.d,p=v.min.y,"undefined"==typeof v.min.m?(q=1,r=1):(q=v.min.m,r="undefined"==typeof v.min.d?1:v.min.d),s=PData.d3Nums(p,q,r,!1),"undefined"==typeof v.max.y?t=TODAY:(p=v.max.y,"undefined"==typeof v.max.m?(q=12,r=31):(q=v.max.m,r="undefined"==typeof v.max.d?PData.lenMnth(p,q):v.max.d),t=PData.d3Nums(p,q,r,!0)),f.lgBds.push({s:s,e:t,t:h,h:A.length+1,d:a})}),h+=A.length+1,f.events=f.events.concat(x),o++}else o++;else o++}}();f.getWidths();c(0),c(1),function(){var a,b=f.bands[0];null!=f.brushSVG&&f.brushSVG.remove(),f.brush=d3.brushX(),f.brush.extent([[0,0],[b.w,b.h]]),f.brushSVG=b.g.append("g"),f.brushSVG.attr("class","brush").call(f.brush),a=f.brushSVG.selectAll(".handle--custom").data([{type:"w"},{type:"e"}]).enter().append("path").attr("d",function(a,c){var d=c?1:-1,e=b.h/4;return"M"+.5*d+","+e+"A6,6 0 0 "+c+" "+6.5*d+","+(e+6)+"V"+(3*e-6)+"A6,6 0 0 "+c+" "+.5*d+","+3*e+"ZM"+2.5*d+","+(e+8)+"V"+(3*e-8)+"M"+4.5*d+","+(e+8)+"V"+(3*e-8)}),f.brush.on("start brush end",function(){var c=d3.event.selection;if(null!=c){var d=c.map(b.xScale.invert),e=d.map(d3.timeDay.round);e[0]>=e[1]&&(e[0]=d3.timeDay.floor(d[0]),e[1]=d3.timeDay.ceil(d[1])),f.zMinDate=e[0],f.zMaxDate=e[1],a.attr("display",null).attr("transform",function(a,b){return"translate("+c[b]+",0)"});var g=f.bands[1];g.xScale.domain(e),g.redraw()}}),f.brush.move(f.brushSVG,[b.xScale(f.zMinDate),b.xScale(f.zMaxDate)])}(),function(){var a=f.bands[1],b=a.t+a.h+45;d3.select(f.frameID+" svg.tl-vf").attr("height",b),d3.select("#tl-clip-"+g+" rect").attr("height",b)}(),d(0),d(1),e(0),e(1),f.cmpnts.forEach(function(a){a.redraw()})},VizTime.prototype.resize=function(){var a=this.getWidths(),c=d3.select(this.frameID+" svg.tl-vf");c.attr("width",a[1]),c.select("#tl-clip-"+this.vFrame.getIndex()+" rect").attr("width",a[1]);for(var d=0;d<2;d++){b=this.bands[d],b.w=a[1],c.select(b.svgID).attr("width",a[1]),b.xScale.rangeRound([0,a[1]]);var e=b.labels[1],f=e.x()+e.tDelta;b.labelSVGs.select("#rect-"+e.name).attr("x",e.left()),b.labelSVGs.select("#txt-"+e.name).attr("x",f),0===d&&(this.brush&&this.brushSVG&&(this.brush.extent([[0,0],[b.w,b.h]]),this.brushSVG.call(this.brush),this.brush.move(this.brushSVG,[b.xScale(this.zMinDate),b.xScale(this.zMaxDate)])),b.labelSVGs.select("#m-txt-"+e.name).attr("x",f))}this.cmpnts.forEach(function(a){a.redraw()})},VizTime.prototype.setSel=function(a){function b(a){return c.isSel(a.ai)?a.f&EVENT_INSTANT?"event instant obj-sel":"event range obj-sel":a.f&EVENT_INSTANT?"event instant":"event range"}var c=this;c.recSel=a,d3.select(this.bands[1].svgID).selectAll(".event").attr("class",b)},VizTime.prototype.clearSel=function(){function a(a){return a.f&EVENT_INSTANT?"event instant":"event range"}this.recSel.length>0&&(this.recSel=[],d3.select(this.bands[1].svgID).selectAll(".event").attr("class",a))},VizTime.prototype.getState=function(){var a=this.zMinDate,b=this.zMaxDate,c=a.getUTCMonth()+1,d=a.getUTCFullYear().toString()+"-"+c.toString()+"-"+a.getDate().toString();c=b.getUTCMonth()+1;var e=b.getUTCFullYear().toString()+"-"+c.toString()+"-"+b.getDate().toString();return{d0:d,d1:e,l:this.vFrame.getLgndSels()}},VizTime.prototype.setState=function(a){var b=PData.dStr(a.d0,!1),c=PData.dStr(a.d1,!0),d=this.bands[1];d.xScale.domain([b,c]),this.zMinDate=b,this.zMaxDate=c,this.vFrame.setLgndSels(a.l)};var VizDirectory=function(a,b){PVizModel.call(this,a,b)};VizDirectory.prototype=Object.create(PVizModel.prototype),VizDirectory.prototype.constructor=VizDirectory,VizDirectory.prototype.flags=function(){return V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT},VizDirectory.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(b){if("TD"===b.target.nodeName){var c=jQuery(b.target).closest("tr"),d=c.data("ai");if(null!=d){var e=a.toggleSel(d);e?c.addClass("obj-sel"):c.removeClass("obj-sel")}}else if("TH"===b.target.nodeName){var f=jQuery(b.target),g=f.data("aid"),h=f.closest("table").data("ti"),i=PData.aByID(g);switch(i.def.t){case"T":case"V":case"N":case"D":f.closest("tr").find("th").removeClass("sel"),f.addClass("sel"),a.sAtts[h]=g,a.rerender(h)}}}),a.sAtts=[];for(var b=0;b<PData.eTNum();b++){var c=jQuery('#dialog-sortby select[data-ti="'+b+'"] :first').val();a.sAtts.push(c)}},VizDirectory.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this,n=a.t.length,o=0,p=jQuery(this.frameID);for(p.empty(),this.recSel.length>0&&(this.recSel=[]),this.preRender(),this.stream=a,c=a.t[0];o<n;){for(;0===c.n;){if(++o===n)return;c=a.t[o]}m.tUsed[o]=!0,b=PData.eTByN(o),d=PData.tByID(b),p.append('<div class="template-label">'+d.l+'</div><table cellspacing="0" class="viz-directory" data-ti='+o+"></table>"),e=p.find('table[data-ti="'+o+'"]'),f=m.settings.cnt[o],j=m.sAtts[o],i="<thead><tr>",f.forEach(function(a){var b=PData.aByID(a);i+='<th data-aid="'+a,a===j&&(i+='" class="sel'),i+='">'+b.def.l+"</th>"}),e.append(i+"</tr></thead><tbody></tbody>"),e=e.find("tbody"),k=PData.aByID(j),l=PData.rTOrder(k,m.stream,o),l.forEach(function(a){h=PData.rByN(a.i),m.rMap[a.i>>4]|=1<<(15&a.i),i='<tr data-id="'+h.id+'" data-ai='+a.i+">",f.forEach(function(a){g=h.a[a],"undefined"!=typeof g?(g=PData.procAttTxt(a,g),i+=g?"<td>"+g+"</td>":"<td></td>"):i+="<td></td>"}),e.append(i+"</tr>")}),c=a.t[++o]}},VizDirectory.prototype.rerender=function(a){var b,c,d,e,f,g,h,i=this,j=jQuery(this.frameID+' table.viz-directory[data-ti="'+a+'"] tbody');j.empty(),tRec=this.stream.t[a],b=i.settings.cnt[a],c=i.sAtts[a],d=PData.aByID(c),e=PData.rTOrder(d,i.stream,a),e.forEach(function(a){g=PData.rByN(a.i),h="<tr "+(i.isSel(a.i)?'class="obj-sel" ':"")+'data-id="'+g.id+'" data-ai='+a.i+">",b.forEach(function(a){f=g.a[a],"undefined"!=typeof f?(f=PData.procAttTxt(a,f),h+=f?"<td>"+f+"</td>":"<td></td>"):h+="<td></td>"}),j.append(h+"</tr>")})},VizDirectory.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")},VizDirectory.prototype.doOptions=function(){for(var a=this,b=0;b<PData.eTNum();b++)jQuery('#dialog-sortby select[data-ti="'+b+'"]').val(a.sAtts[b]);var c=jQuery("#dialog-sortby").dialog({dialogClass:"no-close",height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close");for(var b=0;b<PData.eTNum();b++){var d=jQuery('#dialog-sortby select[data-ti="'+b+'"]').val();if(d!==a.sAtts[b]){a.sAtts[b]=d;var e=jQuery(a.frameID+' table[data-ti="'+b+'"] thead tr');e.find("th").removeClass("sel"),e.find('th[data-aid="'+d+'"]').addClass("sel"),a.rerender(b)}}}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})},VizDirectory.prototype.setSel=function(a){var b,c,d=this;this.recSel=a;var e=jQuery(this.frameID).find("tr");e.each(function(){c=jQuery(this),b=c.data("ai"),null!=b&&(d.isSel(b)?c.addClass("obj-sel"):c.removeClass("obj-sel"))})},VizDirectory.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],jQuery(this.frameID).find("tr").removeClass("obj-sel"))},VizDirectory.prototype.getState=function(){return{s:this.sAtts}},VizDirectory.prototype.setState=function(a){this.sAtts=a.s};var VizTextStream=function(a,b){PVizModel.call(this,a,b)};VizTextStream.prototype=Object.create(PVizModel.prototype),VizTextStream.prototype.constructor=VizTextStream,VizTextStream.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL},VizTextStream.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.order[a];return null==b?null:[b]}return _.map(this.settings.order,function(a){return[a]})},VizTextStream.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(b){if("DIV"===b.target.nodeName){var c=jQuery(b.target),d=c.data("ai");if("undefined"!=typeof d&&d>=0){var e=a.toggleSel(d);e?c.addClass("obj-sel"):c.removeClass("obj-sel")}}})},VizTextStream.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this,w=a.t.length,x=0,y=jQuery(this.frameID);for(y.empty(),this.recSel.length>0&&(this.recSel=[]),this.preRender(),t=this.settings.max-this.settings.min,c=a.t[0];x<w;){for(;0===c.n;){if(++x===w)return;c=a.t[x]}m=v.vFrame.getSelLocAtts(x),0!==m.length?(m=v.vFrame.getSelFeatAtts(x),0!==m.length?(v.tUsed[x]=!0,n=v.vFrame.getSelLegend(x),o=PData.aByID(n),y.append('<div class="viz-textstream" data-ti='+x+"></div>"),e=y.find("div.viz-textstream[data-ti="+x+"]"),b=PData.eTByN(x),d=PData.tByID(b),e.append('<div class="template-label">'+d.l+"</div>"),l=v.settings.cnt[x],r=v.settings.sAtts[x],r&&(q=PData.aByID(r),"number"==typeof q.r.min&&"number"==typeof q.r.max?s=q.r.max-q.r.min:r=null),l&&(k=PData.aByID(v.settings.order[x]),j=PData.rTOrder(k,a,x),j.forEach(function(a){f=PData.rByN(a.i),g=f.a[n],"undefined"!=typeof g&&(p=PData.lRecs(g,o,m,!1),p&&(h=f.a[l],h&&(h=PData.procAttTxt(l,h)),h&&(v.rMap[a.i>>4]|=1<<(15&a.i),r?(i=f.a[r],i="number"==typeof i?Math.floor((i-q.r.min)*t/s)+v.settings.min:v.settings.min):i=v.settings.min,u=p.b?";background-color:black":"",e.append('<div class="recitem" data-ai='+a.i+' style="color:'+p.v+u+";font-size:"+i+'px">'+h+"</div>"))))})),x++):x++):x++}},VizTextStream.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")},VizTextStream.prototype.setSel=function(a){var b,c,d=this;this.vFrame.getIndex();this.recSel=a;var e=jQuery(this.frameID).find("div.recitem");e.each(function(){c=jQuery(this),b=c.data("ai"),null!=b&&(d.isSel(b)?c.addClass("obj-sel"):c.removeClass("obj-sel"))})},VizTextStream.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],jQuery(this.frameID).find("div.recitem").removeClass("obj-sel"))},VizTextStream.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizTextStream.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizTextStream.prototype.hint=function(){for(var a,b,c,d,e="",f=PData.eTNum(),g=0;g<f;g++)a=this.settings.order[g],a&&(b=PData.aByID(a),c=PData.eTByN(g),d=PData.tByID(c),e.length>0&&(e+="; "),e+=d.l+": "+dlText.orderedby+" "+b.def.l,a=this.settings.sAtts[g],a&&(b=PData.aByID(a),e+=", "+dlText.textsize+" "+b.def.l));return e};var VizNetWheel=function(a,b){PVizModel.call(this,a,b)};VizNetWheel.prototype=Object.create(PVizModel.prototype),VizNetWheel.prototype.constructor=VizNetWheel,VizNetWheel.prototype.flags=function(){return V_FLAG_OPT|V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL},VizNetWheel.prototype.setup=function(){function a(){var a=b.spin;a>360?a-=360:a<0&&(a+=360),b.spin=a,b.center.attr("transform","translate("+b.cr+","+b.cr+")rotate("+a+")"),b.center.selectAll("g.node text").attr("x",function(b){var c=b.x+a;return c=c>360?c-360:c,c=c<0?c+360:c,c<180&&b.x<180||c>=180&&b.x>=180?b.x<180?"7":"-7":b.x<180?"-7":"7"}).attr("transform",function(b){var c=b.x+a;return c=c>360?c-360:c,c=c<0?c+360:c,c<180&&b.x<180||c>=180&&b.x>=180?"rotate("+(b.x<180?b.x-90:b.x+90)+")":"rotate("+(b.x<180?b.x+90:b.x-90)+")"}).style("text-anchor",function(b){var c=b.x+a;return c=c>360?c-360:c,c=c<0?c+360:c,c<180&&b.x<180||c>=180&&b.x>=180?b.x<180?"start":"end":b.x<180?"end":"start"})}var b=this;this.spin=0,this.prune=!0;var c=this.vFrame.getIndex(),d=_.template(document.getElementById("dltext-v-nwheel").innerHTML);jQuery("#view-frame-"+c+" div.view-controls").append(d({vi:c})),jQuery("#nw-prev-"+c).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-s"}}).click(function(){jQuery("#nw-size-"+c+" :radio:checked").attr("id")=="nw-size-1-"+c?b.spin+=b.inc:b.spin+=90,a()}),jQuery("#nw-for-"+c).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-n"}}).click(function(){jQuery("#nw-size-"+c+" :radio:checked").attr("id")=="nw-size-1-"+c?b.spin-=b.inc:b.spin-=90,a()}),jQuery("#nw-size-"+c).buttonset(),this.svg=d3.select(this.frameID).append("svg"),this.center=this.svg.append("g")},VizNetWheel.prototype.render=function(a){function b(a,b){var c=(a-90)/180*Math.PI,d=b;return[d*Math.cos(c),d*Math.sin(c)]}function c(a){var b=g.toggleSel(a.data.ai);d3.select(this).classed("obj-sel",b)}function d(a){var b=a.data;f.each(function(a){a.data.l=!1}),e.each(function(a){if(a.s===b){a.t.l=!0;for(var c=0;c<h.length;c++){var d=h[c];if(d.s===b&&d.t===a.t){d3.select(this).attr("stroke",d.c).classed("thick",!0),this.parentElement.appendChild(this);break}}}else if(a.t===b){a.s.l=!0;for(var c=0;c<h.length;c++){var d=h[c];if(d.t===b&&d.s===a.s){d3.select(this).attr("stroke",d.c).classed("thick",!0),this.parentElement.appendChild(this);break}}}else d3.select(this).attr("stroke","black").classed("thick",!1)}),f.select("text").attr("fill",function(a){return a.data.l?"white":"black"}),d3.select(this).attr("fill","yellow")}var e,f,g=this,h=[];if(a?this.stream=a:a=this.stream,this.center.selectAll(".node").remove(),this.center.selectAll(".link").remove(),this.recSel.length>0&&(this.recSel=[]),this.preRender(),0===a.l)return void this.svg.attr("width","10").attr("height","10");var i={parent:null,children:[]},j={parent:i,ti:0,children:[]};!function(){var b,c,d,e,f,h,k=0,l=0,m=null;b=a.t[0],h=g.vFrame.getSelLegend(0),f=PData.aByID(h),m=g.vFrame.getSelFeatAtts(0),m.length>0&&b.n>0&&(g.tUsed[0]=!0);a:for(;l<a.l;){for(;0===b.n||b.i+b.n===l||0===m.length;){if(j.children.length>0&&(j.ti=k,i.children.push(j)),++k===a.t.length)break a;j={parent:i,ti:k,children:[]},b=a.t[k],h=g.vFrame.getSelLegend(k),f=PData.aByID(h),m=g.vFrame.getSelFeatAtts(k),m.length>0&&b.n>0&&(g.tUsed[k]=!0)}e=a.s[l],c=PData.rByN(e),d=c.a[h],"undefined"!=typeof d&&(fData=PData.lRecs(d,f,m,!1),fData&&(g.rMap[e>>4]|=1<<(15&e),j.children.push({parent:j,r:c,ai:e,c:fData.v,l:!1,v:-1,children:[]}))),l++}j.children.length>0&&i.children.push(j),j=null}(),i.children.forEach(function(a){var b,c=g.settings.pAtts[a.ti];a.children.forEach(function(a){c.forEach(function(c){b=a.r.a[c.pid],"undefined"!=typeof b&&b.forEach(function(b){var d,e=!1;a:for(var f=0;f<i.children.length;f++)for(var g=i.children[f],j=0;j<g.children.length;j++)if(d=g.children[j],d.r.id==b){e=!0;break a}e&&(a.l=!0,d.l=!0,h.push({s:a,t:d,c:c.clr}))})})})}),this.prune&&i.children.forEach(function(a,b){for(var c=a.children.length-1;c>=0;c--){var d=a.children[c];d.l||(g.rMap[d.ai>>4]&=1<<(15&d.ai)^65535,a.children.splice(c,1))}0===a.children.length&&(g.tUsed[b]=!1)});var k=0;if(i.children.forEach(function(a,b){k+=a.children.length}),this.inc=360/(k+i.children.length),0===k)return void this.svg.attr("width","10").attr("height","10");var l=Math.max((14*k+20)/(2*Math.PI),30),m=this.settings.lw;"string"==typeof m&&(m=parseInt(m)),this.cr=m+12+l;var n=2*this.cr;this.svg.attr("width",n).attr("height",n),this.center.attr("transform","translate("+this.cr+","+this.cr+")");var o=d3.cluster().size([360,l]),p=d3.hierarchy(i);o(p);var q=p.descendants().filter(function(a){return"number"==typeof a.data.ai});q.forEach(function(a,b){a.data.v=b}),f=this.center.selectAll(".node").data(q).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+b(a.x,a.y)+")"}),f.append("circle").attr("r","5").style("fill",function(a){return a.data.c}).on("click",c),f.append("text").attr("dy",".31em").attr("x",function(a){return a.x<180?7:-7}).style("text-anchor",function(a){return a.x<180?"start":"end"}).attr("transform",function(a){return"rotate("+(a.x<180?a.x-90:a.x+90)+")"}).attr("fill","black").text(function(a){return a.data.r.l}).on("click",d),e=this.center.selectAll(".link").data(h).enter().append("path").attr("class","link").attr("stroke","black").attr("d",function(a){var c=q[a.s.v],d=q[a.t.v];return"M"+b(c.x,c.y)+" Q0,0 "+b(d.x,d.y)})},VizNetWheel.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizNetWheel.prototype.setSel=function(a){var b=this;b.recSel=a,this.svg.selectAll(".node circle").attr("class",function(a){return b.isSel(a.data.ai)?"obj-sel":""})},VizNetWheel.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.svg.selectAll(".node circle").attr("class",""))},VizNetWheel.prototype.doOptions=function(){var a=this;jQuery("#prune-nodes").prop("checked",this.prune);var b=jQuery("#dialog-prune").dialog({dialogClass:"no-close",height:150,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close");var c=jQuery("#prune-nodes").prop("checked");a.prune!==c&&(a.prune=c,a.vFrame.upSel([],!1),a.render(null))}},{text:dlText.cancel,click:function(){b.dialog("close")}}]})},VizNetWheel.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizNetWheel.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizNetWheel.prototype.hint=function(){for(var a="",b=this,c=0;c<PData.eTNum();c++){var d=b.settings.pAtts[c];d.forEach(function(b){var c=PData.aByID(b.pid);a.length>0&&(a+=", "),a+='<b><span style="color: '+b.clr+'">'+c.def.l+"</span></b>"})}return a};var VizNetGraph=function(a,b){this.physics=null,this.stream=null,PVizModel.call(this,a,b)};VizNetGraph.prototype=Object.create(PVizModel.prototype),VizNetGraph.prototype.constructor=VizNetGraph,VizNetGraph.prototype.flags=function(){return V_FLAG_OPT|V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL},VizNetGraph.prototype.setup=function(){var a=this;this.svg=d3.select(this.frameID).append("svg");var b=this.settings.s;"string"==typeof b&&(b=parseInt(b),this.settings.s=b),this.svg.attr("width",b).attr("height",b),this.rels=[],this.settings.pAtts.forEach(function(b){for(var c=[],d=0;d<b.length;d++)c.push(!0);a.rels.push(c)})},VizNetGraph.prototype.render=function(a){function b(a){var b=f.toggleSel(a.ai);d3.select(this).classed("obj-sel",b)}function c(a){d3.event.active||f.physics.alphaTarget(.3).restart(),a.fx=a.x,a.fy=a.y}function d(a){a.fx=d3.event.x,a.fy=d3.event.y}function e(a){d3.event.active||f.physics.alphaTarget(0),a.fx=null,a.fy=null}var f=this;if(a?this.stream=a:a=this.stream,this.svg.selectAll(".gnode").remove(),this.svg.selectAll(".glink").remove(),this.recSel.length>0&&(this.recSel=[]),this.preRender(),0!==a.l){var g,h,i,j,k,l,m;i=this.settings.min,"string"==typeof i&&(i=parseInt(i)),j=this.settings.max,"string"==typeof j&&(j=parseInt(j)),k=j-i;var n,o,p,q,r,s,t=[],u=[],v=0,w=0,x=null,y=0;if(function(){var b,c;r=a.t[0],c=f.vFrame.getSelLegend(0),b=PData.aByID(c),x=f.vFrame.getSelFeatAtts(0),x.length>0&&r.n>0&&(f.tUsed[0]=!0);a:for(;v<a.l;){for(;0===r.n||r.i+r.n===v||0===x.length;){if(++w===a.t.length)break a;r=a.t[w],c=f.vFrame.getSelLegend(w),b=PData.aByID(c),x=f.vFrame.getSelFeatAtts(w),x.length>0&&r.n>0&&(f.tUsed[w]=!0),g=f.settings.sAtts[w],g&&(h=PData.aByID(g),"number"==typeof h.r.min&&"number"==typeof h.r.max?(l=h.r.min,m=h.r.max-l):g=null)}s=a.s[v],p=PData.rByN(s),q=p.a[c],"undefined"!=typeof q&&(fData=PData.lRecs(q,b,x,!1),fData&&(f.rMap[s>>4]|=1<<(15&s),g?(h=p.a[g],h="number"==typeof h?Math.floor((h-l)*k/m)+i:i):h=i,t.push({index:y++,x:0,y:0,vx:0,vy:0,fx:null,fy:null,ai:s,t:w,s:h,c:fData.v,r:p}))),v++}}(),0!==y){var z,A,B,C;w=null,r=null,t.forEach(function(b){w!==b.t&&(w=b.t,r=a.t[w],x=f.settings.pAtts[w],C=f.rels[w]),x.forEach(function(a,c){C[c]&&(q=b.r.a[a.pid],"undefined"!=typeof q&&q.forEach(function(c){z=!1;for(var d=0;d<t.length;d++)if(A=t[d],B=PData.strcmp(A.r.id,c),0===B){z=!0;break}z&&u.push({source:b,target:A,index:u.length,c:a.clr})}))})}),n=this.svg.selectAll("line").data(u).enter().append("line").attr("class","glink").style("stroke",function(a){return a.c}),o=this.svg.selectAll("circle").data(t).enter().append("circle").attr("class","gnode").attr("r",function(a){return a.s}).style("fill",function(a){return a.c}).call(d3.drag().on("start",c).on("drag",d).on("end",e)).on("click",b),o.append("title").text(function(a){return a.r.l}),v=this.settings.s,this.physics=d3.forceSimulation().force("center",d3.forceCenter(v/2,v/2)).force("link",d3.forceLink()).force("charge",d3.forceManyBody().distanceMax(v/8)),this.physics.force("link").links(u),j=this.settings.s-i,this.physics.force("bounds",function(){for(var a,b=0,c=t.length;b<c;++b)a=t[b],a.x=Math.max(i,Math.min(a.x,j)),a.y=Math.max(i,Math.min(a.y,j))}),this.physics.nodes(t).on("tick",function(){n.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),o.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}}},VizNetGraph.prototype.teardown=function(){},VizNetGraph.prototype.setSel=function(a){var b=this;b.recSel=a,this.svg.selectAll(".gnode").attr("class",function(a){return b.isSel(a.ai)?"obj-sel gnode":"gnode"})},VizNetGraph.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.svg.selectAll(".gnode").attr("class","gnode"))},VizNetGraph.prototype.doOptions=function(){var a=this,b=120,c=jQuery("#dialog-netgraph > .scroll-container");c.empty(),this.settings.pAtts.forEach(function(d,e){if(d.length>0){b+=18;var f=PData.eTByN(e),g=PData.tByID(f),h=a.rels[e];c.append("<b>"+g.l+"</b><br/>"),d.forEach(function(a,d){b+=18;var f='<input type="checkbox" data-t="'+e+'" data-index="'+d+'"';h[d]&&(f+=' checked="checked"');var g=PData.aByID(a.pid);c.append(f+"/> "+g.def.l+"<br/>")})}});var d=jQuery("#dialog-netgraph").dialog({dialogClass:"no-close",height:b,width:300,modal:!0,buttons:[{text:dlText.ok,click:function(){d.dialog("close");var b=!1;a.settings.pAtts.forEach(function(d,e){d.forEach(function(d,f){var g=c.find('input[data-t="'+e+'"][data-index="'+f+'"]').prop("checked");a.rels[e][f]!==g&&(b=!0,a.rels[e][f]=g)})}),b&&(a.vFrame.upSel([],!1),a.render(null))}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})},VizNetGraph.prototype.getState=function(){return{l:this.vFrame.getLgndSels(),r:JSON.parse(JSON.stringify(this.rels))}},VizNetGraph.prototype.setState=function(a){this.vFrame.setLgndSels(a.l),this.rels=JSON.parse(JSON.stringify(a.r))},VizNetGraph.prototype.hint=function(){for(var a="",b=this,c=0;c<PData.eTNum();c++){var d=b.settings.pAtts[c];d.forEach(function(b){var c=PData.aByID(b.pid);a.length>0&&(a+=", "),a+='<b><span style="color: '+b.clr+'">'+c.def.l+"</span></b>"})}return a};var VizBMatrix=function(a,b){this.stream=null,this.cnx=!1,PVizModel.call(this,a,b)};VizBMatrix.prototype=Object.create(PVizModel.prototype),VizBMatrix.prototype.constructor=VizBMatrix,VizBMatrix.prototype.flags=function(){return V_FLAG_OPT|V_FLAG_LGND|V_FLAG_VSCRL|V_FLAG_HSCRL|V_FLAG_SEL},VizBMatrix.prototype.setup=function(){var a=this;this.rels=[],this.settings.pAtts.forEach(function(b){for(var c=[],d=0;d<b.length;d++)c.push(!0),a.cnx=!0;a.rels.push(c)}),this.svg=d3.select(this.frameID).append("svg")},VizBMatrix.prototype.render=function(a){function b(a){h.toggleSel(a.ai),h.updateNodes(),h.updateLinks()}var c,d,e,f,g,h=this,i=[],j=0,k=0,l=[],m=[],n=[],o=0,p=this.settings.bw,q=this.settings.nr,r=2*q+3,s=p*r+3;if(a?this.stream=a:a=this.stream,this.recSel.length>0&&(this.recSel=[]),this.preRender(),this.svg.selectAll("path").remove(),this.svg.selectAll("svg").remove(),this.svg.selectAll("circle").remove(),this.settings.oAtts.forEach(function(b,n){if(b&&(c=h.vFrame.getSelFeatAtts(n),c.length>0)){d=h.vFrame.getSelLegend(n),e=PData.aByID(d);var t,u=PData.aByID(b);"g"!==u.def.t?(t=h.settings.gr?PData.cRNew(u,!0,!0):PData.cLNew(u,null,!0),PData.cFill(t,b,null,a,n)):(t=[],PData.cFill(t,b,null,a,n));var v=0,w=[],x=0;if(t.forEach(function(a){var b=0;a.i.forEach(function(a){if(g=PData.rByN(a),f=g.a[d],"undefined"!=typeof f&&(f=PData.lClr(f,e,c))){if(h.rMap[a>>4]|=1<<(15&a),l.push({r:g,ai:a,b:v,rI:b,c:f,x:v*s+r*(b%p)+q+1,y:j+28+q+r*Math.floor(b/p)}),h.cnx){var i,k;i=_.sortedIndex(m,{id:g.id},"id"),i<m.length?(k=m[i],k.id===g.id?k.n.push(l.length-1):m.splice(i,0,{id:g.id,ai:a,r:g,n:[l.length-1]})):m.push({id:g.id,ai:a,r:g,n:[l.length-1]})}b++}}),b>0&&(i.push({l:a.l,c:"b-lbl-txt",x:v*s,y:j+13}),v++,x=Math.max(Math.floor(b/p)+1,x),w.push(a))}),v>0){h.tUsed[n]=!0;var y=PData.eTByN(n),z=PData.tByID(y);i.push({l:z.l,c:"t-lbl-txt",x:0,y:j}),k++,j+=33+x*r,o=Math.max(o,v*s)}}}),this.nodes=l,this.rSet=m,k>0){this.svg.attr("width",o).attr("height",j);var t=this.svg.selectAll(".gnode").data(l).enter().append("circle").attr("class","gnode").attr("r",q).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return a.c}).on("click",b);t.append("title").text(function(a){return a.r.l});var u=this.svg.selectAll(".s-lbl").data(i).enter().append("svg").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("height",function(a){return"t-lbl-text"===a.c?14:12}).attr("width",s-2);if(u.append("text").attr("class",function(a){return"s-lbl-text "+a.c}).attr("x",function(a){return 0}).attr("y",function(a){return"t-lbl-text"===a.c?12:10}).text(function(a){return a.l}),this.cnx){m.forEach(function(a){var b=PData.n2T(a.ai);c=h.settings.pAtts[b],c.forEach(function(c,d){h.rels[b][d]&&(f=a.r.a[c.pid],"undefined"!=typeof f&&f.forEach(function(b){var d,e=_.sortedIndex(m,{id:b},"id");e<m.length&&(d=m[e],d.id===b&&a.n.forEach(function(a){d.n.forEach(function(b){n.push({n1:a,n2:b,c:c.clr})})}))}))})});this.svg.selectAll(".bmlink").data(n).enter().append("path").attr("class","bmlink").attr("stroke",function(a){return a.c}).attr("d",function(a){var b=l[a.n1].x,c=l[a.n1].y,d=l[a.n2].x,e=l[a.n2].y,f=(b+d)/2+Math.floor(20*Math.random())-10,g=(c+e)/2+Math.floor(20*Math.random())-10;return"M"+b+" "+c+" Q "+f+" "+g+" "+d+" "+e})}}else this.svg.attr("width","10").attr("height","10");this.links=n},VizBMatrix.prototype.updateLinks=function(){var a=this;this.svg.selectAll(".bmlink").attr("class",function(b){return a.isSel(a.nodes[b.n1].ai)||a.isSel(a.nodes[b.n2].ai)?"on bmlink":"bmlink"})},VizBMatrix.prototype.updateNodes=function(){var a=this;this.svg.selectAll(".gnode").attr("class",function(b){return a.isSel(b.ai)?"gnode obj-sel":"gnode"})},VizBMatrix.prototype.setSel=function(a){this.recSel=a,this.updateNodes(),this.updateLinks()},VizBMatrix.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.svg.selectAll(".gnode").attr("class","gnode"),this.svg.selectAll(".bmlink").attr("class","bmlink"))},VizBMatrix.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizBMatrix.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizBMatrix.prototype.doOptions=function(){var a=this,b=120,c=jQuery("#dialog-netgraph > .scroll-container");c.empty(),this.settings.pAtts.forEach(function(d,e){if(d.length>0){b+=18;var f=PData.eTByN(e),g=PData.tByID(f),h=a.rels[e];c.append("<b>"+g.l+"</b><br/>"),d.forEach(function(a,d){b+=18;var f='<input type="checkbox" data-t="'+e+'" data-index="'+d+'"';h[d]&&(f+=' checked="checked"');var g=PData.aByID(a.pid);c.append(f+"/> "+g.def.l+"<br/>")})}});var d=jQuery("#dialog-netgraph").dialog({dialogClass:"no-close",height:b,width:300,modal:!0,buttons:[{text:dlText.ok,click:function(){d.dialog("close"),a.cnx=!1;var b=!1;a.settings.pAtts.forEach(function(d,e){d.forEach(function(d,f){var g=c.find('input[data-t="'+e+'"][data-index="'+f+'"]').prop("checked");a.rels[e][f]!==g&&(b=!0,a.rels[e][f]=g),g&&(a.cnx=!0)})}),b&&(a.vFrame.upSel([],!1),a.render(null))}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})},VizBMatrix.prototype.hint=function(){var a,b,c,d="";for(a=0;a<PData.eTNum();a++)if(b=this.settings.oAtts[a],null!==b){var e=PData.eTByN(a),f=PData.tByID(e);c=PData.aByID(b),d.length>0&&(d+="; "),d+="<b>"+f.l+"</b>: "+c.def.l}for(d+="<br/>",pCnt=0,a=0;a<PData.eTNum();a++){var g=this.settings.pAtts[a];g.forEach(function(a,b){c=PData.aByID(a.pid),pCnt++>0&&(d+=", "),d+='<b><span style="color: '+a.clr+'">'+c.def.l+"</span></b>"})}return d},PFilterModel.prototype.isDirty=function(a){var b=this.dirty;return null!==a&&(this.dirty=a,b<2&&a>1&&this.id>1&&jQuery("body").trigger("prsp-fdirty",{id:this.id})),this.dirty},PFilterModel.prototype.title=function(){return this.att.def.l},PFilterModel.prototype.evalPrep=function(){},PFilterModel.prototype.evalDone=function(){},PFilterModel.prototype.insertPt=function(){return jQuery('div.filter-instance[data-id="'+this.id+'"] div.filter-body')},PFilterModel.prototype.teardown=function(){},PFilterModel.prototype.getState=function(){return{}},PFilterModel.prototype.setState=function(a){};var PFilterRemove=function(a){PFilterModel.call(this,a,null)};PFilterRemove.prototype=Object.create(PFilterModel.prototype),PFilterRemove.prototype.constructor=PFilterRemove,PFilterRemove.prototype.title=function(){return dlText.rha},PFilterRemove.prototype.eval=function(a){return!1},PFilterRemove.prototype.setup=function(){var a=this.insertPt(),b=document.getElementById("dltext-filter-remove").innerHTML;a.append(b)};var PFilterText=function(a,b){PFilterModel.call(this,a,b)};PFilterText.prototype=Object.create(PFilterModel.prototype),PFilterText.prototype.constructor=PFilterText,PFilterText.prototype.evalPrep=function(){var a=this.insertPt();switch(this.cs=a.find("input.filter-text-cs").prop("checked"),this.s=a.find("input.filter-text").val(),this.o=a.find("select.filter-text-ops").val(),this.o){case"c":case"x":this.cs||(this.s=this.s.toLocaleLowerCase());break;case"r":this.s=new RegExp(this.s)}},PFilterText.prototype.eval=function(a){var b=this.s;if(null==b||""===b)return!0;var c=a.a[this.att.id];if("undefined"==typeof c)return!1;switch(this.o){case"c":return this.cs||(c=c.toLocaleLowerCase()),c.indexOf(b)!==-1;case"x":return this.cs||(c=c.toLocaleLowerCase()),c===b;case"r":return b.test(c)}return!1},PFilterText.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-text").innerHTML;b.append(c),b.find("input.filter-text").change(function(){a.isDirty(2)}),b.find("select.filter-text-ops").change(function(){
var c=b.find("input.filter-text").val();c.length&&a.isDirty(2)}),b.find("input.filter-text-cs").click(function(c){var d=b.find("input.filter-text").val();d.length&&a.isDirty(2)})},PFilterText.prototype.teardown=function(){var a=this.insertPt();a.find("input.filter-text").off("change"),a.find("input.filter-text-ops").off("change"),a.find("input.filter-text-cs").off("change")},PFilterText.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val(),o:a.find("select.filter-text-ops").val()}},PFilterText.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-text-cs").prop("checked",a.cs),b.find("input.filter-text").val(a.t),"undefined"==typeof a.o?b.find("select.filter-text-ops").val("c"):b.find("select.filter-text-ops").val(a.o)};var PFilterTags=function(a,b){PFilterModel.call(this,a,b)};PFilterTags.prototype=Object.create(PFilterModel.prototype),PFilterTags.prototype.constructor=PFilterTags,PFilterTags.prototype.evalPrep=function(){var a=this.insertPt();switch(this.cs=a.find("input.filter-text-cs").prop("checked"),this.s=a.find("input.filter-text").val(),this.o=a.find("select.filter-text-ops").val(),this.o){case"c":case"x":this.cs||(this.s=this.s.toLocaleLowerCase());break;case"r":this.s=new RegExp(this.s)}},PFilterTags.prototype.eval=function(a){var b=this.s;if(null==b||""===b)return!0;var c=a.a[this.att.id];if("undefined"==typeof c)return!1;for(var d=this.cs,e=this.o,f=0;f<c.length;f++){var g=c[f];switch(e){case"c":if(d||(g=g.toLocaleLowerCase()),g.indexOf(b)!==-1)return!0;break;case"x":if(d||(g=g.toLocaleLowerCase()),g===b)return!0;break;case"r":if(b.test(g))return!0}}return!1},PFilterTags.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-tags").innerHTML;b.append(c),b.find("input.filter-text").change(function(){a.isDirty(2)}),b.find("select.filter-text-ops").change(function(c){var d=b.find("input.filter-text").val();d.length&&a.isDirty(2)}),b.find("input.filter-text-cs").click(function(c){var d=b.find("input.filter-text").val();d.length&&a.isDirty(2)})},PFilterTags.prototype.teardown=function(){var a=this.insertPt();a.find("input.filter-text").off("change"),a.find("input.filter-text-ops").off("change"),a.find("input.filter-text-cs").off("click")},PFilterTags.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val(),o:a.find("select.filter-text-ops").val()}},PFilterTags.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-text-cs").prop("checked",a.cs),b.find("input.filter-text").val(a.t),"undefined"!=typeof a.p?a.p?b.find("select.filter-text-ops").val("c"):b.find("select.filter-text-ops").val("x"):b.find("select.filter-text-ops").val(a.o)};var PFilterVocab=function(a,b){PFilterModel.call(this,a,b)};PFilterVocab.prototype=Object.create(PFilterModel.prototype),PFilterVocab.prototype.constructor=PFilterVocab,PFilterVocab.prototype.evalPrep=function(){var a=this;this.sel=[];var b=this.insertPt().find("div.filter-vocab-row input:checked");b.each(function(){var b=jQuery(this).parent().data("id");b&&a.sel.push(b)}),this.sel.sort(),this.ctrs=new Uint16Array(this.sel.length);for(var c=0;c<this.sel.length;c++)this.ctrs[c]=0},PFilterVocab.prototype.eval=function(a){if(0===this.sel.length)return!1;var b=a.a[this.att.id];if("undefined"==typeof b)return!1;for(var c,d,e=0;e<b.length;e++)if(d=b[e],c=_.sortedIndex(this.sel,d),this.sel[c]===d)return this.ctrs[c]++,!0;return!1},PFilterVocab.prototype.evalDone=function(a){var b,c,d,e,f=this,g=this.insertPt().find("div.filter-vocab-row");g.each(function(){e=jQuery(this),b=e.data("id"),b&&(c=_.sortedIndex(f.sel,b),d=f.sel[c]===b&&a>0?Math.round(100*f.ctrs[c]/a):0,e.next().width(d+"%"))})},PFilterVocab.prototype.setup=function(){var a=this,b='<div class="filter-vocab-container"><div class="filter-vocab-hsa"><input type="checkbox" checked="checked" data-index=-1><i> '+dlText.sha+"</i></div>";this.att.l.forEach(function(a,c){b+='<div class="filter-vocab-entry" data-index="'+c+'"><div class="filter-vocab-row" data-id="'+a.l+'"><input type="checkbox" class="term-parent" checked="checked">'+a.l+'</div><div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>',a.z.forEach(function(d,e){b+='<div class="filter-vocab-row" data-id="'+d.l+'"><input type="checkbox" data-parent="'+c+'" checked="checked">'+d.l+"</div>",b+=null==d.v||""===d.v?'<div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>':'<div class="filter-vocab-bar" style="background-color:'+d.v+'"></div>'}),b+="</div>"});var c=this.insertPt();c.append(b+"</div>"),c.click(function(b){var d=b.target;if("INPUT"===d.nodeName){if("undefined"!=typeof d.dataset.index&&d.dataset.index==-1){var e=d.checked,f=c.find("div.filter-vocab-row input");f.prop("checked",e)}else if("term-parent"===b.target.className&&d.checked){var g=b.target.parentElement.parentElement.dataset.index;c.find('input[data-parent="'+g+'"]').prop("checked",!0)}a.isDirty(2)}})},PFilterVocab.prototype.teardown=function(){this.insertPt().off("click")},PFilterVocab.prototype.getState=function(){var a=[],b=this.insertPt().find("div.filter-vocab-row input:checked");return b.each(function(){var b=jQuery(this).parent().data("id");b&&a.push(b)}),a.sort(),{s:a}},PFilterVocab.prototype.setState=function(a){var b=this.insertPt().find("div.filter-vocab-row");b.each(function(){var b=jQuery(this),c=b.data("id"),d=_.indexOf(a.s,c,!0);b.find("input").prop("checked",d!==-1)})};var PFilterNum=function(a,b){PFilterModel.call(this,a,b)};PFilterNum.prototype=Object.create(PFilterModel.prototype),PFilterNum.prototype.constructor=PFilterNum,PFilterNum.prototype.refreshBoxes=function(){var a=this.insertPt();a.find(".from").removeClass("error").val(this.min),a.find(".to").removeClass("error").val(this.max),a.find(".filter-update").prop("disabled",!0)},PFilterNum.prototype.evalBoxes=function(a){function b(b,c){function d(){k=!0,a.find(b).addClass("error")}function i(){a.find(b).removeClass("error")}var j,k=!1,l=a.find(b),m=l.val(),n=f.exec(m);return n?(i(),j=parseInt(n[1],10)):d(),k||(0==c?null!==g&&j<g&&d():null!==h&&j>h&&d()),e.uNums[c]=j,k}var c,d,e=this,f=/^(\d+)$/,g="undefined"==typeof this.att.r.min?null:this.att.r.min,h="undefined"==typeof this.att.r.max?null:this.att.r.max;return c=b(".from",0),d=b(".to",1),this.uNums[0]>this.uNums[1]&&(d=!0),a.find(".filter-update").prop("disabled",c||d),!(c||d)},PFilterNum.prototype.useBoxes=function(a,b){if(this.evalBoxes(a)){if(this.min=this.uNums[0],this.max=this.uNums[1],null!==this.rCats){var c,d;for(c=0;c<this.rCats.length&&!(this.min>=this.rCats[c].min&&this.min<=this.rCats[c].max);c++);for(d=c;d<this.rCats.length&&!(this.max<=this.rCats[d].max);d++);d=d===this.rCats.length?this.rCats.length-1:d,this.b0=c,this.b1=d,this.brushg.call(this.brush.move,[c,d+1].map(this.xScale))}a.find(".filter-update").prop("disabled",!0),b&&this.isDirty(2)}},PFilterNum.prototype.evalPrep=function(){if(null!==this.rCats)for(var a=0;a<this.rCats.length;a++)this.ctrs[a]=0},PFilterNum.prototype.eval=function(a){var b=a.a[this.att.id];if("undefined"==typeof b)return!1;if("?"===b)return this.u;if(b<this.min||b>this.max)return!1;if(null===this.rCats)return!0;for(var c,d=this.b0;d<=this.b1;d++)if(c=this.rCats[d],c.min<=b&&b<=c.max){this.ctrs[d]++;break}return!0},PFilterNum.prototype.evalDone=function(a){if(null!==this.rCats){for(var b=this,c=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,d=new Uint16Array(this.ctrs.length),e=0;e<this.ctrs.length;e++)d[e]=a>0?Math.round(100*this.ctrs[e]/a):0;this.chart.selectAll(".bar").transition().duration(500).attr("height",function(a,e){return c-b.yScale(d[e])}).attr("y",function(a,c){return b.yScale(d[c])})}},PFilterNum.prototype.setup=function(){function a(a,b){var c=b?1:-1,d=h/4;return"M"+.5*c+","+d+"A6,6 0 0 "+b+" "+6.5*c+","+(d+6)+"V"+(3*d-6)+"A6,6 0 0 "+b+" "+.5*c+","+3*d+"ZM"+2.5*c+","+(d+8)+"V"+(3*d-8)+"M"+4.5*c+","+(d+8)+"V"+(3*d-8)}function b(){var a,b=d3.event.selection;if(null!=b)if(d3.event.sourceEvent&&"brush"!==d3.event.type){if("end"===d3.event.type){if(f)return;f=!0;var d=b.map(c.invert);if(d[0]>d[1]){var g=d[0];d[0]=d[1],d[1]=g}d[0]=Math.floor(d[0]),d[1]=Math.min(Math.ceil(d[1]),e.rCats.length),e.b0=d[0],e.b1=d[1]-1;var a=d.map(c);e.brush.move(e.brushg,a),e.cHs.attr("display",null).attr("transform",function(b,c){return"translate("+a[c]+",0)"}),e.min=e.rCats[e.b0].min,e.max=e.rCats[e.b1].max,e.refreshBoxes(),f=!1,e.isDirty(2)}}else e.cHs.attr("display",null).attr("transform",function(a,c){return"translate("+b[c]+",0)"})}var c,d,e=this,f=!1;this.u=!1,this.uNums=new Array(2);var g=this.insertPt();if(g.append(document.getElementById("dltext-filter-nums").innerHTML),"undefined"==typeof this.att.r.u?g.find(".allow-undef").prop("disabled",!0):g.find(".allow-undef").click(function(){e.u=g.find("input.allow-undef").prop("checked"),e.isDirty(2)}),this.rCats=PData.cRNew(this.att,!1,!1),null!==this.rCats){this.ctrs=new Uint16Array(this.rCats.length);this.b0=0,this.b1=this.rCats.length-1,this.min=this.rCats[0].min,this.max=this.rCats[this.b1].max;var h=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,i=0;this.rCats.forEach(function(a){i=Math.max(i,a.l.length)}),i=Math.max(D3FG_BAR_WIDTH,7*i);var j=this.rCats.length*i;c=d3.scaleLinear().domain([0,this.rCats.length]).range([0,j]),this.xScale=c;var k=d3.scaleLinear().domain([0,100]).range([h,0]);this.yScale=k,d=d3.scaleBand().domain(this.rCats.map(function(a){return a.l})).range([0,j]);var l=d3.axisLeft(k).ticks(4),m=d3.axisBottom(d),n=d3.select(g.get(0)).append("svg").attr("width",j+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",h+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");this.chart=n,n.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(m),n.append("g").attr("class","y axis").call(l),n.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,b){return c(b)+2}).attr("y",function(a){return k(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return h-k(100)}).attr("width",i-4),this.brush=d3.brushX(),this.brush.extent([[0,-1],[j,h+2]]),this.brushg=n.append("g"),this.brushg.attr("class","brush").call(this.brush),this.cHs=this.brushg.selectAll(".handle--custom").data([{type:"w"},{type:"e"}]).enter().append("path"),this.cHs.attr("d",a),this.brush.on("brush end",b),this.brush.move(this.brushg,[0,j])}else this.min="undefined"==typeof att.r.min?0:att.r.min,this.max="undefined"==typeof att.r.max?100:att.r.max;this.refreshBoxes(),g.find("input[type=text]").change(function(){e.evalBoxes(g)}),g.find(".filter-update").click(function(){e.useBoxes(g,!0)})},PFilterNum.prototype.teardown=function(){this.brush.on("brush end",null);var a=this.insertPt();a.find("input").off("change"),a.find(".allow-undef").off("click"),a.find(".filter-update").off("click")},PFilterNum.prototype.getState=function(){return{min:this.min,max:this.max,u:this.u}},PFilterNum.prototype.setState=function(a){var b=this.insertPt();b.find("input.allow-undef").prop("checked",a.u),this.u=a.u,b.find(".from").removeClass("error").val(a.min),b.find(".to").removeClass("error").val(a.max),this.useBoxes(b,!1)};var PFilterDates=function(a,b,c){PFilterModel.call(this,a,b,c)};PFilterDates.prototype=Object.create(PFilterModel.prototype),PFilterDates.prototype.constructor=PFilterDates,PFilterDates.prototype.refreshBoxes=function(){function a(a,c){var d=a.getUTCFullYear(),e=a.getUTCMonth()+1,f=a.getUTCDate();b.find(c+"-y").removeClass("error").val(d),b.find(c+"-m").removeClass("error").val(e),b.find(c+"-d").removeClass("error").val(f)}var b=this.insertPt();a(this.min,".from"),a(this.max,".to"),b.find(".filter-update").prop("disabled",!0)},PFilterDates.prototype.evalBoxes=function(a){function b(b,c){function d(c){i=!0,a.find(b+c).addClass("error")}function h(c){a.find(b+c).removeClass("error")}var i=!1,j={y:0,m:0,d:0,ms:null},k=a.find(b+"-y"),l=k.val(),m=f.exec(l);return m?(h("-y"),j.y=parseInt(m[1],10)):d("-y"),k=a.find(b+"-m"),l=k.val(),m=g.exec(l),m?(j.m=parseInt(m[1],10),j.m<1||j.m>12?d("-m"):h("-m")):d("-m"),k=a.find(b+"-d"),l=k.val(),m=g.exec(l),m?(j.d=parseInt(m[1],10),j.d<1||j.d>31?d("-d"):h("-d")):d("-d"),i||(j.ms=PData.d3Nums(j.y,j.m,j.d,!1),0==c?j.ms<e.rCats[0].min&&(d("-y"),d("-m"),d("-d")):j.ms>e.rCats[e.rCats.length-1].max&&(d("-y"),d("-m"),d("-d"))),e.uDates[c]=j,i}var c,d,e=this,f=/^(-?\d+)$/,g=/^(\d{1,2})$/;return c=b(".from",0),d=b(".to",1),this.uDates[0].ms>this.uDates[1].ms&&(d=!0),a.find(".filter-update").prop("disabled",c||d),!(c||d)},PFilterDates.prototype.useBoxes=function(a,b){if(this.evalBoxes(a)){this.min=this.uDates[0].ms,this.max=this.uDates[1].ms;var c,d;for(c=0;c<this.rCats.length&&!(this.min<this.rCats[c].max);c++);for(d=c;d<this.rCats.length&&!(this.max<=this.rCats[d].max);d++);d=d===this.rCats.length?this.rCats.length-1:d,this.b0=c,this.b1=d,this.brushg.call(this.brush.move,[c,d+1].map(this.xScale)),a.find(".filter-update").prop("disabled",!0),b&&this.isDirty(2)}},PFilterDates.prototype.evalPrep=function(){this.c=jQuery("input[name=dctrl-"+this.id+"]:checked").val();for(var a=0;a<this.rCats.length;a++)this.ctrs[a]=0},PFilterDates.prototype.eval=function(a){function b(a,b,c,d,e){return"undefined"!=typeof d.m&&(b=d.m,"undefined"!=typeof d.d&&(c=d.d)),PData.d3Nums(a,b,c,e)}var c=a.a[this.att.id];if("undefined"==typeof c)return!1;if("?"===c)return this.u;if("undefined"==typeof c.max){var d=b(c.min.y,1,1,c.min,!1);if(d<this.min||d>=this.max)return!1}else{var e,d=b(c.min.y,1,1,c.min,!1);if(e="open"===c.max?TODAY:b(c.max.y,12,31,c.max,!0),"o"===this.c){if(e<this.min||d>=this.max)return!1}else if(this.min>d||e>this.max)return!1}for(var f,g=this.b0;g<=this.b1;g++)if(f=this.rCats[g],f.min<=d&&d<f.max)return this.ctrs[g]+=1,!0;return!1},PFilterDates.prototype.evalDone=function(a){for(var b=this,c=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,d=new Uint16Array(this.ctrs.length),e=0;e<this.ctrs.length;e++)d[e]=a>0?Math.round(100*this.ctrs[e]/a):0;this.chart.selectAll(".bar").transition().duration(500).attr("height",function(a,e){return c-b.yScale(d[e])}).attr("y",function(a,c){return b.yScale(d[c])})},PFilterDates.prototype.setup=function(){function a(a,b){var c=b?1:-1,d=g/4;return"M"+.5*c+","+d+"A6,6 0 0 "+b+" "+6.5*c+","+(d+6)+"V"+(3*d-6)+"A6,6 0 0 "+b+" "+.5*c+","+3*d+"ZM"+2.5*c+","+(d+8)+"V"+(3*d-8)+"M"+4.5*c+","+(d+8)+"V"+(3*d-8)}function b(){var a,b=d3.event.selection;if(null!=b)if(d3.event.sourceEvent&&"brush"!==d3.event.type){if("end"===d3.event.type){if(f)return;f=!0;var c=b.map(e.xScale.invert);if(c[0]>c[1]){var d=c[0];c[0]=c[1],c[1]=d}c[0]=Math.floor(c[0]),c[1]=Math.min(Math.ceil(c[1]),e.rCats.length),e.b0=c[0],e.b1=c[1]-1,a=c.map(e.xScale),e.brush.move(e.brushg,a),e.cHs.attr("display",null).attr("transform",function(b,c){return"translate("+a[c]+",0)"}),e.min=e.rCats[e.b0].min,e.max=e.rCats[e.b1].max,e.refreshBoxes(),f=!1,e.isDirty(2)}}else e.cHs.attr("display",null).attr("transform",function(a,c){return"translate("+b[c]+",0)"})}var c,d,e=this,f=!1;this.rCats=PData.cRNew(this.att,!1,!1),this.ctrs=new Uint16Array(this.rCats.length),this.b0=0,this.b1=this.rCats.length-1,this.u=!1,this.min=this.rCats[0].min,this.max=this.rCats[this.b1].max,this.uDates=new Array(2);var g=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,h=this.insertPt(),i=0;this.rCats.forEach(function(a){i=Math.max(i,a.l.length)}),i=Math.max(D3FG_BAR_WIDTH,7*i);var j=this.rCats.length*i;c=d3.scaleLinear().domain([0,this.rCats.length]).range([0,j]),this.xScale=c;var k=d3.scaleLinear().domain([0,100]).range([g,0]);this.yScale=k,d=d3.scaleBand().domain(this.rCats.map(function(a){return a.l})).range([0,j]);var l=d3.axisLeft(k).ticks(4),m=d3.axisBottom(d),n=_.template(document.getElementById("dltext-filter-dates").innerHTML);h.append(n({id:this.id})),h.find("input[name=dctrl-"+e.id+"]").change(function(){e.isDirty(2)}),"undefined"==typeof this.att.r.u?h.find(".allow-undef").prop("disabled",!0):h.find(".allow-undef").click(function(){e.u=h.find("input.allow-undef").prop("checked"),e.isDirty(2)}),this.refreshBoxes(),h.find("input[type=text]").change(function(){e.evalBoxes(h)}),h.find(".filter-update").click(function(){e.useBoxes(h,!0)});var o=d3.select(h.get(0)).append("svg").attr("width",j+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",g+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");this.chart=o,o.append("g").attr("class","x axis").attr("transform","translate(0,"+g+")").call(m),o.append("g").attr("class","y axis").call(l),o.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,b){return c(b)+2}).attr("y",function(a){return k(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return g-k(100)}).attr("width",i-4),this.brush=d3.brushX(),this.brush.extent([[0,-1],[j,g+2]]),this.brushg=o.append("g"),this.brushg.attr("class","brush").call(this.brush),this.cHs=this.brushg.selectAll(".handle--custom").data([{type:"w"},{type:"e"}]).enter().append("path"),this.cHs.attr("d",a),this.brush.on("brush end",b),this.brush.move(this.brushg,[0,j])},PFilterDates.prototype.teardown=function(){this.brush.on("brush end",null);var a=this.insertPt();a.find("input").off("change"),a.find(".allow-undef").off("click"),a.find(".filter-update").off("click")},PFilterDates.prototype.getState=function(){function a(a){return a.getUTCFullYear()+"-"+(a.getUTCMonth()+1)+"-"+a.getUTCDate()}var b=jQuery("input[name=dctrl-"+this.id+"]:checked").val();return{min:a(this.min),max:a(this.max),c:b,u:this.u}},PFilterDates.prototype.setState=function(a){function b(a,b){var d=b.split("-"),e=0;4===d.length?(c.find(a+"-y").removeClass("error").val("-"+d[1]),e=1):c.find(a+"-y").removeClass("error").val(d[0]),c.find(a+"-m").removeClass("error").val(d[++e]),c.find(a+"-d").removeClass("error").val(d[++e])}var c=this.insertPt();jQuery('input[name="dctrl-'+this.id+'"]').val([a.c]),c.find("input.allow-undef").prop("checked",a.u),this.u=a.u,b(".from",a.min),b(".to",a.max),this.useBoxes(c,!1)};var PFilterPtr=function(a,b){PFilterModel.call(this,a,b)};PFilterPtr.prototype=Object.create(PFilterModel.prototype),PFilterPtr.prototype.constructor=PFilterPtr,PFilterPtr.prototype.evalPrep=function(){var a=this.insertPt();switch(this.cs=a.find("input.filter-text-cs").prop("checked"),this.s=a.find("input.filter-text").val(),this.o=a.find("select.filter-text-ops").val(),this.o){case"c":case"x":this.cs||(this.s=this.s.toLocaleLowerCase());break;case"r":this.s=new RegExp(this.s)}},PFilterPtr.prototype.eval=function(a){var b,c,d=this.s;if(null==d||""===d)return!0;var e=a.a[this.att.id];if("undefined"==typeof e||0===e.length)return!1;for(var f=this.o,g=this.cs,h=0;h<e.length;h++)switch(c=PData.rByID(e[h]),b=c.l,f){case"c":if(g||(b=b.toLocaleLowerCase()),b.indexOf(d)!==-1)return!0;break;case"x":if(g||(b=b.toLocaleLowerCase()),b===d)return!0;break;case"r":if(d.test(b))return!0}return!1},PFilterPtr.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-ptr").innerHTML;b.append(c),b.find("input.filter-text").change(function(){a.isDirty(2)}),b.find("select.filter-text-ops").change(function(){var c=b.find("input.filter-text").val();c.length&&a.isDirty(2)}),b.find("input.filter-text-cs").click(function(c){var d=b.find("input.filter-text").val();d.length&&a.isDirty(2)})},PFilterPtr.prototype.teardown=function(){var a=this.insertPt();a.find("input.filter-text").off("change"),a.find("input.filter-text-ops").off("change"),a.find("input.filter-text-cs").off("click")},PFilterPtr.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val(),o:a.find("select.filter-text-ops").val()}},PFilterPtr.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-text-cs").prop("checked",a.cs),b.find("input.filter-text").val(a.t),"undefined"==typeof a.o?b.find("select.filter-text-ops").val("c"):b.find("select.filter-text-ops").val(a.o)};var PData=function(){function rChunk(a,b,c){jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_records",tmplt_id:prspdata.t[a].id,from:b,count:c},success:function(b,d,e){var f=recs[a],g=JSON.parse(b);f.d?f.d=f.d.concat(g):f.d=g,f.n+=c,rLoad()},error:function(a,b,c){alert(c)}})}function rLoad(){for(var a=!0,b=0;b<prspdata.t.length;b++){var c=recs[b].n,d=prspdata.t[b].n;if(c<d){a=!1;var e=d-c,f=e<LOAD_DATA_CHUNK?e:LOAD_DATA_CHUNK;rChunk(b,c,f);break}}a&&(loaded=!0,setTimeout(function(){jQuery("body").trigger("prsp-loaded")},100))}var LOAD_DATA_CHUNK=1e3,dltextTo,dltextApprox,dltextNow,mnthDays=[31,28,31,30,31,30,31,31,30,31,30,31],recs=[],rCount=0,loaded=!1;return{init:function(){dltextTo=document.getElementById("dltext-to").innerHTML,dltextApprox=document.getElementById("dltext-approximately").innerHTML,dltextNow=document.getElementById("dltext-now").innerHTML,"number"==typeof prspdata.x.chunk&&prspdata.x.chunk>0&&(LOAD_DATA_CHUNK=prspdata.x.chunk),prspdata.t.forEach(function(a){var b={i:rCount,n:0,d:null};recs.push(b),rCount+=a.n}),rLoad()},rSize:function(){return rCount},intersect:function(a,b){for(var c,d,e=[],f=a.length,g=b.length,h=0,i=0;h<f&&i<g;)c=a[h],d=b[i],c>d?i++:d>c?h++:(e.push(c),h++,i++);return e},union:function(a,b){for(var c,d,e=[],f=0,g=0;f<a.length&&g<b.length;)c=a[f],d=b[g],c<d?(e.push(c),f++):c==d?(e.push(c),f++,g++):(e.push(d),g++);for(;f<a.length;f++)e.push(a[f]);for(;g<b.length;g++)e.push(b[g]);return e},strcmp:function(a,b){for(var c=0,d=Math.max(a.length,b.length);c<d&&a.charAt(c)===b.charAt(c);++c);return c===d?0:a.charAt(c)>b.charAt(c)?-1:1},sNew:function(a){var b={};if(b.s=new Uint16Array(rCount),b.t=[],b.l=0,a){var c;for(c=0;c<rCount;c++)b.s[c]=c;for(c=0;c<recs.length;c++){var d=recs[c],e={i:d.i,n:d.n};b.t.push(e)}b.l=rCount}return b},s1stT:function(a,b){var c=a.t[b];return 0===c.n?-1:c.i},n2T:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.i<=a&&a<c.i+c.n)return b}},aInT:function(a,b){var c=prspdata.t[b];return c.def.a.findIndex(function(b){return b==a})!=-1},rByN:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.n>0&&c.i<=a&&a<c.i+c.n)return c.d[a-c.i]}return null},procAttTxt:function(a,b){var c=PData.aByID(a);switch(c.def.t){case"V":case"g":return b.join(", ");case"T":return b;case"N":return"?"===b?dlText.undef:b.toString();case"D":if("?"===b)return dlText.undef;var d="";return b.max?(b.min.f&&(d=dltextApprox+" "),d+=b.min.y.toString(),b.min.m&&(d+="-"+b.min.m.toString(),b.min.d&&(d+="-"+b.min.d.toString())),d+=dltextTo+" ","open"==b.max?d+=dltextNow:(b.max.f&&(d+=dltextApprox+" "),d+=b.max.y.toString(),b.max.m&&(d+="-"+b.max.m.toString(),b.max.d&&(d+="-"+b.max.d.toString())))):(d=b.min.f?dltextApprox+" ":"",d+=b.min.y.toString(),b.min.m&&(d+="-"+b.min.m.toString(),b.min.d&&(d+="-"+b.min.d.toString()))),d;case"L":case"X":return null!=c.def.d&""!==c.def.d?"number"==typeof b[0]?b.join(", "):b.map(function(a){return a.join(", ")}).join(c.def.d+" "):b.join(", ");case"I":return'<img src="'+b+'" alt="'+c.def.l+'"/>';case"l":return'<a href="'+b+'" target="_blank">(See Link)</a>';case"S":return'<a href="'+b+'" target="_blank">(SoundCloud)</a>';case"Y":return'<a href="https://www.youtube.com/watch?v='+b+'" target="_blank">(YouTube)</a>';case"x":return'<a href="'+b+'" target="_blank">(See Transcript File)</a>';case"t":return b;case"P":if(b.length>0){var e="";return b.forEach(function(a){var b=PData.rByID(a);b&&(e.length>0&&(e+=", "),e+='<a href="'+prspdata.site_url+"?p="+b.wp+'" target="_blank">'+b.l+"</a>")}),e}return null}return null},rAV:function(a,b,c){for(var d=0;d<recs.length;d++){var e=recs[d];if(e.n>0&&e.i<=a&&a<e.i+e.n){var f=e.d[a-e.i],g=f.a[b];return null==g||"undefined"==typeof g?null:c?g:PData.procAttTxt(b,g)}}return null},nByID:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.n>0)for(var d,e,f,g=0,h=c.n-1;g<=h;)if(d=g+h>>1,f=c.d[d],e=PData.strcmp(a,f.id),e<0)g=d+1;else{if(!(e>0))return c.i+d;h=d-1}}return null},rByID:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.n>0)for(var d,e,f,g=0,h=c.n-1;g<=h;)if(d=g+h>>1,f=c.d[d],e=PData.strcmp(a,f.id),e<0)g=d+1;else{if(!(e>0))return f;h=d-1}}return null},aByID:function(a){for(var b,c,d=0,e=prspdata.a.length-1;d<=e;)if(b=d+e>>1,c=PData.strcmp(a,prspdata.a[b].id),c<0)d=b+1;else{if(!(c>0))return prspdata.a[b];e=b-1}return null},aByN:function(a){return prspdata.a[a]},eTNum:function(){return prspdata.e.g.ts.length},eTByN:function(a){return prspdata.e.g.ts[a]},tByID:function(a){for(var b=0;b<prspdata.t.length;b++)if(a===prspdata.t[b].id)return prspdata.t[b].def},lRecs:function(a,b,c,d){function e(a){for(var d=0;d<h;d++)if(f=c[d],"number"==typeof f){if(g=b.l[f],g.l===a)return g}else{g=b.l[f[0]];var e=g.z[f[1]];if(e.l===a)return e.v&&""!==e.v?e:g}return null}var f,g,h=c.length;switch(b.def.t){case"V":if(d&&""!==b.def.d){var i,j=[];return a.forEach(function(a){i=e(a),null!=i&&j.push(i)}),j.length>0?j:null}if(""!==b.def.d){for(var i,k=0;k<a.length;k++)if(i=e(a[k]),null!=i)return i;return null}return e(a[0]);case"T":for(var i=0;i<h;i++)if(f=c[i],g=b.l[f],a.indexOf(g.d)!==-1)return g;return null;case"N":var i=0;if(c[0]===-1){if("?"===a)return"undefined"==typeof b.r.u?null:b.r.u;i=1}if("?"===a)return null;for(;i<h;i++)if(f=c[i],g=b.l[f],"undefined"!=typeof g.d.min){if(g.d.min<=a){if("undefined"==typeof g.d.max)return g;if(a<=g.d.max)return g}}else if(a<=g.d.max)return g;return null;case"D":var i=0;if(c[0]===-1){if("?"===a)return"undefined"==typeof b.r.u?null:b.r.u;i=1}if("?"===a)return null;for(;i<h;i++){if(f=c[i],g=b.l[f],"undefined"!=typeof g.d.max.y){if("undefined"!=typeof a.max&&"open"!==a.max){if(a.max.y<g.d.min.y)continue;if(a.max.y===g.d.min.y&&"undefined"!=typeof a.max.m&&"undefined"!=typeof g.d.min.m){if(a.max.m<g.d.min.m)continue;if(a.max.m===g.d.min.m&&a.max.d&&g.d.min.d&&a.max.d<g.d.min.d)continue}}if(a.min.y>=g.d.max.y)continue;if(a.min.y===g.d.max.y&&a.min.m&&g.d.max.m){if(a.min.m>g.d.max.m)continue;if(a.min.m===g.d.max.m&&a.min.d&&g.d.max.d&&a.min.d>g.d.max.d)continue}if(a.min.y<g.d.min.y)continue;if(a.min.y===g.d.min.y&&a.min.m&&g.d.max.m){if(a.min.m<g.d.min.m)continue;if(a.min.m===g.d.min.m&&a.min.d&&g.d.min.d&&a.min.d<g.d.min.d)continue}return g}if("undefined"!=typeof a.max){if("open"===a.max)return g;if(a.max.y<g.d.min.y)continue;if(a.max.y===g.d.min.y&&"undefined"!=typeof a.max.m&&"undefined"!=typeof g.d.min.m){if(a.max.m<g.d.min.m)continue;if(a.max.m===g.d.min.m&&"undefined"!=typeof a.max.d&&"undefined"!=typeof g.d.min.d&&a.max.d<g.d.min.d)continue}return g}if(!(a.min.y<g.d.min.y)){if(a.min.y===g.d.min.y&&"undefined"!=typeof a.min.m&&"undefined"!=typeof g.d.min.m){if(a.min.m<g.d.min.m)continue;if(a.min.m===g.d.min.m&&"undefined"!=typeof a.min.d&&"undefined"!=typeof g.d.min.d&&a.min.d<g.d.min.d)continue}return g}}}return null},lClr:function(a,b,c){var d;return(d=PData.lRecs(a,b,c,!1))?d.v:null},lenMnth:function(a,b){return 2===b&&a%4===0&&a%100!==0||a%400===0?29:mnthDays[b-1]},d3Nums:function(a,b,c,d){var e,f=86399900;return 0===a?(e=new Date(1,b-1,c),e.setUTCFullYear("0001")):a<0||a>99?e=new Date(a,b-1,c):(e=new Date(a,b-1,c),e.setUTCFullYear(("0000"+a).slice(-4))),d&&e.setTime(e.getTime()+f),e},dObj:function(a,b,c){var d;return"undefined"!=typeof a.m&&null!==a.m?(b=a.m,d="undefined"!=typeof a.d&&null!==a.d?a.d:PData.lenMnth(a.y,b)):d=PData.lenMnth(a.y,b),PData.d3Nums(a.y,b,d,c)},dStr:function(a,b){var c,d;if("open"===a)return TODAY;var e=1;"-"===a.charAt(0)&&(e=-1,a=a.substring(1));var f=a.split("-"),g=parseInt(f[0])*e;return f.length>1?(c=parseInt(f[1]),d=3==f.length?parseInt(f[2]):b?PData.lenMnth(g,c):1):b?(c=12,d=31):(c=1,d=1),PData.d3Nums(g,c,d,b)},cLNew:function(a,b,c){var d=[];switch(a.def.t){case"T":return a.l.forEach(function(c){(null==b||PData.lRecs(c.d,a,b,!1))&&d.push({l:c.l,x:c.d,c:c.v,i:[]})}),d;case"g":return d;case"V":return a.l.forEach(function(c){(null==b||PData.lRecs([c.l],a,b,!1))&&d.push({l:c.l,c:c.v,i:[]}),c.z.forEach(function(e){(null==b||PData.lRecs([e.l],a,b,!1))&&(""===e.v?d.push({l:e.l,c:c.v,i:[]}):d.push({l:e.l,c:e.v,i:[]}))})}),d;case"N":return c&&"undefined"!=typeof a.r.u&&(null==b||PData.lRecs("?",a,b,!1))&&d.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}),a.l.forEach(function(c){(null==b||PData.lRecs(c.d.min,a,b,!1))&&d.push({l:c.l,c:c.v,min:c.d.min,max:c.d.max,i:[]})}),d;case"D":c&&"undefined"!=typeof a.r.u&&(null==b||PData.lRecs("?",a,b,!1))&&d.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]});var e,f;return a.l.forEach(function(c){e=PData.dObj(c.d.min,1,!1),(null===b||PData.lRecs(e,a,b,!1))&&(f=null==c.d.max.y?TODAY:PData.dObj(c.d.max,12,!1),f.setTime(f.getTime()+10),d.push({l:c.l,c:c.v,min:e,max:f,i:[]}))}),d}},cRNew:function(a,b,c){function d(a,b,c,d){return"undefined"!=typeof d.m&&(b=d.m,"undefined"!=typeof d.d&&(c=d.d)),PData.d3Nums(a,b,c,!1)}function e(a){var b,c,d;return"undefined"==typeof a.y?TODAY:(b=a.y,"undefined"==typeof a.m?(c=12,d=31):(c=a.m,d="undefined"==typeof a.d?PData.lenMnth(b,c):a.d),PData.d3Nums(b,c,d,!1))}var f=[];switch(a.def.t){case"T":return a.l.forEach(function(a){b?f.push({l:a.l,x:a.d,c:a.v,i:[]}):f.push({l:a.l,x:a.d,c:a.v})}),f;case"g":return f;case"V":return a.l.forEach(function(a){b?f.push({l:a.l,c:a.v,i:[]}):f.push({l:a.l,c:a.v}),a.z.forEach(function(c){var d=""===c?a.v:c.v;b?f.push({l:c.l,c:d,i:[]}):f.push({l:c.l,c:d})})}),f;case"N":if("undefined"==typeof a.r.min||"undefined"==typeof a.r.max)return null;c&&"undefined"!=typeof a.r.u&&(b?f.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}):f.push({l:"?",c:a.r.u.v,min:"?",max:"?"}));var g,h,i,j=Math.pow(10,a.r.g),k=a.r.min,l=0;for(a.l.length>0&&(g=a.l[0]);k<=a.r.max;){for(;l<a.l.length&&"undefined"!=typeof g.d.max&&k>g.d.max;)g=a.l[++l];i=0==a.l.length||k<g.d.min?"#777777":l===a.l.length?"#777777":"undefined"==typeof g.d.max||k<=g.d.max?g.v:"#777777",h=k,k+=j,max=k-1,max>a.r.max&&(max=a.r.max);var m=h.toString();j>1&&m.length<4&&h!==max&&(m+="-"+max.toString()),b?f.push({l:m,c:i,min:h,max:max,i:[]}):f.push({l:m,c:i,min:h,max:max})}return f;case"D":var n=e(a.r.max),j=a.r.g,o=a.r.min.y,p=1,q=1;"undefined"!=typeof a.r.min.m&&(p=a.r.min.m,"undefined"!=typeof a.r.min.d&&(q=a.r.min.d));var g,r,s,t,u=PData.d3Nums(o,p,q,!1),l=0;for(a.l.length>0&&(g=a.l[0],r=d(g.d.min.y,1,1,g.d.min),s=e(g.d.max)),c&&"undefined"!=typeof a.r.u&&(b?f.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}):f.push({l:"?",c:a.r.u.v,min:"?",max:"?"}));u<=n;){var v={};b&&(v.i=[]);var w=0===o?"1":o.toString();switch(j){case"d":v.l=w+"-"+p.toString()+"-"+q.toString();break;case"m":v.l=w+"-"+p.toString();break;case"y":case"t":case"c":v.l=w}for(;l<a.l.length&&u>s;)g=a.l[++l],l<a.l.length&&(r=d(g.d.min.y,1,1,g.d.min),s=e(g.d.max));switch(0==a.l.length||u<r?v.c="#777777":l==a.l.length?v.c="#777777":u<=s?v.c=g.v:v.c="#777777",v.min=u,j){case"d":++q>PData.lenMnth(o,p)&&(q=1,++p>12&&(p=1,o++));break;case"m":++p>12&&(p=1,o++);break;case"y":o++;break;case"t":o+=10;break;case"c":o+=100}t=PData.d3Nums(o,p,q,!1),t>TODAY&&(t=TODAY),v.max=t,f.push(v),u=PData.d3Nums(o,p,q,!1)}return f}},cFill:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o=PData.aByID(b);null!=e?(g=e,f=e+1):(g=0,f=d.t.length),h=d.t[g],i=h.i;a:for(;i<d.l;){for(;0===h.n||h.i+h.n===i||!PData.aInT(b,g)||c&&!PData.aInT(c,g);){if(++g===f)break a;h=d.t[g],i=h.i}if(j=d.s[i],k=PData.rByN(j),l=k.a[b],"undefined"!=typeof l)switch(o.def.t){case"T":for(m=0;m<a.length;m++)if(n=a[m],l.indexOf(n.x)!==-1){n.i.push(j);break}break;case"g":l.forEach(function(b){for(m=0;m<a.length;m++)if(n=a[m],b===n.l){n.i.push(j);break}m===a.length&&a.push({l:b,i:[j],c:"#"+Math.floor(16777215*Math.random()).toString(16)})});break;case"V":l.forEach(function(b){for(m=0;m<a.length;m++)if(n=a[m],b==n.l){n.i.push(j);break}});break;case"N":if(m=0,n=a[0],"?"===n.min){if("?"===l){n.i.push(j);break}m=1}if("?"===l)break;for(;m<a.length&&(n=a[m],!(l<n.min));m++)if(n.min<=l&&l<=n.max){n.i.push(j);
break}break;case"D":if(m=0,n=a[0],"?"===n.min){if("?"===l){n.i.push(j);break}m=1}if("?"===l)break;for(var p=PData.dObj(l.min,1,!1);m<a.length&&(n=a[m],!(p<n.min));m++)if(n.min<=p&&p<n.max){n.i.push(j);break}}i++}"g"==o.def.t&&a.sort(function(a,b){return PData.strcmp(b.l,a.l)})},cSort:function(a,b,c){var d,e,f,g=b.id;a.forEach(function(a){if(d=PData.rByN(a),datum=d.a[g],"undefined"!=typeof datum)switch(b.def.t){case"T":for(e=0;e<c.length;e++)if(f=c[e],datum.indexOf(f.x)!==-1){f.i.push(a);break}break;case"g":datum.forEach(function(b){for(e=0;e<c.length;e++)if(f=c[e],b===f.l){f.i.push(a);break}e===c.length&&c.push({l:b,i:[a],c:"#777777"})});break;case"V":datum.forEach(function(b){for(e=0;e<c.length;e++)if(f=c[e],b===f.l){f.i.push(a);break}});break;case"N":if(e=0,f=c[0],"?"===f.min){if("?"===datum){f.i.push(a);break}e=1}if("?"===datum)break;for(;e<c.length&&(f=c[e],!(datum<f.min));e++)if(f.min<=datum&&datum<=f.max){f.i.push(a);break}break;case"D":if(e=0,f=c[0],"?"===f.min){if("?"===datum){f.i.push(a);break}e=1}if("?"===datum)break;var h=PData.dObj(datum.min,1,!1);for(e=0;e<c.length&&(f=c[e],!(h<f.min));e++)if(f.min<=h&&h<f.max){f.i.push(a);break}}}),"g"==b.def.t&&c.sort(function(a,b){return PData.strcmp(b.l,a.l)})},rTOrder:function(att,stream,tI){function vIden(a){return a}function vFirst(a){return a[0]}function vDate(a){if("?"===a)return"?";var b=1,c=1;return"undefined"!=typeof a.min.m&&(b=a.min.m,"undefined"!=typeof a.min.d&&(c=a.min.d)),PData.d3Nums(a.min.y,b,c,!1)}var eval,maxV;switch(att.def.t){case"T":eval=vIden,maxV="~";break;case"V":eval=vFirst,maxV="~";break;case"g":eval=vFirst,maxV="~";break;case"N":eval=vIden,maxV=att.r.max;break;case"D":eval=vDate,maxV=TODAY}for(var ord=[],tRec=stream.t[tI],ad=recs[tI],relI=0,absI,rec,v;relI<tRec.n;)absI=stream.s[tRec.i+relI++],rec=ad.d[absI-ad.i],v=rec.a[att.id],"undefined"==typeof v?ord.push({i:absI,v:maxV}):ord.push({i:absI,v:eval(v)});switch(att.def.t){case"T":case"g":case"V":ord.sort(function(a,b){return PData.strcmp(b.v,a.v)});break;case"D":case"N":ord.sort(function(a,b){return"?"===a.v?-1:"?"===b.v?1:a.v-b.v})}return ord},vByN:function(a){return prspdata.e.vf[a]},ready:function(){return loaded}}}();