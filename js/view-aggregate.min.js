/*! prospect 2016-09-16 */
var VizStackChart=function(a,b){PVizModel.call(this,a,b)};VizStackChart.prototype=Object.create(PVizModel.prototype),VizStackChart.prototype.constructor=VizStackChart,VizStackChart.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SLGND|V_FLAG_VSCRL|V_FLAG_HSCRL},VizStackChart.prototype.getFeatureAtts=function(a){return this.settings.sAtt},VizStackChart.prototype.setup=function(){var a=this.settings.h;this.xScale=d3.scaleLinear(),this.yScale=d3.scaleLinear().range([0,a-1]),this.rScale=d3.scaleBand(),this.xAxis=d3.axisTop(this.rScale),this.yAxis=d3.axisLeft(this.yScale),this.svg=d3.select(this.frameID).append("svg"),this.chart=this.svg.append("g"),this.chart.attr("class","chart").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")"),this.svg.append("g").attr("class","x axis").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")"),this.svg.append("g").attr("class","y axis").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")")},VizStackChart.prototype.render=function(a){function b(a,b){var d=c.bSel.length,e=_.sortedIndex(c.bSel,b);c.bSel[e]===b?(d3.select(this).classed("obj-sel",!1),c.bSel.splice(e,1),d>0&&0==c.bSel.length&&c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.bSel.splice(e,0,b),0==d&&c.bSel.length>0&&c.vFrame.selBtns(!0))}var c=this;this.bSel=[];var d=this.settings.oAtt,e=PData.aByID(d),f=this.settings.sAtt;"g"!==e.def.t?this.settings.gr?this.cats=PData.cRNew(e,!0,!0):this.cats=PData.cLNew(e,null,!0):this.cats=[],PData.cFill(this.cats,d,f,a,null);var g=0;this.cats.forEach(function(a){g=Math.max(g,a.l.length)}),g=Math.max(D3FG_BAR_WIDTH,8*g+4),this.colW=g;var h=this.cats.length*g,i=this.settings.h;this.xScale.domain([0,this.cats.length]).rangeRound([0,h]),this.rScale.domain(this.cats.map(function(a){return a.l})).range([0,h]),this.svg.attr("width",h+D3SC_MARGINS.left+D3SC_MARGINS.right).attr("height",i+D3SC_MARGINS.top+D3SC_MARGINS.bottom),this.svg.selectAll(".block").remove(),this.blocks=[];for(var j=PData.aByID(f),k=0,l=c.vFrame.getSelFeatAtts(0),m=PData.cLNew(j,l,!0),n=0;n<this.cats.length;n++){if(n>0)for(var o=0;o<m.length;o++)m[o].i=[];PData.cSort(c.cats[n].i,j,m);var p=0;m.forEach(function(a){a.i.length>0&&(c.blocks.push({x:n,c:a.c,y:p,h:a.i.length,a:a.i}),p+=a.i.length)}),k=Math.max(k,p)}c.yScale.domain([0,k]),c.svg.select(".x.axis").call(c.xAxis),c.svg.select(".y.axis").call(c.yAxis);var q=c.colW-7;this.svg.selectAll(".block").data(c.blocks).enter().append("rect").attr("class","block").attr("x",function(a){return D3SC_MARGINS.left+5+c.xScale(a.x)}).attr("y",function(a){return c.yScale(a.y)+D3SC_MARGINS.top}).attr("fill",function(a){return a.c}).attr("height",function(a){return Math.max(1,c.yScale(a.h)-1)}).attr("width",q).on("click",b)},VizStackChart.prototype.setSel=function(a){},VizStackChart.prototype.clearSel=function(){this.bSel.length>0&&(this.bSel=[],this.svg.selectAll(".block").classed("obj-sel",!1))},VizStackChart.prototype.getSel=function(){var a=this,b=[];return this.bSel.forEach(function(c){b=PData.union(b,a.blocks[c].a)}),b},VizStackChart.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizStackChart.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizStackChart.prototype.hint=function(){var a=dlText.xaxis+": ",b=PData.aByID(this.settings.oAtt);return a+=b.def.l+", "+dlText.yaxis+": ",b=PData.aByID(this.settings.sAtt),a+=b.def.l};var VizFlow=function(a,b){PVizModel.call(this,a,b)};VizFlow.prototype=Object.create(PVizModel.prototype),VizFlow.prototype.constructor=VizFlow,VizFlow.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL},VizFlow.prototype.setup=function(){var a=this;a.bH=Math.max(120,Math.ceil(this.settings.w/3));var b=40+(this.settings.fcts.length-1)*a.bH;this.svg=d3.select(this.frameID).append("svg").attr("width",this.settings.w+10).attr("height",b),this.barG=this.svg.append("g"),this.flowG=this.svg.append("g"),this.titleG=this.svg.append("g")},VizFlow.prototype.render=function(a){function b(a,b){var c=d.bSel.length,e=_.sortedIndex(d.bSel,b);d.bSel[e]===b?(d3.select(this).classed("obj-sel",!1),d.bSel.splice(e,1),c>0&&0===d.bSel.length&&0===d.fSel.length&&d.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),d.bSel.splice(e,0,b),0===c&&0===d.fSel.length&&d.bSel.length>0&&d.vFrame.selBtns(!0))}function c(a,b){var c=d.fSel.length,e=_.sortedIndex(d.fSel,b);d.fSel[e]===b?(d3.select(this).classed("obj-sel",!1),d.fSel.splice(e,1),c>0&&0===d.fSel.length&&0===d.bSel.length&&d.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),d.fSel.splice(e,0,b),0===c&&0===d.bSel.length&&d.fSel.length>0&&d.vFrame.selBtns(!0))}var d=this;this.bSel=[],this.fSel=[],this.barG.selectAll(".bar").remove(),this.flowG.selectAll(".flow").remove(),this.titleG.selectAll(".att-title").remove();var e=this.settings.w;d.bars=[],d.atts=[],d.settings.fcts.forEach(function(b,c){var f,g=PData.aByID(b);"g"!==g.def.t?(f=d.settings.gr?PData.cRNew(g,!0,!0):PData.cLNew(g,null,!0),PData.cFill(f,b,null,a,null)):(f=[],PData.cFill(f,b,null,a,null));var h=[],i=0;f.forEach(function(a){a.i.length>0&&(h.push(a),i+=a.i.length)});var j=0,k=31+c*d.bH;h.forEach(function(a){d.bars.push({x:5+j*e/i,w:a.i.length*e/i,y:k,c:a}),j+=a.i.length}),d.atts.push({l:g.def.l,c:h,t:i,y:k})});this.barG.selectAll(".bar").data(d.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w}).on("click",b).append("title").text(function(a){return a.c.l+" ("+a.c.i.length+")"});d.ints=[],d.atts.forEach(function(a,b){if(b!==d.atts.length-1){for(var c=d.atts[b+1],f=new Array(a.c.length),g=0;g<a.c.length;g++)f[g]=new Array(c.c.length);a.c.forEach(function(a,b){c.c.forEach(function(c,d){f[b][d]=PData.intersect(a.i,c.i)})});for(var h=new Array(c.c.length),i=0;i<c.c.length;i++){for(var j=0,g=0;g<a.c.length;g++)f[g][i].length>0&&j++;h[i]=j-1}for(var k=new Array(c.c.length),i=0;i<c.c.length;i++)k[i]=0;var l=0;a.c.forEach(function(b,g){for(var i=0,j=0;j<c.c.length;j++)f[g][j].length>0&&i++;i-=1;var m=b.i.length*e/a.t,n=0,o=0;c.c.forEach(function(j,p){var q=f[g][p];if(q.length>0){var r=q.length*e,s=r/a.t,t=r/c.t,u=j.i.length*e/c.t,v=i?(m-s)*n/i:0,w=h[p]?(u-t)*k[p]/h[p]:0;d.ints.push({i:q,c:b.c,l:b.l+" > "+j.l,x1:5+l*e/a.t+v,x2:5+o*e/c.t+w,w1:s,w2:t,y1:a.y+10,y2:c.y-1}),n++,k[p]++}o+=j.i.length}),l+=b.i.length})}});this.flowG.selectAll(".flow").data(d.ints).enter().append("path").attr("class","flow").attr("d",function(a){return"M "+a.x1+" "+a.y1+"  L "+(a.x1+a.w1)+" "+a.y1+" L "+(a.x2+a.w2)+" "+a.y2+" L "+a.x2+" "+a.y2+" L "+a.x1+" "+a.y1}).attr("fill",function(a){return a.c}).on("click",c).on("mouseover",function(){d3.select(this).classed("active",!0),this.parentElement.appendChild(this)}).on("mouseout",function(){d3.select(this).classed("active",!1)}).append("title").text(function(a){return a.l+" ("+a.i.length+")"}),this.titleG.selectAll(".att-title").data(d.atts).enter().append("text").attr("class","att-title").attr("x","5").attr("y",function(a){return a.y-8}).text(function(a){return a.l})},VizFlow.prototype.setSel=function(a){},VizFlow.prototype.clearSel=function(){this.bSel.length>0&&(this.bSel=[],this.svg.selectAll(".bar").classed("obj-sel",!1)),this.fSel.length>0&&(this.fSel=[],this.svg.selectAll(".flow").classed("obj-sel",!1))},VizFlow.prototype.getSel=function(){var a=this,b=[];return this.bSel.forEach(function(c){b=PData.union(b,a.bars[c].c.i)}),this.fSel.forEach(function(c){b=PData.union(b,a.ints[c].i)}),b};var VizBrowser=function(a,b){PVizModel.call(this,a,b),this.stream=null};VizBrowser.prototype=Object.create(PVizModel.prototype),VizBrowser.prototype.constructor=VizBrowser,VizBrowser.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL},VizBrowser.prototype.setup=function(){var a=250*this.settings.fcts.length;this.svg=d3.select(this.frameID).append("svg").attr("width",a),this.pState=null},VizBrowser.prototype.update=function(){var a=this,b=this.vFrame.getIndex();PState.set(PSTATE_UPDATE);var c,d=null,e=!1;this.fcts.forEach(function(a){a.s!=-1&&(e=!0,c=a.c[a.s].i,d=null==d?c:PData.intersect(d,c))}),e?this.vFrame.selBtns(d.length>0):(this.vFrame.selBtns(!1),d=this.stream.s),this.recSel=d,this.fcts.forEach(function(c){var e="#facet-"+b+"-"+c.i,f=a.svg.select(e).selectAll(".facet-val-bar");f.data(c.c).transition().attr("width",function(a){if(d.length>0){var b=PData.intersect(d,a.i);return 242*b.length/d.length}return 0})}),PState.set(PSTATE_READY)},VizBrowser.prototype.render=function(a){var b=this,c=this.vFrame.getIndex();this.recSel=[],this.stream=a,this.svg.selectAll(".facet-col").remove();var d=0;this.fcts=[],this.settings.fcts.forEach(function(c,e){var f,g=PData.aByID(c);"g"===g.def.t?(f=[],PData.cFill(f,c,null,a,null)):(f=b.settings.gr?PData.cRNew(g,!0,!0):PData.cLNew(g,null,!0),PData.cFill(f,c,null,a,null));var h=[],i=0;f.forEach(function(a){a.i.length>0&&(a.n=i++,h.push(a))}),b.fcts.push({c:h,x:250*e,i:e,l:g.def.l,n:g.id,s:-1}),d=Math.max(d,27+22*(h.length+1))}),b.svg.attr("height",d);var e=b.svg.selectAll(".facet-col").data(b.fcts).enter().append("g").attr("transform",function(a){return"translate("+a.x+", 0)"}).attr("class","facet-col").attr("id",function(a){return"facet-"+c+"-"+a.i});e.append("rect").attr("class","facet-lbl").attr("height",24).attr("width",242),e.append("text").attr("class","facet-lbl-txt").attr("x",3).attr("y",18).attr("text-anchor","start").text(function(a){return a.l});var f;b.fcts.forEach(function(d){var e,g="#facet-"+c+"-"+d.i,h=null;null!=b.pState&&b.pState.p.find(function(a){return d.n===a.f&&((e=d.c.findIndex(function(b){return a.v===b.l}))!==-1&&(d.s=e,h=a),!0)});var i=[1];f=b.svg.select(g).selectAll(".facet-reset").data(i).enter().append("g").attr("transform","translate(0,26)").attr("class",function(a){return h?"facet-reset":"facet-reset inactive"}).attr("height",19).on("click",function(a){var c=this;if(d.s!==-1){d.s=-1;b.svg.select(g).selectAll(".facet-val").classed("inactive",!1);d3.select(c).classed("inactive",!0),b.update()}}),f.append("rect").attr("class","facet-reset-btn").attr("height",19).attr("width",242),f.append("text").attr("class","facet-reset-txt").attr("x",3).attr("y",13).text(dlText.reset),f=b.svg.select(g).selectAll(".facet-val").data(d.c).enter().append("g").attr("transform",function(a,b){return"translate(0,"+(27+22*(b+1))+")"}).attr("class",function(a,b){return h?b===e?"facet-val":"facet-val inactive":"facet-val"}).on("click",function(a,c){var e=b.svg.select(g).select(".facet-reset");if(d.s!==c){d.s=c;b.svg.select(g).selectAll(".facet-val").classed("inactive",function(a){return c!==a.n});e.classed("inactive",!1)}else b.svg.select(g).selectAll(".facet-val").classed("inactive",!1),d.s=-1,e.classed("inactive",!0);b.update()}),f.append("rect").attr("class","facet-val-btn").attr("height",21).attr("width",242),f.append("rect").attr("class","facet-val-bar").attr("height",21).attr("width",function(b){return a.l>0?242*b.i.length/a.l:0}),f.append("text").attr("class","facet-val-txt").attr("x",3).attr("y",16).text(function(a){return a.l}),f.append("text").attr("class","facet-val-num").attr("x",239).attr("y",16).text(function(a){return a.i.length})}),null!=this.pState&&(this.update(),this.pState=null)},VizBrowser.prototype.setSel=function(a){},VizBrowser.prototype.clearSel=function(){var a=this,b=this.vFrame.getIndex();this.fcts.forEach(function(c){c.s=-1;var d="#facet-"+b+"-"+c.i;a.svg.select(d).select(".facet-reset").classed("inactive",!0),a.svg.select(d).selectAll(".facet-val").classed("inactive",!1)}),this.update()},VizBrowser.prototype.getSel=function(){return this.recSel},VizBrowser.prototype.getState=function(){var a=[];return this.fcts.forEach(function(b){if(b.s!==-1){var c=b.c[b.s];a.push({f:b.n,v:c.l})}}),{p:a}},VizBrowser.prototype.setState=function(a){this.pState=a};var VizMBMap=function(a,b){PVizModel.call(this,a,b)};VizMBMap.prototype=Object.create(PVizModel.prototype),VizMBMap.prototype.constructor=VizMBMap,VizMBMap.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL},VizMBMap.prototype.setup=function(){function a(){b.bkSel&&(b.bkSel.s=!1),b.clearSel()}var b=this,c=+this.settings.h,d=+this.settings.w;this.tm=d3.treemap().size([d,c]).paddingTop(14).paddingRight(3).paddingBottom(3).paddingLeft(3).round(!0),this.svg=d3.select(this.frameID).append("svg").attr("width",d+10).attr("height",c+40+30*this.settings.fcts.length),this.infoG=this.svg.append("g"),this.infoG.attr("transform","translate(5,"+(3+c)+")"),this.attsG=this.svg.append("g"),this.attsG.attr("transform","translate(5,"+(40+c)+")"),this.infoG.append("rect").attr("class","mbm-reset").attr("x","0").attr("y","8").attr("width","60").attr("height","20").attr("rx","4").attr("ry","4").on("click",a),this.infoG.append("text").attr("class","mbm-reset-text").attr("x","30").attr("y","23").text(dlText.reset).on("click",a)},VizMBMap.prototype.resetAttBars=function(){this.attsG.selectAll(".bar").transition().attr("x",function(a){return a.x0}).attr("width",function(a){return a.w0})},VizMBMap.prototype.refreshTitles=function(){this.svg.selectAll(".mbm-title").attr("class",function(a){return a.data.s?"mbm-title obj-sel":"mbm-title"})},VizMBMap.prototype.renderTree=function(a){function b(){var a=0,b=e.settings.w,c=null!==e.sbkSel?e.sbkSel.data.i:e.bkSel.data.i;PState.set(PSTATE_UPDATE),e.fcts.forEach(function(d,f){var g=[],h=0;d.c.forEach(function(a){var b=PData.intersect(c,a.i);g.push(b),h+=b.length});var i,j=0;g.forEach(function(c){i=e.bars[a++],i.x=h?j*b/h:0,i.w=h?c.length*b/h:0,j+=c.length})}),e.attsG.selectAll(".bar").transition().attr("x",function(a){return a.x}).attr("width",function(a){return a.w}),PState.set(PSTATE_READY)}function c(a){e.bkSel===a?e.clearSel():(e.bkSel&&(e.bkSel.data.s=!1),e.sbkSel&&(e.sbkSel.data.s=!1),e.svg.selectAll(".mbm-2").classed("obj-sel",!1),a.data.s=!0,e.bkSel=a,e.sbkSel=null,e.refreshTitles(),e.infoG.select(".mbm-select").remove(),e.infoG.append("text").attr("class","mbm-select").attr("x","70").attr("y","23").text(a.data.l+" ("+a.data.i.length+")"),b(),e.vFrame.selBtns(!0))}function d(a){2===a.depth&&(e.sbkSel===a?e.clearSel():(e.bkSel&&(e.bkSel.data.s=!1),e.sbkSel&&(e.sbkSel.data.s=!1),e.svg.selectAll(".mbm-2").classed("obj-sel",!1),e.sbkSel=a,d3.select(this).classed("obj-sel",!0),e.infoG.select(".mbm-select").remove(),e.infoG.append("text").attr("class","mbm-select").attr("x","70").attr("y","23").text(a.data.l),a.parent.data.s=!0,e.bkSel=a.parent,e.refreshTitles(),b(),e.vFrame.selBtns(!0)))}var e=this;this.svg.selectAll(".mbm").remove();var f=this.treemaps[a],g=f.descendants().filter(function(a){return 1===a.depth}),h=this.svg.selectAll(".mbm-1").data(g).enter().append("g").attr("class","mbm mbm-1").attr("transform",function(a){return"translate("+a.x0+","+a.y0+")"});h.append("rect").attr("width",function(a){return a.x1-a.x0}).attr("height",function(a){return a.y1-a.y0}).attr("rx","3").attr("ry","3").style("fill","#888888").on("click",d),h.append("text").attr("class","mbm-title").attr("x","3").attr("y","11").text(function(a){return a.data.l}).on("click",c),g=f.leaves(),h=this.svg.selectAll(".mbm-2").data(g).enter().append("rect").attr("class","mbm mbm-2").attr("x",function(a){return a.x0}).attr("y",function(a){return a.y0}).attr("width",function(a){return a.x1-a.x0}).attr("height",function(a){return a.y1-a.y0}).attr("rx","3").attr("ry","3").style("fill",function(a){return a.data.c}).on("click",d).append("title").text(function(a){return a.data.l})},VizMBMap.prototype.render=function(a){function b(a,b){c.attSel!=b&&(PState.set(PSTATE_UPDATE),c.attsG.selectAll(".mbm-att-title").classed("obj-sel",!1),c.clearSel(),c.resetAttBars(),c.renderTree(b),d3.select(this).classed("obj-sel",!0),c.attSel=b,PState.set(PSTATE_READY))}var c=this;this.bkSel=null,this.sbkSel=null,this.attSel=0;var d=this.settings.w;this.attsG.selectAll(".bar").remove(),this.attsG.selectAll(".mbm-att-title").remove(),this.infoG.select(".mbm-select").remove(),this.fcts=[],this.bars=[],this.settings.fcts.forEach(function(b,e){var f,g=PData.aByID(b),h=30*e;"g"!==g.def.t?(f=c.settings.gr?PData.cRNew(g,!0,!0):PData.cLNew(g,null,!0),PData.cFill(f,b,null,a,null)):(f=[],PData.cFill(f,b,null,a,null));var i=[],j=0;f.forEach(function(a){a.i.length>0&&(i.push(a),j+=a.i.length)});var k=0;i.forEach(function(a){c.bars.push({x0:k*d/j,w0:a.i.length*d/j,x:0,w:0,y:h+18,c:a}),k+=a.i.length}),c.fcts.push({i:e,l:g.def.l,y:h+14,c:i})});var e,f=(this.attsG.selectAll(".mbm-att-title").data(c.fcts).enter().append("text").attr("class",function(a,b){return 0===b?"mbm-att-title obj-sel":"mbm-att-title"}).attr("x","0").attr("y",function(a){return a.y}).text(function(a){return a.l}).on("click",b),this.attsG.selectAll(".bar").data(c.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x0}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w0}).append("title").text(function(a){return a.c.l}),this.settings.p),g=PData.aByID(f);"g"!==g.def.t?(e=c.settings.gr?PData.cRNew(g,!0,!0):PData.cLNew(g,null,!0),PData.cFill(e,f,null,a,null)):(e=[],PData.cFill(e,f,null,a,null));var h=this.vFrame.getIndex();c.trees=[],c.fcts.forEach(function(a,b){var d={z:[],id:h+"."+b,f:!1};e.forEach(function(c,e){if(c.i.length>0){var f=[],g={i:c.i,l:c.l,s:!1,z:f,id:h+"."+b+"."+e,f:!1};a.c.forEach(function(a,d){var g=[];g=PData.intersect(c.i,a.i),g.length>0&&f.push({i:g,c:a.c,l:c.l+" + "+a.l+" ("+g.length+")",id:h+"."+b+"."+e+"."+d,f:!0})}),d.z.push(g)}}),c.trees.push(d)}),c.treemaps=[],c.trees.forEach(function(a){var b=d3.hierarchy(a,function(a){return"object"==typeof a.z?a.z:null}),d=b.sum(function(a){return a.f?a.i.length:0}).sort(function(a,b){return b.height-a.height||b.value-a.value});c.tm(d),c.treemaps.push(d)}),c.renderTree(0)},VizMBMap.prototype.setSel=function(a){},VizMBMap.prototype.clearSel=function(){this.bkSel&&(this.bkSel.data.s=!1),this.infoG.select(".mbm-select").remove(),this.bkSel=null,this.sbkSel=null,this.svg.selectAll(".mbm").classed("obj-sel",!1),this.svg.selectAll(".mbm-title").classed("obj-sel",!1),this.resetAttBars(),this.vFrame.selBtns(!1)},VizMBMap.prototype.getSel=function(){return null!==this.sbkSel?this.sbkSel.data.i:null!==this.bkSel?this.bkSel.data.i:[]},VizMBMap.prototype.hint=function(){var a=PData.aByID(this.settings.p);return dlText.grpblks+" "+a.def.l};
